<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cinerave - Premium Experience</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -ntainer.appendChild(div);
        }

        window.sendMessage = async () => {
            if (!currentUser) {
                showToast("Faça login para participar.");
                return;
            }
            const input = ui.cinema.chatInput;
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            
            try {
                await addDoc(collection(db, "artifacts", APP_ID_PATH, "chat"), {
                    text: text,
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    avatar: currentUser.photoURL,
                    timestamp: Date.now()
                });
            } catch (e) {
                console.error(e);
                showToast("Erro ao enviar mensagem.");
            }
        };
        
        ui.cinema.chatInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        function scrollToBottom() {
            const el = ui.cinema.chatContainer;
            el.scrollTop = el.scrollHeight;
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            });
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch("https://api.imgbb.com/1/upload?key=7ce206cded5b366ff1c2d1292e55b1c4", { method: "POST", body: formData });
                const data = await response.json();
                return data.success ? data.data.url : "https://i.ibb.co/5k03gX0/default-avatar.png";
            } catch (error) { return "https://i.ibb.co/5k03gX0/default-avatar.png"; }
        }

        onAuthStateChanged(auth, (user) => {
            ui.auth.loading.classList.add('hidden');
            currentUser = user;

            if (user) {
                ui.auth.formsContainer.classList.add('hidden');
                ui.auth.profileContainer.classList.remove('hidden');
                ui.auth.profileContainer.classList.add('flex');
                ui.profile.name.innerText = user.displayName || "Usuário";
                ui.profile.img.src = user.photoURL || "https://ui-avatars.com/api/?background=random&color=fff&name=User";
                ui.profile.uid.innerText = user.uid;
                
                ui.cinema.chatInput.placeholder = "Digite sua mensagem...";
                ui.cinema.chatInput.disabled = false;
            } else {
                ui.auth.profileContainer.classList.add('hidden');
                ui.auth.formsContainer.classList.remove('hidden');
                ui.auth.formsContainer.classList.add('flex');
                window.toggleAuthMode('login');

                ui.cinema.chatInput.placeholder = "Faça login para comentar";
                ui.cinema.chatInput.disabled = true;
            }
        });

        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = ui.inputs.loginEmail.value, pass = ui.inputs.loginPass.value;
            if(!email || !pass) return showToast("Preencha tudo");
            try { await signInWithEmailAndPassword(auth, email, pass); showToast("Bem-vindo!"); } 
            catch { showToast("Erro no login"); }
        });

        document.getElementById('btn-register').addEventListener('click', async () => {
            const name = ui.inputs.regName.value, email = ui.inputs.regEmail.value, pass = ui.inputs.regPass.value, file = ui.inputs.regFile.files[0];
            if(!name || !email || !pass) return showToast("Preencha tudo");
            try {
                showToast("Criando conta...");
                let photo = "https://ui-avatars.com/api/?background=random&color=fff&name="+name;
                if(file) photo = await uploadToImgBB(file);
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(cred.user, { displayName: name, photoURL: photo });
                showToast("Conta criada!");
            } catch { showToast("Erro no cadastro"); }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        lucide.createIcons();
        initCinemaSync();
        initChat();

    </script>
</body>
</html>
