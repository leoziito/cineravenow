<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CineRave - Watch Together</title>
    
    <ementById('detail-year').textContent = item.year;
            document.getElementById('detail-genre').textContent = item.genres;
            document.getElementById('detail-overview').textContent = item.overview || "Sinopse n칚o dispon칤vel.";
            
            const synopsisEl = document.getElementById('detail-overview');
            const readMoreBtn = document.getElementById('detail-read-more');
            synopsisEl.classList.remove('expanded');
            if (item.overview && item.overview.length > 150) { readMoreBtn.classList.remove('hidden'); readMoreBtn.textContent = 'Ver mais'; } else { readMoreBtn.classList.add('hidden'); }

            const castContainer = document.getElementById('detail-cast');
            castContainer.innerHTML = '';
            if (item.actors) {
                const actors = item.actors.split(', ');
                const actorPromises = actors.map(async (actor) => {
                    let imgUrl = `https://ui-avatars.com/api/?name=${actor}&background=333&color=fff`;
                    try {
                        const searchRes = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(actor)}`);
                        const searchData = await searchRes.json();
                        if (searchData.results && searchData.results.length > 0 && searchData.results[0].profile_path) {
                            imgUrl = `https://image.tmdb.org/t/p/w185${searchData.results[0].profile_path}`;
                        }
                    } catch(e) {}
                    return { name: actor, img: imgUrl };
                });
                Promise.all(actorPromises).then(results => {
                    castContainer.innerHTML = results.map(a => `<div class="flex-shrink-0 flex flex-col items-center w-16"><div class="w-14 h-14 rounded-full bg-dark-card border border-white/10 overflow-hidden mb-1 shadow-md"><img src="${a.img}" class="w-full h-full object-cover"></div><span class="text-[9px] text-gray-400 text-center leading-tight line-clamp-2">${a.name}</span></div>`).join('');
                });
            }

            if (item.type === 'tv') {
                document.getElementById('btn-watch-movie').classList.add('hidden');
                document.getElementById('series-container').classList.remove('hidden');
                const seasonSelect = document.getElementById('season-selector');
                seasonSelect.innerHTML = '';
                if(item.seasons && item.seasons.length > 0) {
                    item.seasons.forEach(s => { const opt = document.createElement('option'); opt.value = s.season; opt.text = `Temporada ${s.season}`; opt.className = 'text-black'; seasonSelect.add(opt); });
                    renderSeriesEpisodes(item.tmdbId, item.seasons[0].season, item.seasons);
                } else { seasonSelect.innerHTML = '<option>Temporada 1</option>'; }
            } else {
                document.getElementById('btn-watch-movie').classList.remove('hidden');
                document.getElementById('series-container').classList.add('hidden');
            }

            if (item.tmdbId) {
                fetch(`https://api.themoviedb.org/3/${item.type}/${item.tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR&append_to_response=release_dates,content_ratings`)
                .then(r => r.json())
                .then(data => {
                    const durEl = document.getElementById('detail-duration');
                    if (data.runtime) { durEl.textContent = `${data.runtime} min`; durEl.classList.remove('hidden'); }
                    else if (data.episode_run_time && data.episode_run_time.length > 0) { durEl.textContent = `${data.episode_run_time[0]} min`; durEl.classList.remove('hidden'); }
                    
                    let rating = null;
                    if(item.type === 'movie' && data.release_dates) { const br = data.release_dates.results.find(r => r.iso_3166_1 === 'BR'); if(br) rating = br.release_dates[0].certification; }
                    else if (item.type === 'tv' && data.content_ratings) { const br = data.content_ratings.results.find(r => r.iso_3166_1 === 'BR'); if(br) rating = br.rating; }
                    
                    if(rating) { const ageEl = document.getElementById('detail-age'); ageEl.textContent = rating === 'L' ? 'L' : `${rating}`; ageEl.style.backgroundColor = rating === 'L' ? '#10b981' : rating >= 18 ? '#000' : '#ef4444'; ageEl.classList.remove('hidden'); }
                });
            }

            updateVoteUI(id, 'content');
            document.getElementById('details-page').classList.remove('hidden');
            toggleBodyScroll(true);
        };

        window.renderSeriesEpisodes = async (tmdbId, seasonNum, firestoreSeasons) => {
            const list = document.getElementById('episodes-list');
            list.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-white"></i></div>';
            try {
                const res = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${seasonNum}?api_key=${TMDB_API_KEY}&language=pt-BR`);
                const tmdbData = await res.json();
                const fsSeason = firestoreSeasons.find(s => s.season == seasonNum);
                const fsEpisodes = fsSeason ? fsSeason.episodes : [];
                list.innerHTML = '';
                if (tmdbData.episodes) {
                    tmdbData.episodes.forEach((ep, idx) => {
                        const linkData = fsEpisodes.find(f => f.ep == ep.episode_number);
                        const hasLink = linkData && (linkData.link || linkData.rave || linkData.embed);
                        if (!hasLink) return;

                        const img = ep.still_path ? `https://image.tmdb.org/t/p/w300${ep.still_path}` : 'https://placehold.co/300x170/222/999?text=No+Img';
                        const runtime = ep.runtime ? `${ep.runtime}m` : '';
                        const div = document.createElement('div');
                        div.className = `episode-card group cursor-pointer hover:bg-white/5`;
                        
                        div.onclick = () => {
                            window.currentPlayingEpisode = { 
                                showId: window.currentDetailItem.id, 
                                seasonIndex: firestoreSeasons.findIndex(s => s.season == seasonNum), 
                                episodeIndex: fsEpisodes.findIndex(f => f.ep == ep.episode_number) 
                            };
                            openServerModal(linkData, `S${seasonNum}:E${ep.episode_number} - ${ep.name}`, linkData.schedule);
                        };
                        div.innerHTML = `<div class="relative episode-thumb"><img src="${img}" class="w-full h-full object-cover rounded"><div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-play text-white"></i></div></div><div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-white truncate">${ep.episode_number}. ${ep.name}</h4><p class="text-[10px] text-gray-400 line-clamp-2">${ep.overview || ''}</p><span class="text-[10px] text-gray-500 font-mono mt-1 block">${runtime}</span></div>`;
                        list.appendChild(div);
                    });
                }
            } catch(e) { list.innerHTML = '<div class="text-center text-red-500 text-xs">Erro ao carregar epis칩dios.</div>'; }
        };

        window.changeSeason = (val) => { if(window.currentDetailItem) renderSeriesEpisodes(window.currentDetailItem.tmdbId, val, window.currentDetailItem.seasons); };
        window.closeDetails = () => { 
            document.getElementById('details-page').classList.add('hidden'); 
            toggleBodyScroll(false);
            if(window.currentContentUnsub) { window.currentContentUnsub(); window.currentContentUnsub = null; }
        };
        window.toggleSynopsis = () => { const el = document.getElementById('detail-overview'); const btn = document.getElementById('detail-read-more'); el.classList.toggle('expanded'); btn.textContent = el.classList.contains('expanded') ? 'Ver menos' : 'Ver mais'; };
        
        window.shareContent = () => { 
            if(!window.currentDetailItem) return;
            const contentId = window.currentDetailItem.id;
            const baseUrl = window.location.origin + window.location.pathname;
            const fullUrl = `${baseUrl}?content=${contentId}`;
            const text = `Assista *${window.currentDetailItem.title}* no CineRave! 游쯒nAcesse agora: ${fullUrl}`;
            navigator.clipboard.writeText(text).then(() => window.showToast("Link copiado! Compartilhe.", "success"));
        };
        
        window.playContent = () => { if(window.currentDetailItem) openServerModal(window.currentDetailItem.links, window.currentDetailItem.title, window.currentDetailItem.scheduleGeneral); };
        window.openServerModalForMovie = () => {
            window.currentPlayingEpisode = null;
            openServerModal(window.currentDetailItem.links, window.currentDetailItem.title, window.currentDetailItem.scheduleGeneral);
        };

        window.openServerModal = (linksObj, titleContext, scheduleTime) => {
            const modal = document.getElementById('server-modal');
            const list = document.getElementById('server-list');
            const lockScreen = document.getElementById('lock-screen');
            const lockDate = document.getElementById('lock-date');
            const premiumHint = document.getElementById('lock-premium-hint');
            const isPremium = window.checkUserPremium();

            modal.classList.add('active');
            toggleBodyScroll(true);
            window.currentPlayTitle = titleContext || "Conte칰do"; 

            if (checkSchedule(scheduleTime)) {
                if (isPremium) {
                    lockScreen.classList.add('hidden');
                    list.classList.remove('opacity-10', 'pointer-events-none');
                } else {
                    lockScreen.classList.remove('hidden');
                    lockDate.textContent = new Date(scheduleTime).toLocaleString();
                    premiumHint.classList.remove('hidden');
                    list.classList.add('opacity-10', 'pointer-events-none');
                    return; 
                }
            } else {
                lockScreen.classList.add('hidden');
                premiumHint.classList.add('hidden');
                list.classList.remove('opacity-10', 'pointer-events-none');
            }

            if (!linksObj) return window.showToast("Nenhum link dispon칤vel.", "error");
            
            list.innerHTML = '';

            const getUrl = (type) => {
                if (type === 'principal') return linksObj.main || linksObj.link || (typeof linksObj === 'string' ? linksObj : null);
                if (type === 'rave') return linksObj.rave;
                if (type === 'drive') return linksObj.drive;
                if (type === 'telegram') return linksObj.telegram;
                if (linksObj.extras && Array.isArray(linksObj.extras)) {
                    const found = linksObj.extras.find(e => e.type === type);
                    if (found) return found.url;
                }
                return null;
            }

            const servers = [
                { id: 'principal', name: 'Principal', icon: '<i class="fa-solid fa-play text-white text-xl"></i>', url: getUrl('principal'), action: 'player', restricted: false },
                { id: 'rave', name: 'Rave', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTTiX0As5qFGbYQh14TWxXZC16AQdNEnq29fnJnKUPALVC5HagwfSMwkQI&s=10', url: getUrl('rave'), action: 'link', restricted: false },
                { id: 'drive', name: 'Drive (Premium)', img: 'https://1000logos.net/wp-content/uploads/2021/04/Google-Drive-logo.png', url: getUrl('drive'), action: 'link', restricted: true },
                { id: 'telegram', name: 'Telegram (Premium)', icon: '<i class="fa-brands fa-telegram text-blue-400 text-xl"></i>', url: getUrl('telegram'), action: 'link', restricted: true },
                { id: 'watchparty', name: 'Watch Party', icon: '<i class="fa-solid fa-film text-yellow-500 text-xl"></i>', url: null, label: 'Em Breve', restricted: false }
            ];

            servers.forEach(s => {
                const urlExists = !!s.url;
                let disabledClass = '';
                let clickAction = '';
                let subtext = '';
                let subClass = '';

                if (s.restricted && !isPremium) {
                    disabledClass = 'disabled';
                    subtext = 'Exclusivo Premium';
                    subClass = 'text-brand-premium font-bold';
                    clickAction = `onclick="window.showToast('Recurso Exclusivo Premium!', 'error'); window.switchTab('premium'); document.getElementById('server-modal').classList.remove('active'); toggleBodyScroll(false);"`;
                } else if (!urlExists) {
                    disabledClass = s.id === 'watchparty' ? '' : 'disabled';
                    subtext = s.id === 'watchparty' ? 'Em Breve' : 'Indispon칤vel';
                    subClass = 'text-gray-500';
                    clickAction = '';
                } else {
                    subtext = 'Dispon칤vel';
                    subClass = 'text-green-400';
                    if (s.action === 'player') clickAction = `onclick="openPlayer('${s.url}')"`;
                    else clickAction = `onclick="window.open('${s.url}', '_blank')"`;
                }

                let visual = s.img ? `<img src="${s.img}" class="server-logo">` : s.icon;
                list.innerHTML += `<div class="server-option ${disabledClass}" ${clickAction}><div class="flex items-center gap-3"><div class="w-8 flex justify-center">${visual}</div><div><p class="text-sm font-bold text-white">${s.name}</p><p class="text-[10px] ${subClass}">${subtext}</p></div></div><i class="fa-solid fa-chevron-right text-gray-600 text-xs"></i></div>`;
            });
            
            if (window.currentDetailItem && window.currentDetailItem.quality && !isPremium) {
                const q = window.currentDetailItem.quality;
                if (q.includes('4K') || q.includes('HDCAM')) {
                   const warn = document.createElement('div');
                   warn.className = 'mt-4 p-2 bg-red-900/20 border border-red-900/50 rounded text-center';
                   warn.innerHTML = '<p class="text-[10px] text-red-400 font-bold uppercase"><i class="fa-solid fa-triangle-exclamation"></i> Conte칰do de Alta Qualidade (4K) pode ser restrito para usu치rios Free.</p>';
                   list.appendChild(warn);
                }
            }
        };

        window.openPlayer = (url) => {
            if(!url) return;
            const video = document.getElementById('main-video');
            video.src = url;
            document.getElementById('player-title').textContent = window.currentPlayTitle || "Reproduzindo";
            document.getElementById('player-page').classList.add('active');
            document.getElementById('server-modal').classList.remove('active');
            toggleBodyScroll(true);

            // Hide Next Episode button for Live Channels
            if (window.currentDetailItem && window.currentDetailItem.isChannel) {
                document.getElementById('btn-next-ep').style.display = 'none';
            } else {
                const nextBtn = document.getElementById('btn-next-ep');
                if (window.currentPlayingEpisode) {
                    nextBtn.style.display = 'flex';
                } else {
                    nextBtn.style.display = 'none';
                }
            }

            // Also attach listener for player view
            if(window.currentDetailItem) {
                if(window.currentContentUnsub) window.currentContentUnsub();
                
                // Determine collection based on item type
                const collectionName = window.currentDetailItem.isChannel ? 'channels' : 'content';
                
                window.currentContentUnsub = onSnapshot(doc(db, collectionName, window.currentDetailItem.id), (docSnap) => {
                    if(docSnap.exists()) {
                        const d = docSnap.data();
                        document.getElementById('count-like').textContent = d.likesCount || 0;
                        document.getElementById('count-dislike').textContent = d.dislikesCount || 0;
                    }
                });
            }
            updateVoteUI(null, window.currentDetailItem?.isChannel ? 'channels' : 'content');
            video.play();
        };

        window.playNextEpisode = () => {
            if (!window.currentPlayingEpisode || !window.currentDetailItem) return;
            const { seasonIndex, episodeIndex } = window.currentPlayingEpisode;
            const seasons = window.currentDetailItem.seasons;
            
            let nextEpIdx = episodeIndex + 1;
            let nextSeasonIdx = seasonIndex;

            if (nextEpIdx >= seasons[seasonIndex].episodes.length) {
                nextSeasonIdx++;
                nextEpIdx = 0;
            }

            if (nextSeasonIdx < seasons.length && nextEpIdx < seasons[nextSeasonIdx].episodes.length) {
                const nextSeason = seasons[nextSeasonIdx];
                const nextEp = nextSeason.episodes[nextEpIdx];
                window.currentPlayingEpisode = { showId: window.currentDetailItem.id, seasonIndex: nextSeasonIdx, episodeIndex: nextEpIdx };
                openServerModal(nextEp, `S${nextSeason.season}:E${nextEp.ep} - ${nextEp.name || ''}`, nextEp.schedule);
            } else {
                window.showToast("N칚o h치 mais epis칩dios dispon칤veis.", "info");
            }
        };

        window.closePlayer = () => {
            const video = document.getElementById('main-video');
            video.pause();
            video.src = "";
            document.getElementById('player-page').classList.remove('active');
            toggleBodyScroll(false);
            if(window.currentContentUnsub) { window.currentContentUnsub(); window.currentContentUnsub = null; }
        };

        window.togglePlay = () => {
            const video = document.getElementById('main-video');
            const icon = document.getElementById('play-icon');
            if (video.paused) { video.play(); icon.className = "fa-solid fa-pause text-xl"; } 
            else { video.pause(); icon.className = "fa-solid fa-play text-xl"; }
        };

        window.seekVideo = () => {
            const video = document.getElementById('main-video');
            const slider = document.getElementById('video-progress');
            const time = (slider.value / 100) * video.duration;
            video.currentTime = time;
        };

        window.toggleFullscreen = () => {
            const elem = document.getElementById("player-page");
            if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => {}); } 
            else { document.exitFullscreen(); }
        };

        document.getElementById('main-video').addEventListener('timeupdate', () => {
            const video = document.getElementById('main-video');
            const slider = document.getElementById('video-progress');
            const timeLabel = document.getElementById('video-time');
            const val = (video.currentTime / video.duration) * 100;
            slider.value = val || 0;
            const format = (s) => { const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec < 10 ? '0'+sec : sec}`; };
            timeLabel.textContent = `${format(video.currentTime)} / ${format(video.duration || 0)}`;
        });

        window.submitVote = async (type) => {
            if (!window.currentUserUid) return window.openAuthModal();
            if (!window.currentDetailItem) return;
            
            const contentId = window.currentDetailItem.id;
            // Detect if it's a channel or regular content
            const collectionName = window.currentDetailItem.isChannel ? 'channels' : 'content';
            
            const contentRef = doc(db, collectionName, contentId);
            const userVoteRef = doc(db, `users/${window.currentUserUid}/votes/${contentId}`);
            try {
                const userVoteSnap = await getDoc(userVoteRef);
                const currentVote = userVoteSnap.exists() ? userVoteSnap.data().type : null;
                
                if (currentVote === type) {
                    await deleteDoc(userVoteRef);
                    await updateDoc(contentRef, { [`${type}sCount`]: increment(-1) });
                    window.showToast("Voto removido.", "info");
                } else {
                    if (currentVote) { 
                        // Removing old vote count
                        await updateDoc(contentRef, { [`${currentVote}sCount`]: increment(-1) }); 
                    }
                    await setDoc(userVoteRef, { type: type });
                    await updateDoc(contentRef, { [`${type}sCount`]: increment(1) });
                    window.showToast(type === 'like' ? "Gostei!" : "N칚o gostei.", "success");
                }
                updateVoteUI(contentId, collectionName); 
            } catch(e) { console.error(e); }
        };

        async function updateVoteUI(contentId, collectionName = 'content') {
            const id = contentId || window.currentDetailItem?.id;
            if(!id) return;
            
            if (window.currentUserUid) {
                const userVoteSnap = await getDoc(doc(db, `users/${window.currentUserUid}/votes/${id}`));
                const btnLike = document.getElementById('btn-like');
                const btnDislike = document.getElementById('btn-dislike');
                btnLike.classList.remove('bg-green-600/20', 'border-green-500', 'text-green-500');
                btnDislike.classList.remove('bg-red-600/20', 'border-red-500', 'text-red-500');
                if (userVoteSnap.exists()) {
                    const type = userVoteSnap.data().type;
                    if (type === 'like') { btnLike.classList.add('bg-green-600/20', 'border-green-500', 'text-green-500'); } 
                    else { btnDislike.classList.add('bg-red-600/20', 'border-red-500', 'text-red-500'); }
                }
            }
        }

        window.openViewMore = (catId, title) => {
            const grid = document.getElementById('view-more-grid');
            const page = document.getElementById('view-more-page');
            const home = document.getElementById('home');
            const header = document.getElementById('main-header');
            let items = [];
            
            let source = window.allHomeContent;
            if (isKidsMode) source = source.filter(item => isKidsContent(item));
            
            if(catId === 'recent') items = source;
            else if(catId === 'movies') items = source.filter(c => c.type === 'movie');
            else if(catId === 'series') items = source.filter(c => c.type === 'tv');
            else if(catId === 'updated') items = source.filter(c => c.type === 'tv' && c.updatedAt > c.createdAt);
            else if(catId === 'soon') items = source.filter(c => c.isComingSoon === true);
            // Novos filtros para View More
            else if(catId === 'top10') items = source.sort((a,b) => (b.likesCount||0) - (a.likesCount||0));
            else if(catId === 'drama') items = source.filter(c => c.genres && c.genres.includes('Drama'));
            else if(catId === 'terror') items = source.filter(c => c.genres && c.genres.includes('Terror'));
            else if(catId === 'suspense') items = source.filter(c => c.genres && (c.genres.includes('Suspense') || c.genres.includes('Thriller')));
            else if(catId === 'liveaction') items = source.filter(c => c.genres && c.genres.toLowerCase().includes('live action'));
            else if(catId === 'novelas') items = source.filter(c => c.type === 'tv' && c.genres && (c.genres.includes('Soap') || c.genres.includes('Novela')));
            else if(catId === 'desenhos') items = source.filter(c => c.genres && (c.genres.includes('Anima칞칚o') || c.genres.includes('Desenho')));
            else if(catId === 'doramas') items = source.filter(c => c.genres && (c.genres.includes('Dorama') || c.genres.includes('Coreano')));
            else if(catId === 'reality') items = source.filter(c => c.genres && c.genres.includes('Reality'));
            else if(catId === 'documentario') items = source.filter(c => c.genres && c.genres.includes('Document치rio'));
            else if(catId === 'nacional') items = source.filter(c => c.audio && c.audio.includes('Nacional'));
            else if(catId === 'legendado') items = source.filter(c => c.audio && c.audio.includes('Legendado'));
            else items = source;

            document.getElementById('view-more-title').textContent = title;
            grid.innerHTML = items.map(item => `<div class="animate-fade-in relative" onclick="openDetails('${item.id}')"><img src="${item.poster}" loading="lazy" class="grid-item-poster shadow-md"><h4>${item.title}</h4>${getBadgesHTML(item)}</div>`).join('');
            home.classList.remove('active'); header.classList.add('hidden'); page.classList.remove('hidden'); window.scrollTo(0, 0);
        };
        window.closeViewMore = () => { document.getElementById('view-more-page').classList.add('hidden'); document.getElementById('main-header').classList.remove('hidden'); document.getElementById('home').classList.add('active'); };

        window.showToast = (msg, type = 'info') => { const container = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = `toast ${type} animate-slide-in`; let icon = '<i class="fa-solid fa-circle-info text-blue-400"></i>'; if (type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-400"></i>'; if (type === 'error') icon = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i>'; el.innerHTML = `${icon}<span>${msg}</span>`; container.appendChild(el); setTimeout(() => { el.classList.replace('animate-slide-in', 'animate-fade-out'); setTimeout(() => el.remove(), 300); }, 3000); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const unsubUser = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        updateUserProfileUI(user, userData);
                    }
                });
                
                const chatRef = doc(db, "support_tickets", user.uid);
                onSnapshot(chatRef, (chatSnap) => {
                    if (chatSnap.exists()) {
                        const chatData = chatSnap.data();
                        const btnText = document.getElementById('support-btn-text');
                        const btn = document.getElementById('btn-support-profile');
                        const notify = document.getElementById('support-notify');
                        
                        if (chatData.status === 'open') {
                            btnText.textContent = "Ver Chat";
                            if (chatData.unreadCountUser > 0) {
                                notify.textContent = chatData.unreadCountUser;
                                notify.classList.remove('hidden');
                            } else {
                                notify.classList.add('hidden');
                            }
                        } else {
                            btnText.textContent = "Suporte 24h";
                            notify.classList.add('hidden');
                        }
                    }
                });

                document.getElementById('profile-logged-out').classList.add('hidden'); document.getElementById('profile-logged-out').classList.remove('flex');
                document.getElementById('profile-logged-in').classList.remove('hidden'); document.getElementById('profile-logged-in').classList.add('flex');
                window.currentUserUid = user.uid;
                window.currentUserName = user.displayName;
                loadUserFavorites();
            } else {
                document.getElementById('profile-logged-in').classList.add('hidden'); document.getElementById('profile-logged-in').classList.remove('flex');
                document.getElementById('profile-logged-out').classList.remove('hidden'); document.getElementById('profile-logged-out').classList.add('flex');
                document.getElementById('header-mylist-btn').classList.add('hidden');
                window.currentUserUid = null;
                window.currentUserName = null;
                window.currentUserIsPremium = false;
            }
        });

        function updateUserProfileUI(userAuth, firestoreData) {
            let isPremium = false;
            let planName = "Usu치rio Gr치tis";
            let isVerified = firestoreData.isVerified || false;
            window.premiumExpireDate = null;

            if (firestoreData.premiumExpiresAt) {
                const expireDate = new Date(firestoreData.premiumExpiresAt);
                if (expireDate > new Date()) {
                    isPremium = true;
                    planName = firestoreData.planName || "Premium";
                    window.premiumExpireDate = expireDate;
                } else {
                    isPremium = false;
                }
            }

            window.currentUserIsPremium = isPremium;

            document.getElementById('user-name').textContent = firestoreData.username || userAuth.displayName || "CineRaver";
            document.getElementById('user-avatar').src = firestoreData.photoURL || userAuth.photoURL || "https://i.ibb.co/5k02X0f/user-placeholder.png";
            document.getElementById('user-uid').textContent = userAuth.uid;

            const badgeEl = document.getElementById('user-badge');
            const dashboard = document.getElementById('premium-dashboard');
            const freeDashboard = document.getElementById('free-dashboard');
            const verifiedIcon = document.getElementById('verified-badge');
            const avatarRing = document.getElementById('avatar-ring');
            const expireLabel = document.getElementById('premium-expire-label');

            if (premiumTimerInterval) clearInterval(premiumTimerInterval);

            if (isPremium) {
                badgeEl.textContent = planName.toUpperCase();
                badgeEl.className = "px-3 py-1 rounded-full bg-brand-premium/20 border border-brand-premium text-brand-premium mb-2 inline-block text-[9px] uppercase font-bold";
                document.getElementById('btn-upgrade-profile').classList.add('hidden');
                document.getElementById('btn-renew-profile').classList.remove('hidden');
                dashboard.classList.remove('hidden');
                dashboard.classList.add('grid');
                freeDashboard.classList.add('hidden');

                if (planName === "Vital칤cio") {
                     expireLabel.classList.add('hidden');
                     document.getElementById('btn-renew-profile').classList.add('hidden');
                     isVerified = true;
                } else {
                    expireLabel.classList.remove('hidden');
                    updatePremiumTimer();
                    premiumTimerInterval = setInterval(updatePremiumTimer, 1000);
                }
                
                avatarRing.classList.remove('from-gray-700', 'via-gray-400', 'to-gray-700');
                avatarRing.classList.add('from-yellow-600', 'via-yellow-300', 'to-yellow-600');

                const reqLabel = document.getElementById('request-quota-label');
                checkRequestQuota(true).then(res => {
                    reqLabel.textContent = `Pedidos: ${res.remaining}`;
                });

            } else {
                badgeEl.textContent = "USU츼RIO GR츼TIS";
                badgeEl.className = "px-3 py-1 rounded-full bg-white/5 border border-white/10 text-brand-silver mb-2 inline-block text-[9px] uppercase font-bold";
                document.getElementById('btn-upgrade-profile').classList.remove('hidden');
                document.getElementById('btn-renew-profile').classList.add('hidden');
                dashboard.classList.add('hidden');
                dashboard.classList.remove('grid');
                freeDashboard.classList.remove('hidden');
                expireLabel.classList.add('hidden');
                isVerified = false;
                avatarRing.classList.add('from-gray-700', 'via-gray-400', 'to-gray-700');
                avatarRing.classList.remove('from-yellow-600', 'via-yellow-300', 'to-yellow-600');
            }

            if (isVerified) verifiedIcon.classList.remove('hidden'); else verifiedIcon.classList.add('hidden');
        }

        function updatePremiumTimer() {
            if (!window.premiumExpireDate) return;
            const now = new Date();
            const diff = window.premiumExpireDate - now;
            if (diff <= 0) {
                document.getElementById('expire-timer').textContent = "EXPIRADO";
                clearInterval(premiumTimerInterval);
                forceDowngrade();
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let text = "";
            if(days > 0) text += `${days}d `;
            text += `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            document.getElementById('expire-timer').textContent = text;
        }

        async function forceDowngrade() {
            window.currentUserIsPremium = false;
            window.showToast("Seu Premium expirou!", "error");
            document.getElementById('premium-dashboard').classList.add('hidden');
            document.getElementById('premium-dashboard').classList.remove('grid');
            document.getElementById('free-dashboard').classList.remove('hidden');
            document.getElementById('btn-upgrade-profile').classList.remove('hidden');
            document.getElementById('btn-renew-profile').classList.add('hidden');
            document.getElementById('user-badge').textContent = "USU츼RIO GR츼TIS";
            setTimeout(() => location.reload(), 2000);
        }

        function checkGlobalPremiumValidity() { if (!window.currentUserUid) return; }
        window.checkUserPremium = () => { return window.currentUserIsPremium; };

        window.openRequestSearch = async () => {
            if(!window.currentUserUid) return window.openAuthModal();
            const quotaCheck = await checkRequestQuota();
            if(!quotaCheck.canRequest) return window.showToast(`Limite atingido! Espere at칠 ${quotaCheck.resetDate}`, "error");
            document.getElementById('request-search-modal').classList.add('active');
            toggleBodyScroll(true);
            document.getElementById('req-search-input').value = '';
            document.getElementById('req-results').innerHTML = '';
        };

        window.handleRequestSearch = async (val) => {
            const container = document.getElementById('req-results');
            if(val.length < 3) return;
            try {
                const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(val)}`);
                const data = await res.json();
                container.innerHTML = data.results.filter(i => i.media_type === 'movie' || i.media_type === 'tv').map(item => {
                    const title = item.title || item.name;
                    const poster = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : 'https://placehold.co/92x138/000/FFF?text=No+Img';
                    return `<div onclick="selectRequestItem('${item.id}', '${item.media_type}')" class="flex gap-3 p-3 border border-white/5 rounded-xl bg-white/5 hover:bg-white/10 cursor-pointer transition items-center"><img src="${poster}" class="w-10 h-14 rounded object-cover"><div><h4 class="text-sm font-bold text-white">${title}</h4><span class="text-[10px] text-gray-400 uppercase">${item.media_type}</span></div></div>`;
                }).join('');
            } catch(e) { console.error(e); }
        };

        window.selectRequestItem = async (id, type) => {
            try {
                const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}&language=pt-BR`);
                const data = await res.json();
                window.tempRequestData = { tmdbId: id, title: data.title || data.name, poster: data.poster_path ? `https://image.tmdb.org/t/p/w300${data.poster_path}` : '', overview: data.overview, type: type };
                document.getElementById('request-search-modal').classList.remove('active');
                document.getElementById('request-preview-modal').classList.add('active');
                document.getElementById('req-prev-poster').src = window.tempRequestData.poster;
                document.getElementById('req-prev-title').textContent = window.tempRequestData.title;
                document.getElementById('req-prev-overview').textContent = window.tempRequestData.overview || "Sem sinopse.";
                document.getElementById('req-note').value = '';
            } catch(e) { window.showToast("Erro ao selecionar", "error"); }
        };

        window.submitRequest = async () => {
            const btn = document.getElementById('btn-submit-req');
            const note = document.getElementById('req-note').value;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ENVIANDO...'; btn.classList.add('btn-loading');
            try {
                const quotaCheck = await checkRequestQuota();
                if(!quotaCheck.canRequest) throw new Error("Cota excedida");
                await addDoc(collection(db, "requests"), { ...window.tempRequestData, note: note, userId: window.currentUserUid, userName: document.getElementById('user-name').textContent, createdAt: new Date().toISOString(), status: 'pending' });
                await updateDoc(doc(db, "users", window.currentUserUid), { requestsCount: increment(1), lastRequestDate: new Date().toISOString() });
                window.showToast("Pedido enviado com sucesso!", "success");
                document.getElementById('request-preview-modal').classList.remove('active');
                toggleBodyScroll(false);
            } catch(e) { window.showToast(e.message, "error"); } finally { btn.innerHTML = 'ENVIAR PEDIDO'; btn.classList.remove('btn-loading'); }
        };

        async function checkRequestQuota(onlyCheck = false) {
            const userRef = doc(db, "users", window.currentUserUid);
            const userSnap = await getDoc(userRef);
            if(!userSnap.exists()) return { canRequest: false };
            const userData = userSnap.data();
            const now = new Date();
            let limitCount = 1; 
            let resetDate = null;
            let currentCount = userData.requestsCount || 0;
            let lastReset = userData.lastRequestReset ? new Date(userData.lastRequestReset) : new Date(0);

            if(window.currentUserIsPremium) {
                const plan = userData.planName;
                if(plan === "Vital칤cio") {
                    limitCount = 10;
                    resetDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else {
                    limitCount = 5;
                    const diffHours = Math.abs(now - lastReset) / 36e5;
                    if(diffHours >= 72) resetDate = now; else resetDate = lastReset;
                }
            } else {
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 && now.getHours() < 5 ? -7 : 0);
                resetDate = new Date(now.setDate(diff));
                resetDate.setHours(5,0,0,0);
            }

            if(lastReset < resetDate) {
                if(!onlyCheck) { await updateDoc(userRef, { requestsCount: 0, lastRequestReset: resetDate.toISOString() }); currentCount = 0; } else { currentCount = 0; }
            }
            return { canRequest: currentCount < limitCount, remaining: limitCount - currentCount, resetDate: "pr칩ximo ciclo" };
        }

        window.handleSupportClick = async () => {
            if(!window.currentUserUid) return;
            const chatSnap = await getDoc(doc(db, "support_tickets", window.currentUserUid));
            if (chatSnap.exists() && chatSnap.data().status === 'open') {
                window.openChatModal(window.currentUserUid);
            } else {
                openSupport();
            }
        };

        window.openSupport = () => {
            if(!window.currentUserIsPremium) return window.showToast("Exclusivo Premium", "error");
            document.getElementById('support-intro-modal').classList.add('active');
            toggleBodyScroll(true);
        };

        window.startSupportChat = async () => {
            const msg = document.getElementById('support-intro-msg').value;
            if(!msg) return window.showToast("Descreva o problema", "error");
            const chatId = window.currentUserUid;
            await setDoc(doc(db, "support_tickets", chatId), { userId: window.currentUserUid, userName: document.getElementById('user-name').textContent, lastMessage: msg, lastMessageAt: new Date().toISOString(), unreadCountUser: 0, unreadCountAdmin: 1, status: 'open' }, { merge: true });
            await addDoc(collection(db, `support_tickets/${chatId}/messages`), { text: msg, sender: 'user', createdAt: new Date().toISOString() });
            document.getElementById('support-intro-modal').classList.remove('active');
            window.openChatModal(chatId);
        };

        window.openChatModal = (chatId) => {
            window.activeChatId = chatId;
            document.getElementById('chat-modal').classList.add('active');
            toggleBodyScroll(true);
            const container = document.getElementById('chat-messages');
            container.innerHTML = '<div class="text-center text-xs text-gray-500 mt-4">Carregando mensagens...</div>';
            if(window.chatUnsub) window.chatUnsub();
            
            const isAdminMode = localStorage.getItem('cinerave_admin_mode') === 'true';
            const fieldToReset = isAdminMode ? 'unreadCountAdmin' : 'unreadCountUser';
            updateDoc(doc(db, "support_tickets", chatId), { [fieldToReset]: 0 });

            const q = query(collection(db, `support_tickets/${chatId}/messages`), orderBy('createdAt', 'asc'));
            window.chatUnsub = onSnapshot(q, (snap) => {
                container.innerHTML = '';
                snap.forEach(doc => {
                    const msg = doc.data();
                    const div = document.createElement('div');
                    let cssClass = 'other';
                    if (isAdminMode) { if (msg.sender === 'admin') cssClass = 'mine'; } else { if (msg.sender === 'user') cssClass = 'mine'; }
                    div.className = `chat-msg ${cssClass}`;
                    div.textContent = msg.text;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text || !window.activeChatId) return;
            const isAdminMode = localStorage.getItem('cinerave_admin_mode') === 'true';
            const sender = isAdminMode ? 'admin' : 'user';
            
            await addDoc(collection(db, `support_tickets/${window.activeChatId}/messages`), { text: text, sender: sender, createdAt: new Date().toISOString() });
            
            const updates = { lastMessage: text, lastMessageAt: new Date().toISOString() };
            if (sender === 'admin') updates.unreadCountUser = increment(1);
            else updates.unreadCountAdmin = increment(1);
            
            await updateDoc(doc(db, "support_tickets", window.activeChatId), updates);
            input.value = '';
        };

        window.closeChat = () => { document.getElementById('chat-modal').classList.remove('active'); toggleBodyScroll(false); if(window.chatUnsub) window.chatUnsub(); window.activeChatId = null; };

        // --- LIVE CHANNELS ---
        window.openChannelManager = () => { 
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-channels-container').classList.add('hidden'); 
            document.getElementById('channel-modal').classList.add('active'); 
            toggleBodyScroll(true);
            document.getElementById('channel-name').value = '';
            document.getElementById('channel-image').value = '';
            document.getElementById('channel-id').value = '';
            document.getElementById('channel-links-container').innerHTML = '';
            addChannelLinkBox(); // Add one empty box
        };
        window.closeChannelManager = () => { 
            document.getElementById('channel-modal').classList.remove('active'); 
            toggleBodyScroll(false);
            document.getElementById('admin-dashboard').classList.remove('hidden'); 
        };
        window.addChannelLinkBox = (name='', url='', isPrem=false) => {
            const container = document.getElementById('channel-links-container');
            const div = document.createElement('div');
            div.className = 'bg-white/5 p-2 rounded border border-white/10 flex flex-col gap-2 relative';
            div.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute top-1 right-2 text-red-500 text-xs"><i class="fa-solid fa-xmark"></i></button><input type="text" class="link-name custom-input p-1 text-xs rounded" placeholder="Nome (Ex: Op칞칚o 1)" value="${name}"><input type="text" class="link-url custom-input p-1 text-xs rounded" placeholder="Link M3U8/MP4" value="${url}"><label class="flex items-center gap-2 text-xs text-gray-400"><input type="checkbox" class="link-prem accent-brand-premium" ${isPrem ? 'checked' : ''}> Apenas Premium</label>`;
            container.appendChild(div);
        };
        window.saveChannel = async () => {
            const id = document.getElementById('channel-id').value;
            const name = document.getElementById('channel-name').value;
            const img = document.getElementById('channel-image').value;
            const linkDivs = document.querySelectorAll('#channel-links-container > div');
            const links = [];
            linkDivs.forEach(d => {
                links.push({
                    name: d.querySelector('.link-name').value || 'Servidor',
                    url: d.querySelector('.link-url').value,
                    isPremium: d.querySelector('.link-prem').checked
                });
            });
            if (!name || !img || links.length === 0) return window.showToast("Preencha todos os campos", "error");
            
            const data = { name, image: img, links, updatedAt: new Date().toISOString() };
            try {
                if (id) await setDoc(doc(db, "channels", id), data, {merge:true});
                else await addDoc(collection(db, "channels"), data);
                window.showToast("Canal salvo!", "success");
                window.closeChannelManager();
                window.showAdminChannels();
            } catch(e) { window.showToast("Erro ao salvar", "error"); }
        };
        window.openLiveServerModal = (channel, docId) => {
            // Define o contexto atual para Vota칞칚o em Canais
            window.currentDetailItem = {
                id: docId,
                title: channel.name,
                isChannel: true,
                poster: channel.image
            };

            const modal = document.getElementById('server-modal');
            const list = document.getElementById('server-list');
            modal.classList.add('active');
            toggleBodyScroll(true);
            list.innerHTML = '';
            document.getElementById('lock-screen').classList.add('hidden');
            const isPremium = window.checkUserPremium();
            
            window.currentPlayTitle = channel.name;
            
            channel.links.forEach(l => {
                let disabled = '';
                let click = `onclick="openPlayer('${l.url}')"`;
                let subtext = "Dispon칤vel";
                let subClass = "text-green-400";
                
                if (l.isPremium && !isPremium) {
                    disabled = 'disabled';
                    subtext = 'Exclusivo Premium';
                    subClass = 'text-brand-premium';
                    click = `onclick="window.showToast('Canal Premium!', 'error');"`;
                }
                list.innerHTML += `<div class="server-option ${disabled}" ${click}><div class="flex items-center gap-3"><div class="w-8 flex justify-center"><i class="fa-solid fa-tv text-white"></i></div><div><p class="text-sm font-bold text-white">${l.name}</p><p class="text-[10px] ${subClass}">${subtext}</p></div></div></div>`;
            });
        };

        window.showAdminChannels = async () => {
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-channels-container').classList.remove('hidden');
            const grid = document.getElementById('admin-channels-grid');
            grid.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            
            const q = query(collection(db, "channels"));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            
            if(snap.empty) return grid.innerHTML = '<p class="text-center text-gray-500 text-xs">Nenhum canal criado.</p>';
            
            snap.forEach(doc => {
                const ch = doc.data();
                const div = document.createElement('div');
                div.className = 'bg-dark-card border border-white/10 p-3 rounded-xl flex gap-3 relative items-center';
                div.innerHTML = `<img src="${ch.image}" class="w-12 h-12 object-cover rounded bg-black"><div class="flex-1"><h4 class="font-bold text-white text-sm">${ch.name}</h4><p class="text-[10px] text-gray-500">${ch.links.length} Servidores</p></div><button onclick="editChannel('${doc.id}')" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-300 hover:text-white mr-2"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="deleteChannel('${doc.id}')" class="w-8 h-8 rounded-full bg-red-900/20 flex items-center justify-center text-red-500 hover:text-white"><i class="fa-solid fa-trash text-xs"></i></button>`;
                grid.appendChild(div);
            });
        };
        
        window.hideAdminChannels = () => { document.getElementById('admin-channels-container').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };
        
        window.deleteChannel = async (id) => {
            if(!confirm("Excluir canal?")) return;
            try { await deleteDoc(doc(db, "channels", id)); window.showAdminChannels(); window.showToast("Canal exclu칤do.", "info"); } catch(e) { console.error(e); }
        };
        
        window.editChannel = async (id) => {
            const docRef = doc(db, "channels", id);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                const ch = docSnap.data();
                document.getElementById('admin-channels-container').classList.add('hidden');
                document.getElementById('channel-modal').classList.add('active');
                toggleBodyScroll(true);
                document.getElementById('channel-id').value = id;
                document.getElementById('channel-name').value = ch.name;
                document.getElementById('channel-image').value = ch.image;
                document.getElementById('channel-links-container').innerHTML = '';
                ch.links.forEach(l => addChannelLinkBox(l.name, l.url, l.isPremium));
            }
        };

        window.showAdminRequests = async () => {
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-requests-container').classList.remove('hidden');
            const grid = document.getElementById('admin-requests-grid');
            grid.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            const q = query(collection(db, "requests"), orderBy('createdAt', 'desc'), limit(50));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            if(snap.empty) return grid.innerHTML = '<p class="text-center text-gray-500 text-xs">Sem pedidos.</p>';
            snap.forEach(doc => {
                const req = doc.data();
                const div = document.createElement('div');
                div.className = 'bg-dark-card border border-white/10 p-3 rounded-xl flex gap-3 relative';
                // Updated delete button to ensure correct deletion
                div.innerHTML = `<img src="${req.poster}" class="w-12 h-16 object-cover rounded bg-black"><div class="flex-1 overflow-hidden"><div class="flex justify-between items-start"><h4 class="font-bold text-white text-sm truncate pr-2">${req.title}</h4><span class="text-[9px] text-gray-500">${new Date(req.createdAt).toLocaleDateString()}</span></div><p class="text-[10px] text-brand-premium font-bold mb-1">${req.userName} <span class="text-gray-600 font-normal">(${req.userId})</span></p><p class="text-[10px] text-gray-400 italic truncate bg-white/5 p-1 rounded">"${req.note || 'Sem obs'}"</p></div><button onclick="window.deleteRequest('${doc.id}', this)" class="h-full px-2 text-red-500 hover:bg-red-900/20 rounded"><i class="fa-solid fa-trash"></i></button>`;
                grid.appendChild(div);
            });
        };

        window.deleteRequest = async (id, btn) => {
            if(!confirm("Excluir pedido?")) return;
            try { 
                await deleteDoc(doc(db, "requests", id)); 
                const card = btn.closest('.bg-dark-card');
                if(card) card.remove();
                window.showToast("Pedido exclu칤do.", "info"); 
            } catch(e) { console.error(e); window.showToast("Erro ao excluir", "error"); }
        };
        window.hideAdminRequests = () => { document.getElementById('admin-requests-container').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };

        window.showAdminSupportList = async () => {
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-support-container').classList.remove('hidden');
            const grid = document.getElementById('admin-support-grid');
            grid.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            const q = query(collection(db, "support_tickets"), orderBy('lastMessageAt', 'desc'));
            const snap = await getDocs(q);
            grid.innerHTML = '';
            if(snap.empty) return grid.innerHTML = '<p class="text-center text-gray-500 text-xs">Nenhum chamado aberto.</p>';
            snap.forEach(doc => {
                const ticket = doc.data();
                const div = document.createElement('div');
                div.className = 'bg-dark-card border border-white/10 p-4 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/5 relative';
                div.onclick = () => window.openChatModal(doc.id);
                const unreadBadge = ticket.unreadCountAdmin > 0 ? `<div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>` : '';
                div.innerHTML = `${unreadBadge}<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-pink-600/20 text-pink-500 flex items-center justify-center font-bold"><i class="fa-regular fa-user"></i></div><div><h4 class="font-bold text-white text-sm">Chat de ${ticket.userName}</h4><p class="text-[10px] text-gray-400 truncate max-w-[150px]">${ticket.lastMessage}</p></div></div><div class="text-right"><span class="text-[9px] text-gray-500 block">${new Date(ticket.lastMessageAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span><span class="text-[9px] bg-green-500/20 text-green-500 px-2 rounded">ABERTO</span></div>`;
                grid.appendChild(div);
            });
        };
        window.hideAdminSupportList = () => { document.getElementById('admin-support-container').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };

        window.openEditProfile = () => { if (!window.currentUserIsPremium) return window.showToast("Recurso exclusivo Premium", "error"); document.getElementById('edit-profile-modal').classList.add('active'); toggleBodyScroll(true); document.getElementById('edit-name').value = document.getElementById('user-name').textContent; document.getElementById('edit-preview-img').src = document.getElementById('user-avatar').src; };
        window.closeEditProfile = () => { document.getElementById('edit-profile-modal').classList.remove('active'); toggleBodyScroll(false); window.editImageFile = null; };
        window.handleEditFileSelect = (e) => { const file = e.target.files[0]; if (file) { window.editImageFile = file; const reader = new FileReader(); reader.onload = (e) => { document.getElementById('edit-preview-img').src = e.target.result; }; reader.readAsDataURL(file); } };
        window.saveProfileChanges = async () => {
            const btn = document.getElementById('btn-save-profile'); const newName = document.getElementById('edit-name').value; const file = window.editImageFile;
            if (!newName) return window.showToast("Nome inv치lido", "error");
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> SALVANDO...';
            try {
                let photoURL = document.getElementById('user-avatar').src;
                if (file) { const formData = new FormData(); formData.append("image", file); const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData }); const data = await res.json(); if(data.success) { photoURL = data.data.url; } else { throw new Error("Erro no upload da imagem"); } }
                
                // Update User Doc
                await updateDoc(doc(db, "users", window.currentUserUid), { username: newName, photoURL: photoURL });
                if (auth.currentUser) { await updateProfile(auth.currentUser, { displayName: newName, photoURL: photoURL }); }

                // --- UPDATE EVERYWHERE LOGIC ---
                // Verifica o status de verificado novamente para garantir
                const userDoc = await getDoc(doc(db, "users", window.currentUserUid));
                const isVerified = userDoc.exists() ? (userDoc.data().isVerified || false) : false;

                // Sync with Reviews
                const q = query(collection(db, "site_reviews"), where("userId", "==", window.currentUserUid));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.update(doc.ref, { 
                        userName: newName, 
                        userPhoto: photoURL,
                        isVerified: isVerified
                    });
                });
                await batch.commit();
                // -----------------------------

                window.showToast("Perfil atualizado em todo o site!", "success"); window.closeEditProfile();
            } catch(e) { console.error(e); window.showToast("Erro ao salvar: " + e.message, "error"); } finally { btn.innerHTML = 'SALVAR ALTERA칂칏ES'; }
        };

        window.requestLogout = () => { document.getElementById('logout-confirm-modal').classList.add('active'); toggleBodyScroll(true); }
        window.confirmLogout = async () => {
            const btn = document.getElementById('btn-confirm-logout'); btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            try { await signOut(auth); document.getElementById('logout-confirm-modal').classList.remove('active'); toggleBodyScroll(false); window.showToast("Desconectado.", "info"); document.getElementById('profile-logged-in').classList.add('hidden'); document.getElementById('profile-logged-in').classList.remove('flex'); document.getElementById('profile-logged-out').classList.remove('hidden'); document.getElementById('profile-logged-out').classList.add('flex'); window.switchTab('profile'); } catch(e) { window.showToast(e.message, "error"); } finally { btn.innerHTML = 'Sair'; }
        }
        window.handleLogout = window.requestLogout;

        window.handleRegisterSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-pass').value; const name = document.getElementById('reg-name').value; const file = window.selectedImageFile;
            if(!file) return window.showToast("Escolha uma foto de perfil", "error");
            const btn = document.getElementById('btn-register'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Criando...'; btn.classList.add('btn-loading');
            try {
                const formData = new FormData(); formData.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await res.json();
                if(!data.success) throw new Error("Erro upload imagem");
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCred.user, { displayName: name, photoURL: data.data.url });
                await setDoc(doc(db, "users", userCred.user.uid), { username: name, email: email, photoURL: data.data.url, uid: userCred.user.uid, plan: "free", createdAt: new Date().toISOString() });
                document.getElementById('user-name').textContent = name; document.getElementById('user-avatar').src = data.data.url; document.getElementById('user-uid').textContent = userCred.user.uid;
                window.resetAuthForms(); window.closeAuthModal(); window.switchTab('profile'); window.showToast("Conta criada!", "success");
            } catch(e) { window.showToast(e.message, "error"); } finally { btn.innerHTML = oldText; btn.classList.remove('btn-loading'); }
        };

        window.handleLoginSubmit = async (e) => { 
            e.preventDefault(); 
            const btn = document.getElementById('btn-login-submit'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; btn.classList.add('btn-loading');
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); window.resetAuthForms(); window.closeAuthModal(); window.switchTab('profile'); window.showToast("Bem-vindo!", "success"); } 
            catch(e) { window.showToast(e.message, "error"); } finally { btn.innerHTML = oldText; btn.classList.remove('btn-loading'); }
        };
        window.resetAuthForms = () => { document.getElementById('login-form').reset(); document.getElementById('register-form').reset(); document.getElementById('preview-img').src = ""; document.getElementById('preview-img').classList.add('hidden'); window.selectedImageFile = null; };
        document.getElementById('register-form').addEventListener('submit', window.handleRegisterSubmit); document.getElementById('login-form').addEventListener('submit', window.handleLoginSubmit);

        window.handleFileSelect = (e) => { const file = e.target.files[0]; if(file){ window.selectedImageFile = file; const reader = new FileReader(); reader.onload = (e) => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-img').classList.remove('hidden'); }; reader.readAsDataURL(file); } };
        window.switchTab = (tabId) => { window.closeAllOverlays(); document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active')); const target = document.getElementById(tabId); if(target) target.classList.add('active'); document.querySelectorAll('.nav-item').forEach(item => { item.classList.remove('active'); if (item.dataset.target === tabId) item.classList.add('active'); }); window.scrollTo(0,0); };
        window.closeAllOverlays = () => { 
            window.closeDetails(); window.closePlayer(); window.closeAuthModal(); window.closeEditProfile(); window.closeViewMore(); window.closeChannelManager(); 
            document.getElementById('admin-auth-modal').classList.remove('active'); 
            document.getElementById('logout-confirm-modal').classList.remove('active'); 
            document.getElementById('delete-modal').classList.remove('active'); 
            document.getElementById('server-modal').classList.remove('active'); 
            document.getElementById('request-search-modal').classList.remove('active'); 
            document.getElementById('request-preview-modal').classList.remove('active'); 
            document.getElementById('support-intro-modal').classList.remove('active'); 
            document.getElementById('chat-modal').classList.remove('active'); 
            document.getElementById('rate-modal').classList.remove('active');
            document.getElementById('reviews-list-modal').classList.remove('active');
            document.getElementById('privacy-modal').classList.remove('active');
            document.getElementById('legal-modal').classList.remove('active');
            // Close sidebar
            document.getElementById('main-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('open');
            toggleBodyScroll(false);
        };
        window.openAuthModal = () => { document.getElementById('auth-modal').classList.add('active'); toggleBodyScroll(true); }; window.closeAuthModal = () => { document.getElementById('auth-modal').classList.remove('active'); toggleBodyScroll(false); window.resetAuthForms(); };
        window.toggleAuthMode = (mode) => { if(mode === 'login') { document.getElementById('login-form').classList.remove('hidden'); document.getElementById('register-form').classList.add('hidden'); document.getElementById('tab-login').classList.add('border-white', 'text-white'); document.getElementById('tab-register').classList.remove('border-white', 'text-white'); } else { document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); document.getElementById('tab-register').classList.add('border-white', 'text-white'); document.getElementById('tab-login').classList.remove('border-white', 'text-white'); } };
        window.copyUID = () => { if(window.currentUserUid) navigator.clipboard.writeText(window.currentUserUid).then(() => { const f = document.getElementById('copy-feedback'); f.classList.add('show'); setTimeout(() => f.classList.remove('show'), 2000); }); };

        window.handleTmdbSearch = async (e) => { const query = e.target.value; const resultsContainer = document.getElementById('tmdb-results'); const loader = document.getElementById('tmdb-loader'); if (query.length < 3) { resultsContainer.classList.add('hidden'); return; } loader.classList.remove('hidden'); try { const response = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(query)}&page=1&include_adult=false`); const data = await response.json(); resultsContainer.innerHTML = ''; const filtered = data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv'); if (filtered.length > 0) { filtered.forEach(item => { const title = item.title || item.name; const year = (item.release_date || item.first_air_date || '').split('-')[0]; const poster = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : 'https://placehold.co/92x138/000/FFF?text=No+Img'; const el = document.createElement('div'); el.className = 'flex items-center gap-3 p-3 border-b border-white/5 cursor-pointer tmdb-item transition'; el.innerHTML = `<img src="${poster}" class="w-10 h-14 object-cover rounded bg-dark-card"><div><h4 class="text-sm font-bold text-white leading-tight">${title}</h4><div class="flex items-center gap-2 mt-1"><span class="text-[10px] text-gray-400">${year}</span><span class="text-[9px] uppercase px-1.5 py-0.5 rounded bg-white/10 text-white">${item.media_type === 'movie' ? 'FILME' : 'S칄RIE'}</span></div></div>`; el.onclick = () => selectTmdbContent(item.id, item.media_type); resultsContainer.appendChild(el); }); resultsContainer.classList.remove('hidden'); } else { resultsContainer.classList.add('hidden'); } } catch (err) { console.error(err); } finally { loader.classList.add('hidden'); } };
        window.selectTmdbContent = async (id, type) => { 
            document.getElementById('tmdb-results').classList.add('hidden'); 
            document.getElementById('tmdb-search-input').value = ''; 
            try { 
                const response = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}&language=pt-BR&append_to_response=credits,videos`); 
                const data = await response.json(); 
                window.editingId = null; 
                document.getElementById('btn-publish-final').textContent = "PUBLICAR CONTE칔DO"; 
                populateFormFromData({ tmdbId: id, title: data.title || data.name, year: (data.release_date || data.first_air_date || '').split('-')[0], overview: data.overview, poster: data.poster_path ? `https://image.tmdb.org/t/p/w342${data.poster_path}` : 'https://placehold.co/300x450', backdrop: data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '', genres: data.genres ? data.genres.map(g => g.name).join(', ') : '', actors: data.credits?.cast ? data.credits.cast.slice(0, 5).map(c => c.name).join(', ') : '', trailer: data.videos?.results.find(v => v.site === 'YouTube' && v.type === 'Trailer') ? `https://www.youtube.com/watch?v=${data.videos.results.find(v => v.site === 'YouTube' && v.type === 'Trailer').key}` : '', type: type, links: { main: '', extras: [] }, seasons: [] }); 
            } catch (err) { window.showToast("Erro ao carregar TMDB", "error"); console.log(err); } 
        };
        
        window.populateFormFromData = (data) => { document.getElementById('main-cms-form').classList.remove('hidden'); selectedContentType = data.type; document.getElementById('cms-tmdb-id').value = data.tmdbId; document.getElementById('cms-title').value = data.title; document.getElementById('cms-year').value = data.year; document.getElementById('cms-overview').value = data.overview; document.getElementById('cms-poster').src = data.poster; document.getElementById('cms-backdrop').value = data.backdrop; document.getElementById('cms-genres').value = data.genres; document.getElementById('cms-actors').value = data.actors; document.getElementById('cms-trailer').value = data.trailer; document.getElementById('check-coming-soon').checked = data.isComingSoon || false; document.getElementById('check-drive').checked = data.isDrive || false; document.getElementById('check-telegram').checked = data.isTelegram || false; document.getElementById('check-watch-party').checked = data.isWatchParty || false; document.getElementById('check-draft').checked = data.status === 'draft'; document.getElementById('schedule-general').value = data.scheduleGeneral || ''; document.getElementById('schedule-premium').value = data.schedulePremium || ''; document.querySelectorAll('.tag-select').forEach(el => { const type = el.dataset.type; const txt = el.innerText; if(data[type] && data[type].includes(txt)) el.classList.add('selected'); else el.classList.remove('selected'); }); const typeBadge = document.getElementById('cms-type-badge'); const movieLinks = document.getElementById('section-movie-links'); const seriesLinks = document.getElementById('section-series-links'); const watchPartyContainer = document.getElementById('container-watch-party'); if (data.type === 'movie') { typeBadge.textContent = 'FILME'; typeBadge.classList.replace('bg-blue-500/20', 'bg-white/10'); movieLinks.classList.remove('hidden'); seriesLinks.classList.add('hidden'); watchPartyContainer.classList.remove('hidden'); document.getElementById('movie-main-link').value = data.links?.main || ''; document.getElementById('movie-extra-links').innerHTML = ''; if(data.links?.extras) { data.links.extras.forEach(l => { addMovieLinkBox(l.type, l.url, l.embed); }); } } else { typeBadge.textContent = 'S칄RIE'; typeBadge.classList.add('bg-blue-500/20'); movieLinks.classList.add('hidden'); seriesLinks.classList.remove('hidden'); watchPartyContainer.classList.add('hidden'); document.getElementById('seasons-container').innerHTML = ''; if(data.seasons && data.seasons.length > 0) { data.seasons.forEach(s => { const seasonDiv = createSeasonDOM(s.season); document.getElementById('seasons-container').appendChild(seasonDiv); if(s.episodes) { const list = seasonDiv.querySelector('.episodes-list'); s.episodes.forEach(ep => { const epDiv = createEpisodeDOM(ep.ep, ep.link, ep.rave, ep.embed, ep.schedule); list.appendChild(epDiv); }); } }); } } };
        window.toggleTag = (el) => el.classList.toggle('selected');
        window.addMovieLinkBox = (type, val = '', embedVal = '') => { const container = document.getElementById('movie-extra-links'); const div = document.createElement('div'); div.className = 'relative bg-dark-card border border-white/5 p-3 rounded-lg mt-2'; let label = type.toUpperCase(); let colorClass = type === 'drive' ? 'text-yellow-500' : type === 'telegram' ? 'text-blue-500' : type === 'rave' ? 'text-red-500' : 'text-gray-400'; const commonHeader = `<div class="flex justify-between mb-1"><span class="text-[10px] font-bold ${colorClass}">${label}</span><button onclick="this.parentElement.parentElement.remove()" class="text-gray-600 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>`; const typeInput = `<input type="hidden" class="link-type" value="${type}">`; if (type === 'rave') { div.innerHTML = `${commonHeader}<input type="text" class="w-full custom-input p-2 rounded text-xs mb-2 rave-url" placeholder="Link MP4..." value="${val}"><input type="text" class="w-full custom-input p-2 rounded text-xs rave-embed" placeholder="Embed Code..." value="${embedVal}">${typeInput}`; } else { div.innerHTML = `${commonHeader}<input type="text" class="w-full custom-input p-2 rounded text-xs link-url" placeholder="URL..." value="${val}">${typeInput}`; } container.appendChild(div); };
        window.generateSeasons = () => { const count = parseInt(document.getElementById('input-season-count').value) || 1; const container = document.getElementById('seasons-container'); container.innerHTML = ''; for (let s = 1; s <= count; s++) { container.appendChild(createSeasonDOM(s)); } };
        window.addSeasonManual = () => { const container = document.getElementById('seasons-container'); const currentCount = container.children.length; container.appendChild(createSeasonDOM(currentCount + 1)); };
        window.addEpisodeManual = (btn, seasonNum) => { const list = btn.closest('.bg-dark-900').querySelector('.episodes-list'); const currentCount = list.children.length; list.appendChild(createEpisodeDOM(currentCount + 1)); };
        window.generateEpisodes = (btn, seasonNum) => { const count = parseInt(btn.previousElementSibling.value) || 1; const list = btn.closest('.bg-dark-900').querySelector('.episodes-list'); list.innerHTML = ''; for (let e = 1; e <= count; e++) { list.appendChild(createEpisodeDOM(e)); } };
        function createSeasonDOM(num) { const div = document.createElement('div'); div.className = 'bg-dark-900 border border-white/5 rounded-xl p-4 season-box'; div.dataset.season = num; div.innerHTML = `<div class="flex justify-between items-center mb-3"><h4 class="text-sm font-bold text-white">Temporada ${num}</h4><div class="flex gap-2 items-center"><button onclick="this.closest('.season-box').remove()" class="bg-red-900/30 text-red-500 px-2 py-1 rounded text-xs"><i class="fa-solid fa-trash"></i></button><button onclick="addEpisodeManual(this, ${num})" class="bg-white/5 hover:bg-white/10 text-white text-[10px] px-2 py-1 rounded font-bold mr-2">+ Ep</button><input type="number" class="ep-count-input w-12 bg-dark-card border border-white/10 rounded px-1 py-1 text-xs text-center" placeholder="Qtd"><button onclick="generateEpisodes(this, ${num})" class="bg-white/10 hover:bg-white/20 text-white text-[10px] px-2 py-1 rounded">Gerar</button></div></div><div class="episodes-list space-y-2"></div>`; return div; }
        function createEpisodeDOM(num, link='', rave='', embed='', sched='') { const div = document.createElement('div'); div.className = 'bg-dark-card p-3 rounded-lg border border-white/5 episode-box'; div.dataset.episode = num; div.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-gray-400">EPIS칍DIO ${num}</span><button onclick="this.parentElement.parentElement.remove()" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button></div><div class="grid grid-cols-1 gap-2"><input type="text" class="ep-link w-full custom-input p-2 rounded text-[10px]" placeholder="Link Principal" value="${link}"><div class="flex gap-2"><input type="text" class="ep-rave w-1/2 custom-input p-2 rounded text-[10px]" placeholder="Rave MP4" value="${rave}"><input type="text" class="ep-embed w-1/2 custom-input p-2 rounded text-[10px]" placeholder="Embed Code" value="${embed}"></div><div class="mt-1"><label class="text-[9px] text-gray-600 uppercase">Agendamento</label><input type="datetime-local" class="ep-schedule w-full bg-transparent border-b border-white/10 text-[10px] text-gray-400" value="${sched}"></div></div>`; return div; }

        window.showEditList = async () => { document.getElementById('admin-dashboard').classList.add('hidden'); document.getElementById('edit-list-container').classList.remove('hidden'); document.getElementById('edit-results-grid').innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fa-solid fa-circle-notch fa-spin"></i></div>'; try { const querySnapshot = await getDocs(collection(db, "content")); window.contentListCache = []; querySnapshot.forEach((doc) => { window.contentListCache.push({ id: doc.id, ...doc.data() }); }); renderEditList(window.contentListCache); } catch (err) { document.getElementById('edit-results-grid').innerHTML = `<p class="text-red-500 text-center text-xs">Erro: ${err.message}</p>`; } };
        window.renderEditList = (list) => { const grid = document.getElementById('edit-results-grid'); grid.innerHTML = ''; if(list.length === 0) { grid.innerHTML = '<p class="text-center text-gray-500 text-xs">Nenhum conte칰do encontrado.</p>'; return; } list.forEach(item => { const statusClass = item.status === 'draft' ? 'status-draft' : 'status-published'; const statusText = item.status === 'draft' ? 'Rascunho' : 'Publicado'; const div = document.createElement('div'); div.className = 'edit-card bg-dark-card border border-white/5 rounded-xl p-3 flex gap-3 items-center relative'; div.innerHTML = `<img src="${item.poster}" class="w-12 h-16 object-cover rounded bg-black"><div class="flex-1"><h4 class="text-sm font-bold text-white leading-tight mb-1">${item.title}</h4><div class="flex gap-2 mb-2"><span class="${statusClass} status-badge">${statusText}</span><span class="text-[9px] text-gray-500 uppercase pt-0.5">${item.type}</span></div></div><div class="flex gap-2"><button onclick="editContent('${item.id}')" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-300"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="confirmDelete('${item.id}')" class="w-8 h-8 rounded-full bg-white/5 hover:bg-red-900/20 flex items-center justify-center text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button><button onclick="deleteContentForce('${item.id}')" class="w-6 h-6 rounded-full bg-red-900/10 hover:bg-red-600 flex items-center justify-center text-red-500 hover:text-white" title="For칞ar Exclus칚o"><i class="fa-solid fa-ban text-[10px]"></i></button></div>`; grid.appendChild(div); }); };
        window.filterEditList = (val) => { const filtered = window.contentListCache.filter(item => item.title.toLowerCase().includes(val.toLowerCase())); renderEditList(filtered); };
        window.editContent = (id) => { const item = window.contentListCache.find(c => c.id === id); if(item) { window.editingId = id; document.getElementById('edit-list-container').classList.add('hidden'); document.getElementById('publish-form-container').classList.remove('hidden'); document.getElementById('tmdb-search-block').classList.add('hidden'); document.getElementById('form-title').textContent = "EDITAR CONTE칔DO"; document.getElementById('btn-publish-final').textContent = "ATUALIZAR CONTE칔DO"; populateFormFromData(item); } };

        window.prePublishCheck = () => { const title = document.getElementById('cms-title').value; if(!title) return window.showToast("T칤tulo 칠 obrigat칩rio", "error"); const data = { tmdbId: document.getElementById('cms-tmdb-id').value, title: title, year: document.getElementById('cms-year').value, type: selectedContentType, overview: document.getElementById('cms-overview').value, poster: document.getElementById('cms-poster').src, backdrop: document.getElementById('cms-backdrop').value, genres: document.getElementById('cms-genres').value, trailer: document.getElementById('cms-trailer').value, actors: document.getElementById('cms-actors').value, updatedAt: new Date().toISOString(), quality: Array.from(document.querySelectorAll('.tag-select.selected[data-type="quality"]')).map(el => el.innerText), audio: Array.from(document.querySelectorAll('.tag-select.selected[data-type="audio"]')).map(el => el.innerText), isComingSoon: document.getElementById('check-coming-soon').checked, isDrive: document.getElementById('check-drive').checked, isTelegram: document.getElementById('check-telegram').checked, isWatchParty: selectedContentType === 'movie' ? document.getElementById('check-watch-party').checked : false, status: document.getElementById('check-draft').checked ? 'draft' : 'published', scheduleGeneral: document.getElementById('schedule-general').value || null, schedulePremium: document.getElementById('schedule-premium').value || null, }; if(!window.editingId) data.createdAt = new Date().toISOString(); if (selectedContentType === 'movie') { data.links = { main: document.getElementById('movie-main-link').value, extras: [] }; document.querySelectorAll('#movie-extra-links > div').forEach(div => { const type = div.querySelector('.link-type').value; if (type === 'rave') data.links.extras.push({ type: 'rave', url: div.querySelector('.rave-url').value, embed: div.querySelector('.rave-embed').value }); else data.links.extras.push({ type: type, url: div.querySelector('.link-url').value }); }); } else { data.seasons = []; document.querySelectorAll('#seasons-container > div').forEach(seasonDiv => { const seasonNum = seasonDiv.dataset.season; const episodes = []; seasonDiv.querySelectorAll('.episode-box').forEach(epDiv => { episodes.push({ ep: epDiv.dataset.episode, link: epDiv.querySelector('.ep-link').value, rave: epDiv.querySelector('.ep-rave').value, embed: epDiv.querySelector('.ep-embed').value, schedule: epDiv.querySelector('.ep-schedule').value || null }); }); data.seasons.push({ season: seasonNum, episodes: episodes }); }); } window.currentDataPayload = data; document.getElementById('preview-modal-img').src = data.poster; document.getElementById('preview-modal-title').textContent = data.title; document.getElementById('preview-modal-type').textContent = data.type === 'movie' ? 'FILME' : 'S칄RIE'; document.getElementById('preview-modal-status').textContent = data.status === 'draft' ? 'SALVAR COMO RASCUNHO' : 'PUBLICAR VIS칈VEL'; document.getElementById('preview-modal-status').className = data.status === 'draft' ? 'text-[10px] mt-1 text-gray-400' : 'text-[10px] mt-1 text-green-400'; let countLinks = selectedContentType === 'movie' ? (data.links.extras.length + (data.links.main ? 1 : 0)) : 'N/A'; let countSeasons = selectedContentType === 'tv' ? data.seasons.length : 'N/A'; document.getElementById('preview-link-count').textContent = countLinks; document.getElementById('preview-season-count').textContent = countSeasons; document.getElementById('preview-schedule').textContent = data.scheduleGeneral ? new Date(data.scheduleGeneral).toLocaleString() : 'Imediato'; document.getElementById('preview-modal').classList.add('active'); toggleBodyScroll(true); };
        window.closePreview = () => { document.getElementById('preview-modal').classList.remove('active'); toggleBodyScroll(false); };
        window.confirmPublish = async () => { 
            const btn = document.getElementById('btn-confirm-publish'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; btn.classList.add('btn-loading');
            try { 
                if(window.editingId) { await setDoc(doc(db, "content", window.editingId), window.currentDataPayload, { merge: true }); window.showToast("Conte칰do atualizado!", "success"); } 
                else { await addDoc(collection(db, "content"), window.currentDataPayload); window.showToast("Conte칰do publicado!", "success"); } 
                document.getElementById('preview-modal').classList.remove('active'); toggleBodyScroll(false); hidePublishForm(); loadHomeContent(); 
            } catch (err) { window.showToast("Erro: " + err.message, "error"); } finally { btn.innerHTML = oldText; btn.classList.remove('btn-loading'); }
        };
        window.confirmDelete = (id) => { window.pendingDeleteId = id; document.getElementById('delete-modal').classList.add('active'); toggleBodyScroll(true); };
        window.executeDelete = async () => { 
            const btn = document.getElementById('btn-confirm-delete'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            if(!window.pendingDeleteId) return; try { await deleteDoc(doc(db, "content", window.pendingDeleteId)); window.showToast("Exclu칤do!", "info"); showEditList(); loadHomeContent(); } catch(e){ window.showToast(e.message, "error"); } finally { btn.innerHTML = oldText; document.getElementById('delete-modal').classList.remove('active'); toggleBodyScroll(false); }
        };
        window.deleteContentForce = async (id) => { 
            if(confirm("FOR칂AR EXCLUS츾O IMEDIATA?")) { 
                try { await deleteDoc(doc(db, "content", id)); const grid = document.getElementById('edit-results-grid'); showEditList(); loadHomeContent(); window.showToast("Exclu칤do for칞adamente!", "info"); } catch(e){ console.error(e); window.showToast("Erro ao excluir: " + e.message, "error"); } 
            } 
        };
        
        window.startNewPublish = () => { window.editingId = null; document.getElementById('admin-dashboard').classList.add('hidden'); document.getElementById('publish-form-container').classList.remove('hidden'); document.getElementById('tmdb-search-block').classList.remove('hidden'); document.getElementById('main-cms-form').classList.add('hidden'); document.getElementById('form-title').textContent = "NOVA PUBLICA칂츾O"; document.getElementById('btn-publish-final').textContent = "PUBLICAR CONTE칔DO"; document.getElementById('cms-title').value = ''; document.getElementById('tmdb-search-input').value = ''; };
        window.hidePublishForm = () => { document.getElementById('publish-form-container').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };
        window.hideEditList = () => { document.getElementById('edit-list-container').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };
        window.handleLogoTap = () => { logoTapCount++; if (logoTapCount === 1) window.switchTab('home'); if (logoTapTimer) clearTimeout(logoTapTimer); logoTapTimer = setTimeout(() => { logoTapCount = 0; }, 800); if (logoTapCount >= 5) { document.getElementById('admin-auth-modal').classList.add('active'); document.getElementById('admin-pass-input').value = ''; document.getElementById('admin-pass-input').focus(); logoTapCount = 0; clearTimeout(logoTapTimer); } };
        window.checkAdminPass = (event) => { if (event.key === 'Enter') window.verifyAdmin(); };
        window.verifyAdmin = () => { if (document.getElementById('admin-pass-input').value === 'leoleo') { window.enableAdminMode(); document.getElementById('admin-auth-modal').classList.remove('active'); window.switchTab('admin'); window.showToast("Modo Admin Ativo", "success"); } else { const i = document.getElementById('admin-pass-input'); i.classList.add('border-red-500'); setTimeout(() => i.classList.remove('border-red-500'), 500); } };
        window.enableAdminMode = () => { localStorage.setItem('cinerave_admin_mode', 'true'); const adminBtn = document.getElementById('nav-admin-btn'); adminBtn.classList.remove('hidden'); adminBtn.classList.add('flex'); };
    </script>
</body>
</html>
