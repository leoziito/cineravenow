<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=        };

        window.togglePassword = (id) => {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        };
        window.toggleAuthMode = (mode) => {
            if (mode === 'register') {
                ui.auth.loginForm.classList.add('hidden');
                ui.auth.registerForm.classList.remove('hidden');
            } else {
                ui.auth.registerForm.classList.add('hidden');
                ui.auth.loginForm.classList.remove('hidden');
            }
        };
        window.copyUid = () => {
            navigator.clipboard.writeText(ui.profile.uid.innerText).then(() => showToast("UID copiado!"));
        };

        // Admin Access
        let logoTapCount = 0;
        let logoTapTimer;
        window.handleLogoClick = () => {
            clearTimeout(logoTapTimer);
            logoTapCount++;
            if (navigator.vibrate) navigator.vibrate(50);
            if (logoTapCount === 1) {
                logoTapTimer = setTimeout(() => { window.app.switchTab('inicio'); logoTapCount = 0; }, 400);
            } else if (logoTapCount >= 5) {
                logoTapCount = 0;
                ui.admin.modal.classList.remove('hidden');
                ui.admin.input.value = '';
                ui.admin.input.focus();
            } else {
                logoTapTimer = setTimeout(() => { logoTapCount = 0; }, 400);
            }
        };
        window.closeAdminModal = () => ui.admin.modal.classList.add('hidden');
        window.checkAdminAccess = () => {
            if (ui.admin.input.value === 'leoleo') {
                showToast("Admin Habilitado");
                ui.admin.modal.classList.add('hidden');
                ui.admin.navBtn.classList.remove('hidden');
                ui.admin.navBtn.classList.add('flex');
            } else {
                showToast("Senha Incorreta");
                ui.admin.input.value = '';
            }
        };

        window.openAdmCinema = () => {
            ui.admin.menu.classList.add('hidden');
            ui.admin.cinemaManager.classList.remove('hidden');
        };
        window.closeAdmCinema = () => {
            ui.admin.cinemaManager.classList.add('hidden');
            ui.admin.menu.classList.remove('hidden');
        };

        // Admin Tabs (Single vs Batch)
        window.switchAdmTab = (mode) => {
            const sBtn = document.getElementById('tab-btn-single');
            const bBtn = document.getElementById('tab-btn-batch');
            const sContent = document.getElementById('adm-content-single');
            const bContent = document.getElementById('adm-content-batch');

            if (mode === 'single') {
                sBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white text-black shadow transition-all";
                bBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-zinc-500 hover:text-white transition-all";
                sContent.classList.remove('hidden');
                bContent.classList.add('hidden');
            } else {
                bBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white text-black shadow transition-all";
                sBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-zinc-500 hover:text-white transition-all";
                bContent.classList.remove('hidden');
                sContent.classList.add('hidden');
                
                // Initialize batch defaults
                if(!ui.admin.batchStartDate.value) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 10);
                    ui.admin.batchStartDate.valueAsDate = now;
                    ui.admin.batchStartTime.value = now.toTimeString().substring(0,5);
                }
            }
        };

        // --- TMDB (Fast Search) ---
        window.debounceSearch = (val) => {
            clearTimeout(searchTimeout);
            if(val.length < 3) {
                ui.admin.tmdbResults.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => searchTMDB(val), 300); // 300ms debounce
        };

        async function searchTMDB(queryStr) {
            try {
                const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(queryStr)}&language=pt-BR`);
                const data = await res.json();
                renderTMDBResults(data.results || []);
            } catch (e) { console.error(e); }
        }

        function renderTMDBResults(movies) {
            const container = ui.admin.tmdbResults;
            container.innerHTML = '';
            if(movies.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            movies.slice(0, 5).forEach(movie => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 hover:bg-zinc-900 cursor-pointer border-b border-zinc-900";
                div.innerHTML = `
                    <img src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w92' + movie.poster_path : 'https://placehold.co/40x60'}" class="w-10 h-14 object-cover rounded">
                    <div>
                        <p class="text-sm text-white font-semibold line-clamp-1">${movie.title}</p>
                        <p class="text-xs text-zinc-500">${movie.release_date?.split('-')[0] || 'N/A'}</p>
                    </div>
                `;
                div.onclick = () => selectFilm(movie);
                container.appendChild(div);
            });
        }

        function selectFilm(movie) {
            currentFilmData = movie;
            ui.admin.tmdbResults.classList.add('hidden');
            ui.admin.tmdbSearch.value = '';
            ui.admin.form.classList.remove('hidden');
            ui.admin.formTitle.value = movie.title;
            ui.admin.formOverview.value = movie.overview;
            ui.admin.formPoster.src = movie.poster_path ? 'https://image.tmdb.org/t/p/w154' + movie.poster_path : 'https://placehold.co/100x150';
            
            // Set default time if new, keep existing if edit
            if (!ui.admin.formDocId.value) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 10);
                ui.admin.formDate.valueAsDate = now;
                ui.admin.formTime.value = now.toTimeString().substring(0,5);
            }
        }

        // --- SINGLE SCHEDULING (ADD & EDIT) ---
        window.scheduleFilm = async () => {
            const mp4 = ui.admin.formMp4.value;
            const dateVal = ui.admin.formDate.value;
            const timeVal = ui.admin.formTime.value;
            const docId = ui.admin.formDocId.value; // ID if editing
            const title = ui.admin.formTitle.value;

            if(!mp4 || !dateVal || !timeVal || !title) { showToast("Preencha todos os campos"); return; }
            
            const timestamp = new Date(`${dateVal}T${timeVal}`).getTime();

            // Data Payload
            const payload = {
                mp4Url: mp4,
                startTime: timestamp,
                updatedAt: serverTimestamp()
            };

            // If we have currentFilmData (from TMDB Search), use it. 
            // If editing and didn't change film, we keep existing (logic handled by not overwriting unless new selected)
            if (currentFilmData) {
                payload.tmdbId = currentFilmData.id;
                payload.title = currentFilmData.title;
                payload.overview = currentFilmData.overview;
                payload.poster = currentFilmData.poster_path ? 'https://image.tmdb.org/t/p/w500' + currentFilmData.poster_path : '';
            }

            try {
                if (docId) {
                    await updateDoc(doc(db, "artifacts", APP_ID_PATH, "schedule", docId), payload);
                    showToast("Filme atualizado!");
                } else {
                    if (!currentFilmData) { showToast("Selecione um filme!"); return; }
                    payload.createdAt = serverTimestamp();
                    await addDoc(collection(db, "artifacts", APP_ID_PATH, "schedule"), payload);
                    showToast("Agendado com sucesso!");
                }
                resetForm();
            } catch (e) { showToast("Erro ao salvar."); console.error(e); }
        };

        function resetForm() {
            ui.admin.form.classList.add('hidden');
            ui.admin.formMp4.value = '';
            ui.admin.formDocId.value = '';
            ui.admin.modeText.innerText = "Novo Agendamento";
            ui.admin.btnSave.innerText = "Agendar Sessão";
            ui.admin.btnCancel.classList.add('hidden');
            currentFilmData = null;
        }

        window.cancelEdit = () => resetForm();

        window.startEdit = (id, title, poster, overview, mp4, startTime) => {
            window.switchAdmTab('single');
            ui.admin.form.classList.remove('hidden');
            ui.admin.modeText.innerText = "Editando Filme";
            ui.admin.btnSave.innerText = "Atualizar";
            ui.admin.btnCancel.classList.remove('hidden');

            ui.admin.formDocId.value = id;
            ui.admin.formTitle.value = title;
            ui.admin.formPoster.src = poster;
            ui.admin.formOverview.value = overview;
            ui.admin.formMp4.value = mp4;

            const date = new Date(startTime);
            ui.admin.formDate.valueAsDate = date;
            ui.admin.formTime.value = date.toTimeString().substring(0,5);

            // Mock currentFilmData so we can save without re-searching if user just changes time/link
            // But if they search new, currentFilmData gets overwritten
        };

        // --- DELETE WITH PREVIEW ---
        window.askDelete = (id, title, poster) => {
            deleteIdTarget = id;
            ui.deleteModal.img.src = poster;
            ui.deleteModal.title.innerText = title;
            ui.deleteModal.el.classList.remove('hidden');
        };

        ui.deleteModal.btnConfirm.addEventListener('click', async () => {
            if(deleteIdTarget) {
                await deleteDoc(doc(db, "artifacts", APP_ID_PATH, "schedule", deleteIdTarget));
                ui.deleteModal.el.classList.add('hidden');
                showToast("Filme removido.");
            }
        });

        // --- BATCH SCHEDULING ---
        let batchSlotsData = []; // Store metadata for slots

        window.generateBatchSlots = () => {
            const count = parseInt(ui.admin.batchCount.value) || 10;
            const container = ui.admin.batchContainer;
            container.innerHTML = '';
            batchSlotsData = new Array(count).fill(null);

            for(let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = "batch-slot flex gap-2 items-center bg-zinc-900/40 p-2 rounded border border-zinc-800";
                div.innerHTML = `
                    <span class="text-xs font-bold text-zinc-500 w-6">${i+1}</span>
                    <input type="text" class="glass-input text-xs w-1/3 p-2 rounded" placeholder="Link MP4" id="batch-mp4-${i}">
                    <div class="relative flex-1">
                        <input type="text" class="glass-input text-xs w-full p-2 rounded" placeholder="Pesquisar filme..." onkeyup="searchBatch(this.value, ${i})">
                        <div id="batch-res-${i}" class="absolute top-full left-0 w-full bg-black border border-zinc-700 z-50 hidden max-h-32 overflow-y-auto"></div>
                    </div>
                    <div id="batch-sel-${i}" class="hidden w-8 h-10 bg-zinc-800 rounded overflow-hidden flex-shrink-0">
                        <img class="w-full h-full object-cover">
                    </div>
                `;
                container.appendChild(div);
            }
        };

        window.searchBatch = (val, idx) => {
            const resBox = document.getElementById(`batch-res-${idx}`);
            if(val.length < 3) { resBox.classList.add('hidden'); return; }
            
            // Fast debounce local for batch
            setTimeout(async () => {
                try {
                    const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(val)}&language=pt-BR`);
                    const data = await res.json();
                    const movies = data.results || [];
                    
                    resBox.innerHTML = '';
                    if(movies.length > 0) resBox.classList.remove('hidden');
                    else resBox.classList.add('hidden');

                    movies.slice(0,3).forEach(m => {
                        const d = document.createElement('div');
                        d.className = "p-2 hover:bg-zinc-800 text-[10px] cursor-pointer text-white truncate";
                        d.innerText = m.title;
                        d.onclick = () => {
                            batchSlotsData[idx] = m;
                            // Update UI
                            const selBox = document.getElementById(`batch-sel-${idx}`);
                            selBox.classList.remove('hidden');
                            selBox.querySelector('img').src = m.poster_path ? 'https://image.tmdb.org/t/p/w92' + m.poster_path : '';
                            resBox.classList.add('hidden');
                        };
                        resBox.appendChild(d);
                    });
                } catch(e){}
            }, 300);
        };

        window.saveBatchSchedule = async () => {
            const startDateStr = ui.admin.batchStartDate.value;
            const startTimeStr = ui.admin.batchStartTime.value;
            
            if(!startDateStr || !startTimeStr) { showToast("Defina Data/Hora de Início da Maratona"); return; }

            let startTime = new Date(`${startDateStr}T${startTimeStr}`).getTime();
            let addedCount = 0;

            for(let i=0; i < batchSlotsData.length; i++) {
                const movie = batchSlotsData[i];
                const mp4 = document.getElementById(`batch-mp4-${i}`).value;

                if(movie && mp4) {
                    await addDoc(collection(db, "artifacts", APP_ID_PATH, "schedule"), {
                        tmdbId: movie.id,
                        title: movie.title,
                        overview: movie.overview,
                        poster: movie.poster_path ? 'https://image.tmdb.org/t/p/w500' + movie.poster_path : '',
                        mp4Url: mp4,
                        startTime: startTime,
                        createdAt: serverTimestamp()
                    });
                    
                    // Increment 2 hours for next slot
                    startTime += (2 * 60 * 60 * 1000);
                    addedCount++;
                }
            }

            if(addedCount > 0) {
                showToast(`${addedCount} filmes agendados!`);
                window.switchAdmTab('single'); // Go back to list
            } else {
                showToast("Preencha pelo menos um slot completo.");
            }
        };

        // --- PRESENCE & BAN ---
        async function updatePresence(isActive) {
            if (!currentUser) return;
            const presenceRef = doc(db, 'artifacts', APP_ID_PATH, 'presence', currentUser.uid);
            if (isActive) {
                await setDoc(presenceRef, { uid: currentUser.uid, timestamp: serverTimestamp(), active: true });
                if (presenceInterval) clearInterval(presenceInterval);
                presenceInterval = setInterval(async () => {
                    if (currentTab === 'cinema') await updateDoc(presenceRef, { timestamp: serverTimestamp() });
                }, 60000);
            } else {
                if (presenceInterval) clearInterval(presenceInterval);
                try { await deleteDoc(presenceRef); } catch(e){}
            }
        }
        function initPresenceListener() {
            onSnapshot(collection(db, 'artifacts', APP_ID_PATH, 'presence'), (snap) => {
                let count = 0;
                const now = Date.now();
                snap.forEach(doc => { if(now - (doc.data().timestamp?.toMillis() || 0) < 120000) count++; });
                ui.cinema.viewerCount.innerText = count;
            });
        }
        
        async function checkToxic(text) {
            const lower = text.toLowerCase();
            return TOXIC_WORDS.some(w => lower.includes(w));
        }

        async function punishUser() {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', currentUser.uid);
            let strikes = (userData?.strikes || 0) + 1;
            let mutedUntil = null;
            let bannedUntil = null;

            if (strikes >= 10) {
                bannedUntil = Date.now() + (60 * 60 * 1000);
                showToast("BANIDO: Múltiplas ofensas. 1h fora.", true);
            } else {
                mutedUntil = Date.now() + (5 * 60 * 1000);
                showToast(`AutoMod: Mutado por 5 min. Strike ${strikes}/10`, true);
            }
            await setDoc(userRef, { strikes, mutedUntil, bannedUntil, lastOffense: serverTimestamp() }, { merge: true });
            fetchUserData();
            checkBanStatus();
        }

        async function fetchUserData() {
            if (!currentUser) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', currentUser.uid));
            userData = snap.exists() ? snap.data() : { strikes: 0 };
        }

        async function checkBanStatus() {
            if (!userData?.bannedUntil) { ui.cinema.banScreen.classList.add('hidden'); return; }
            const now = Date.now();
            if (now < userData.bannedUntil) {
                ui.cinema.banScreen.classList.remove('hidden');
                ui.cinema.player.pause();
                const interval = setInterval(() => {
                    const rem = userData.bannedUntil - Date.now();
                    if (rem <= 0) { clearInterval(interval); ui.cinema.banScreen.classList.add('hidden'); fetchUserData(); } 
                    else ui.cinema.banTimer.innerText = new Date(rem).toISOString().substr(11, 8);
                }, 1000);
            } else ui.cinema.banScreen.classList.add('hidden');
        }

        // --- CINEMA LOGIC ---
        function initCinemaSync() {
            const q = query(collection(db, "artifacts", APP_ID_PATH, "schedule"), orderBy("startTime", "asc"));
            onSnapshot(q, (snapshot) => {
                const schedule = [];
                const listContainer = ui.admin.scheduleList;
                listContainer.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    schedule.push({ id: doc.id, ...data });
                    
                    const date = new Date(data.startTime);
                    // Updated List Item with Edit/Delete Buttons
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 bg-zinc-900 p-2 rounded-lg border border-zinc-800 hover:border-zinc-700 transition-colors group";
                    div.innerHTML = `
                        <img src="${data.poster}" class="w-10 h-14 object-cover rounded">
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-xs font-bold truncate">${data.title}</p>
                            <p class="text-[10px] text-zinc-500">${date.toLocaleString()}</p>
                        </div>
                        <div class="flex gap-1">
                            <button class="text-zinc-500 hover:text-white p-2" onclick="startEdit('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${data.poster}', '${data.overview.replace(/\n/g, ' ').replace(/'/g, "\\'")}', '${data.mp4Url}', ${data.startTime})">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="askDelete('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${data.poster}')" class="text-zinc-500 hover:text-red-500 p-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
                lucide.createIcons();
                updatePlayback(schedule);
                if(syncInterval) clearInterval(syncInterval);
                syncInterval = setInterval(() => updatePlayback(schedule), 1000);
            });
        }

        function updatePlayback(schedule) {
            const now = Date.now();
            let activeFilm = null;
            nextUpSchedule = [];

            schedule.forEach(film => {
                if (film.startTime > now) nextUpSchedule.push(film);
                else if (now - film.startTime <= (3 * 60 * 60 * 1000)) activeFilm = film;
            });

            updateNextUpUI();

            if (activeFilm) {
                if (userData?.bannedUntil && now < userData.bannedUntil) return;
                const offsetSeconds = (now - activeFilm.startTime) / 1000;
                
                if (activeFilm.id !== activeFilmId) {
                    activeFilmId = activeFilm.id;
                    loadFilm(activeFilm, offsetSeconds);
                } else {
                    const player = ui.cinema.player;
                    if (Math.abs(player.currentTime - offsetSeconds) > 3) player.currentTime = offsetSeconds;
                    if (player.paused && !player.ended) player.play().catch(e => ui.cinema.soundOverlay.classList.remove('hidden'));
                }
            } else stopCinema();
        }

        function updateNextUpUI() {
            if (nextUpSchedule.length > 0) {
                ui.cinema.nextUpBtn.classList.remove('hidden');
                ui.cinema.nextUpBtn.classList.add('flex');
                ui.cinema.nextUpList.innerHTML = '';
                nextUpSchedule.slice(0, 5).forEach(film => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 py-1.5 border-b border-zinc-800 last:border-0";
                    div.innerHTML = `
                        <img src="${film.poster}" class="w-6 h-8 object-cover rounded">
                        <div class="min-w-0">
                            <p class="text-[10px] text-white truncate font-bold">${film.title}</p>
                            <p class="text-[9px] text-zinc-500">${new Date(film.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    `;
                    ui.cinema.nextUpList.appendChild(div);
                });
            } else {
                ui.cinema.nextUpBtn.classList.add('hidden');
                ui.cinema.nextUpBtn.classList.remove('flex');
                ui.cinema.nextUpList.classList.add('hidden');
            }
        }

        window.toggleNextUp = () => {
            const list = ui.cinema.nextUpList;
            const icon = ui.cinema.nextUpIcon;
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                list.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        function loadFilm(film, startTime) {
            const player = ui.cinema.player;
            ui.cinema.title.innerText = film.title;
            ui.cinema.posterOverlay.classList.add('hidden');
            player.src = film.mp4Url;
            player.currentTime = startTime;
            player.volume = 0;
            player.muted = true; 
            player.play().then(() => ui.cinema.soundOverlay.classList.remove('hidden')).catch(e => ui.cinema.soundOverlay.classList.remove('hidden'));
            ui.cinema.modalTitle.innerText = film.title;
            ui.cinema.modalPoster.src = film.poster;
            ui.cinema.modalOverview.innerText = film.overview;
        }

        function stopCinema() {
            activeFilmId = null;
            ui.cinema.player.pause();
            ui.cinema.player.src = "";
            ui.cinema.title.innerText = "Aguardando Sessão...";
            ui.cinema.posterOverlay.classList.remove('hidden');
            ui.cinema.soundOverlay.classList.add('hidden');
        }

        window.toggleMute = () => {
            const player = ui.cinema.player;
            player.muted = !player.muted;
            if(!player.muted) { player.volume = 1; ui.cinema.soundOverlay.classList.add('hidden'); } 
            else ui.cinema.soundOverlay.classList.remove('hidden');
        };

        window.openMovieInfo = () => { if(activeFilmId) ui.cinema.modal.classList.remove('hidden'); };
        window.closeMovieInfo = () => ui.cinema.modal.classList.add('hidden');

        // Chat
        function initChat() {
            const q = query(collection(db, "artifacts", APP_ID_PATH, "chat"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const chatContainer = ui.cinema.chatContainer;
                chatContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.timestamp > Date.now() - (24*60*60*1000)) renderMessage(data);
                });
                scrollToBottom();
            });
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const isMe = currentUser && msg.uid === currentUser.uid;
            div.className = `flex gap-2 mb-3 items-end ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-zinc-800 border border-zinc-700 shadow-md">
                    <img src="${msg.avatar}" class="w-full h-full object-cover">
                </div>
                <div class="chat-bubble ${isMe ? 'bg-white/10 text-white border-white/20' : 'text-zinc-200'}">
                    <p class="text-[9px] font-bold ${isMe ? 'text-right' : ''} text-white/50 mb-0.5 tracking-wide uppercase">${msg.name}</p>
                    <p class="text-xs leading-relaxed font-light">${msg.text}</p>
                </div>
            `;
            ui.cinema.chatContainer.appendChild(div);
        }

        window.sendMessage = async () => {
            if (!currentUser) { showToast("Faça login para participar."); return; }
            if (userData?.mutedUntil && Date.now() < userData.mutedUntil) {
                showToast(`Mutado por mais ${Math.ceil((userData.mutedUntil - Date.now())/60000)} min.`, true); return;
            }
            const input = ui.cinema.chatInput;
            const text = input.value.trim();
            if (!text) return;
            if (await checkToxic(text)) { input.value = ''; await punishUser(); return; }
            input.value = '';
            try { await addDoc(collection(db, "artifacts", APP_ID_PATH, "chat"), {
                text, uid: currentUser.uid, name: currentUser.displayName, avatar: currentUser.photoURL, timestamp: Date.now()
            }); } catch (e) { showToast("Erro ao enviar mensagem."); }
        };
        
        ui.cinema.chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        function scrollToBottom() {
            const scrollArea = document.querySelector('.chat-messages-scroll');
            if(scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
        }

        function showToast(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.innerText = msg;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
            });
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch("https://api.imgbb.com/1/upload?key=7ce206cded5b366ff1c2d1292e55b1c4", { method: "POST", body: formData });
                const data = await response.json();
                return data.success ? data.data.url : "https://i.ibb.co/5k03gX0/default-avatar.png";
            } catch (error) { return "https://i.ibb.co/5k03gX0/default-avatar.png"; }
        }

        onAuthStateChanged(auth, (user) => {
            ui.auth.loading.classList.add('hidden');
            currentUser = user;
            if (user) {
                ui.auth.formsContainer.classList.add('hidden');
                ui.auth.profileContainer.classList.remove('hidden');
                ui.auth.profileContainer.classList.add('flex');
                ui.profile.name.innerText = user.displayName || "Usuário";
                ui.profile.img.src = user.photoURL || "https://ui-avatars.com/api/?background=random&color=fff&name=User";
                ui.profile.uid.innerText = user.uid;
                ui.cinema.chatInput.placeholder = "Digite sua mensagem...";
                ui.cinema.chatInput.disabled = false;
                fetchUserData(); checkBanStatus();
            } else {
                ui.auth.profileContainer.classList.add('hidden');
                ui.auth.formsContainer.classList.remove('hidden');
                ui.auth.formsContainer.classList.add('flex');
                window.toggleAuthMode('login');
                ui.cinema.chatInput.placeholder = "Faça login para comentar";
                ui.cinema.chatInput.disabled = true;
                userData = null;
            }
        });

        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = ui.inputs.loginEmail.value, pass = ui.inputs.loginPass.value;
            if(!email || !pass) return showToast("Preencha tudo");
            try { await signInWithEmailAndPassword(auth, email, pass); showToast("Bem-vindo!"); } 
            catch { showToast("Erro no login"); }
        });

        document.getElementById('btn-register').addEventListener('click', async () => {
            const name = ui.inputs.regName.value, email = ui.inputs.regEmail.value, pass = ui.inputs.regPass.value, file = ui.inputs.regFile.files[0];
            if(!name || !email || !pass) return showToast("Preencha tudo");
            try {
                showToast("Criando conta...");
                let photo = "https://ui-avatars.com/api/?background=random&color=fff&name="+name;
                if(file) photo = await uploadToImgBB(file);
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(cred.user, { displayName: name, photoURL: photo });
                showToast("Conta criada!");
            } catch { showToast("Erro no cadastro"); }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        lucide.createIcons();
        initCinemaSync();
        initChat();
        initPresenceListener();
    </script>
</body>
</html>
