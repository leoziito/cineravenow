<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINERAVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding-top: 56px;
            padding-bottom: 64px;
            min-height: 100vh;
        }
        /* Otimização: Esconder scrollbar no corpo para estética em alguns navegadores */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; } 

        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            background-color: #000;
            overflow-y: auto; 
        }
        #sidebar.open { transform: translateX(0); }
        #content-wrapper {
            padding: 1rem;
            min-height: calc(100vh - 56px - 64px);
            background-color: #000;
            overflow-y: auto; 
        }
        .modal-backdrop { 
             background-color: rgba(0, 0, 0, 0.9);
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 1rem; 
        }
        #bottom-nav, header { background-color: #000; border: none !important; }
        
        header { justify-content: center; }
        #cinerave-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        header button#menuButton {
             position: absolute;
             left: 1rem;
        }
        header button#profileButton {
             position: absolute;
             right: 1rem;
        }


        .btn-gradient {
            background: linear-gradient(145deg, #ffffff, #888888);
            color: #000;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.1), 0 2px 4px -2px rgba(255, 255, 255, 0.06);
        }
        .btn-gradient:hover {
            background: linear-gradient(145deg, #eeeeee, #aaaaaa);
        }
        .btn-gradient:disabled {
            background: #222;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-dark {
            background-color: #111;
            color: #fff;
            border: 1px solid #333;
        }
        .input-dark:focus {
            border-color: #fff;
            outline: none;
        }

        #tmdb-suggestions {
            max-height: 400px;
            overflow-y: auto;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
        }
        .suggestion-item:hover {
            background-color: #333;
        }
        .tmdb-suggestion-poster {
            width: 32px;
            height: 48px;
            object-fit: cover;
            flex-shrink: 0;
            margin-right: 12px;
        }
        
        .modal-content-scroll {
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        }

        .carousel-item-card {
            scroll-snap-align: start;
            width: 100%;
        }
        .carousel-container {
            display: flex;
            overflow-x: scroll;
            padding-bottom: 10px;
        }
        
        .content-poster-wrapper {
             width: 100%;
             padding-bottom: 150%; 
             position: relative;
             overflow: hidden;
        }
        .content-poster-only {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        .banner-container {
            height: 320px;
            background-color: #111;
        }
        .tag-base {
            position: absolute;
            font-size: 9px; 
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
            top: 4px; 
        }
        .tag-base:first-child { 
             left: 4px; 
        }
        .tag-base:nth-child(2) { 
             right: 4px; 
        }
        .rating-star:hover {
            cursor: pointer;
        }
        
        /* Otimização: Aumento da densidade de posters em Minha Lista e Grades */
        #my-list-container.grid {
             grid-template-columns: repeat(3, minmax(0, 1fr));
             gap: 0.75rem; 
        }
        #surprisePage #grid-content-container,
        #explore-grid-container {
             grid-template-columns: repeat(3, minmax(0, 1fr));
             gap: 0.75rem; 
        }
        
        @media (min-width: 640px) { 
            #my-list-container.grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
            #surprisePage #grid-content-container,
            #explore-grid-container {
                 grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        @media (min-width: 768px) { 
            #explore-grid-container {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }
            #my-list-container.grid {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }
            #surprisePage #grid-content-container {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }
        }
        @media (min-width: 1024px) { 
            #explore-grid-container {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
            #my-list-container.grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
             #surprisePage #grid-content-container {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }
        
        .actor-image {
            width: 80px; 
            height: 80px; 
            object-fit: cover; 
            border-radius: 9999px; 
            margin-left: auto;
            margin-right: auto;
        }
        
        .meta-info-box {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            border-radius: 0.5rem;
            background-color: #111;
        }
        
        #scroll-to-top {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 50;
            background-color: #fff; 
            color: #000; 
            border-radius: 50%;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .episode-schedule-fields {
            background-color: #000;
            padding: 8px;
            border-radius: 0.5rem;
            margin-top: 5px;
        }

        .premium-tab-button.active {
            background-color: #FACC15;
            color: #000;
        }
    </style>
</head>
<body class="bg-black text-white">

    <header class="fixed top-0 left-0 right-0 h-14 z-30 flex items-center justify-between px-4">
        <button id="menuButton" class="text-white text-xl p-2 rounded-full hover:bg-white/10 transition duration-150">
            <i class="fas fa-bars"></i>
        </button>
        <div id="cinerave-title" class="text-2xl font-black text-white tracking-widest">
            CINERAVE+
        </div>
        
        <button id="profileButton" onclick="showProfileModal()" class="text-white text-xl p-2 rounded-full hover:bg-white/10 transition duration-150">
            <img id="profile-img-header" src="https://placehold.co/32x32/111/FFF?text=?" class="w-8 h-8 rounded-full object-cover border border-white/50" onerror="this.src='https://placehold.co/32x32/111/FFF?text=?'">
        </button>
    </header>

    <div id="sidebar-backdrop" class="fixed inset-0 modal-backdrop z-40 hidden" onclick="closeSidebar()"></div>

    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-black shadow-2xl z-50 rounded-r-lg flex flex-col justify-between overflow-y-auto">
        <div class="p-6 pt-16">
            <nav class="space-y-4">
                <button onclick="showMyListModal(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-list-ul mr-3 w-5 text-center"></i> MINHA LISTA
                </button>
                <button id="toggle-history-btn" onclick="toggleWatchHistory(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-history mr-3 w-5 text-center"></i> DESATIVAR HISTÓRICO
                </button>
                <button onclick="showLinkModal(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-link mr-3 w-5 text-center"></i> VINCULAR
                </button>
                
                <hr class="border-white/10 my-4">

                <button onclick="showStoreModal(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center text-yellow-500 font-bold">
                    <i class="fas fa-store mr-3 w-5 text-center"></i> PREMIUM
                </button>

                <button id="nav-premium-catalog" onclick="switchTab('premiumPage', 'drive'); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center hidden text-yellow-300">
                    <i class="fas fa-crown mr-3 w-5 text-center"></i> CATÁLOGO PREMIUM
                </button>

                <hr class="border-white/10 my-4">

                <a href="https://livepix.gg/cinerave" target="_blank" onclick="closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-heart mr-3 w-5 text-center text-red-500"></i> DOAÇÃO
                </a>

                <a href="https://chat.whatsapp.com/Lidb3f8U9SsDe10kiLVICR" target="_blank" onclick="closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fab fa-whatsapp mr-3 w-5 text-center text-green-500"></i> PEDIDOS
                </a>
                
                <button onclick="showLegalModal(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3 w-5 text-center text-yellow-500"></i> AVISO LEGAL
                </button>
                
                <hr class="border-white/10 my-4">

                <button onclick="showAdminPasswordModal(); closeSidebar()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i class="fas fa-lock mr-3 w-5 text-center"></i> ACESSO RESTRITO 
                </button>

                <button id="auth-button" onclick="handleAuthClick()" class="text-white hover:bg-white/10 p-3 rounded-lg transition duration-150 w-full text-left font-semibold tracking-wide flex items-center">
                    <i id="auth-icon" class="fas fa-sign-in-alt mr-3 w-5 text-center"></i> ENTRAR / SAIR
                </button>
            </nav>
        </div>

        <div class="p-6 pb-4 text-center text-white/50 text-xs flex-shrink-0">
            <p class="font-bold">Desenvolvido por Leonardo</p>
            <p class="mt-1 mb-2 text-sm font-light" id="app-version">V1.20</p>
            <div class="text-xs break-all leading-relaxed opacity-70">
                UID: <span id="user-info">Aguardando...</span>
            </div>
        </div>
    </aside>

    <main id="content-wrapper" class="bg-black overflow-y-auto">
        <div class="h-full">
            <section id="homePage" class="tab-content h-full">
                <div id="home-content-container" class="space-y-8">
                    <div id="main-banner-container" class="my-4"></div>
                    
                    <p class="text-white/50 text-center mt-20" id="feed-loading-message">Carregando conteúdo...</p>

                    <div id="carousels-container">
                    </div>
                </div>
            </section>
            
            <section id="surprisePage" class="tab-content hidden h-full p-4 space-y-6">
                <!-- Conteúdo da grade de Ver Mais é renderizado aqui -->
            </section>

            <section id="comingSoonPage" class="tab-content hidden h-full p-4 space-y-6">
                <h2 class="text-3xl font-bold text-white text-center mb-6">EM BREVE</h2>
                <div id="coming-soon-grid-container" class="grid gap-3 grid-cols-2 sm:grid-cols-3 md:grid-cols-4">
                </div>
                <p id="coming-soon-no-results" class="text-white/50 text-center mt-12 hidden">
                    Nenhum lançamento agendado.
                </p>
            </section>


            <section id="explorePage" class="tab-content hidden h-full p-4 space-y-6">
    
                <h2 class="text-3xl font-bold text-white text-center">EXPLORAR</h2>
                
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-white/50">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="search" id="explore-search-input" class="w-full p-3 pl-12 input-dark rounded-xl" placeholder="Buscar por título..."/>
                </div>

                <p class="text-center text-white/60 text-sm">
                    Total de <span id="explore-total-count" class="font-bold text-white">0</span> títulos publicados.
                </p>

                <div class="flex justify-center space-x-2">
                    <button class="explore-type-filter flex-grow p-3 bg-white text-black rounded-lg font-bold" data-type="all">
                        Ver Tudo
                    </button>
                    <button class="explore-type-filter flex-grow p-3 bg-white/10 text-white rounded-lg font-bold" data-type="movie">
                        Filmes
                    </button>
                    <button class="explore-type-filter flex-grow p-3 bg-white/10 text-white rounded-lg font-bold" data-type="tv">
                        Séries
                    </button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    
                    <select id="explore-genre-filter" class="w-full p-3 input-dark rounded-lg">
                        <option value="all">Todos os Gêneros</option>
                        </select>
                    
                    <select id="explore-year-filter" class="w-full p-3 input-dark rounded-lg">
                        <option value="all">Todos os Anos</option>
                        </select>
                    
                    <select id="explore-sort-filter" class="w-full p-3 input-dark rounded-lg col-span-2 md:col-span-1">
                        <option value="recent">Mais Recentes</option>
                        <option value="az">Ordem A-Z</option>
                        <option value="rating">Melhor Avaliado</option>
                        <option value="views">Mais Vistos</option>
                        </select>
                </div>
                
                <button id="explore-clear-filters" class="w-full p-2 text-sm text-white/60 hover:text-white transition hidden">
                    <i class="fas fa-times-circle mr-1"></i> Limpar filtros
                </button>

                <div id="explore-grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-16">
                    </div>
                
                <p id="explore-no-results" class="text-white/50 text-center mt-12 hidden">
                    Nenhum conteúdo encontrado com esses filtros.
                </p>
                
                <h3 class="text-xl font-bold text-yellow-400 text-center mt-8">CATÁLOGO PREMIUM COMPLETO</h3>
                <div id="premium-explore-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-16">
                </div>
            </section>

            <section id="premiumPage" class="tab-content hidden h-full p-4 space-y-6">
                <h2 class="text-3xl font-bold text-yellow-300 text-center">CATÁLOGO PREMIUM</h2>

                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-white/50">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="search" id="premium-search-input" class="w-full p-3 pl-12 input-dark rounded-xl" placeholder="Buscar no Catálogo Premium..."/>
                </div>

                <div class="flex justify-center space-x-2">
                    <button id="premium-tab-drive" class="premium-tab-button flex-grow p-3 bg-white/10 text-white rounded-lg font-bold" data-seal="drive">
                        Drives
                    </button>
                    <button id="premium-tab-telegram" class="premium-tab-button flex-grow p-3 bg-white/10 text-white rounded-lg font-bold" data-seal="telegram">
                        Telegram
                    </button>
                    <button id="premium-tab-exclusive" class="premium-tab-button flex-grow p-3 bg-white/10 text-white rounded-lg font-bold" data-seal="premium">
                        Exclusivos
                    </button>
                </div>
                
                <p id="premium-access-warning" class="text-red-500 text-center font-bold hidden">
                    <i class="fas fa-lock mr-2"></i> Conteúdo bloqueado. Você precisa ser Premium para acessar.
                </p>

                <div id="premium-grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-16">
                </div>
                
                <p id="premium-no-results" class="text-white/50 text-center mt-12 hidden">
                    Nenhum conteúdo encontrado com esse selo ou busca.
                </p>
            </section>


            <section id="adminPage" class="tab-content hidden p-6 space-y-8">
                <h1 class="text-3xl font-bold text-white text-center">PAINEL ADMIN</h1>

                <div class="space-y-4 max-w-sm mx-auto">
                    <button onclick="showPublishModal()" class="w-full p-4 rounded-xl font-bold shadow-lg btn-gradient">
                        PUBLICAR NOVO CONTEÚDO
                    </button>
                    <button onclick="loadContentToEdit()" class="w-full p-4 rounded-xl font-bold shadow-lg btn-gradient" id="btn-load-edit">
                        EDITAR CONTEÚDO / RASCUNHO
                    </button>
                    <button onclick="loadReports()" class="w-full p-4 rounded-xl font-bold shadow-lg btn-gradient">
                        VER RELATÓRIOS (REPORTS)
                    </button>
                </div>

                <div id="edit-list-container" class="space-y-4 pt-8 hidden max-w-lg mx-auto">
                    <h3 class="text-xl font-bold border-b border-white/20 pb-2 mb-4">Conteúdo Publicado / Rascunho</h3>
                    
                    <input type="search" id="admin-search-input" class="w-full p-3 input-dark rounded-lg" placeholder="Buscar conteúdo para editar/excluir..."/>

                    <div id="published-content-list" class="space-y-4 max-h-96 overflow-y-auto pt-2">
                        <p class="text-white/50 text-center">Carregando conteúdo...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <button id="scroll-to-top" class="fixed hidden items-center justify-center" onclick="contentWrapper.scrollTo({ top: 0, behavior: 'smooth' })" title="Voltar ao Topo">
        <i class="fas fa-arrow-up text-xl"></i>
    </button>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-16 bg-black z-30 flex justify-around items-center">
        <button id="nav-home" class="nav-item flex flex-col items-center justify-center p-2 text-white transition duration-200 font-semibold text-sm" data-page="homePage">
            <i class="fas fa-home text-xl"></i>
            INÍCIO
        </button>

        <button id="nav-explore" class="nav-item flex flex-col items-center justify-center p-2 text-white/50 hover:text-white transition duration-200 font-semibold text-sm" data-page="explorePage">
            <i class="fas fa-search text-xl"></i>
            EXPLORAR
        </button>
    </nav>
    
    <div id="details-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center overflow-y-auto p-0">
        <div id="details-modal-content" class="bg-black w-full h-full sm:max-w-3xl sm:max-h-[90vh] sm:rounded-xl shadow-2xl overflow-y-auto">
            
            <div class="relative w-full h-56 bg-cover bg-center" style="background-color: #111;">
                <img id="details-banner-img" src="https://placehold.co/800x450/111/FFF?text=BANNER" class="w-full h-full object-cover opacity-50" onerror="this.src='https://placehold.co/800x450/111/FFF?text=BANNER'"/>
                
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-black/80"></div>

                <button onclick="hideDetailsModal()" class="absolute top-4 left-4 text-white text-2xl p-2 rounded-full bg-black/50 hover:bg-black/80 transition z-20">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>

            <div class="relative -mt-20 p-4 sm:p-6 pt-0">
                <div class="flex flex-col sm:flex-row items-start sm:items-end">
                    <img id="details-poster-img" src="https://placehold.co/150x225/111/FFF?text=POSTER" class="w-28 h-40 object-cover rounded-lg shadow-2xl border-2 border-white/50 z-10 mx-auto sm:mx-0 sm:mt-0" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                    
                    <div class="ml-0 sm:ml-4 flex-grow z-10 mt-4 sm:mt-0 text-center"> 
                        <h2 id="details-title" class="text-2xl sm:text-3xl font-bold">Título do Conteúdo</h2>
                        <p id="details-meta" class="text-sm text-white/60 mt-1">Filme • 2024 • Gêneros</p>
                        <p id="details-avg-rating" class="text-sm text-yellow-500 font-bold mt-1">⭐ 0.0 (0 avaliações)</p>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 mt-6">
                    <div class="meta-info-box w-full sm:w-auto sm:flex-1 sm:max-w-[40%]">
                        <div class="text-center flex-1">
                            <p id="details-view-count" class="font-bold text-lg">0</p>
                            <p class="text-xs text-white/60">Visualizações</p>
                        </div>
                        <div class="text-center flex-1 border-x border-white/20">
                            <p id="details-rating-count" class="font-bold text-lg">0</p>
                            <p class="text-xs text-white/60">Avaliações</p>
                        </div>
                    </div>

                    <div class="flex justify-center sm:justify-end space-x-3 w-full sm:w-auto sm:flex-1 sm:max-w-[55%]">
                        <button id="details-btn-lista" class="p-3 bg-white/10 text-white rounded-xl font-bold hover:bg-white/20 transition flex items-center justify-center w-1/4 sm:w-auto">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button id="details-btn-trailer" class="p-3 bg-white/10 text-white rounded-xl font-bold hover:bg-white/20 transition flex items-center justify-center w-1/4 sm:w-auto">
                            <i class="fas fa-film"></i>
                        </button>
                        <button id="details-btn-link" onclick="copyDeepLink()" class="p-3 bg-white/10 text-white rounded-xl font-bold hover:bg-white/20 transition flex items-center justify-center w-1/4 sm:w-auto">
                            <i class="fas fa-link"></i>
                        </button>
                        <button id="details-btn-assistir-movie" class="flex-grow p-3 btn-gradient rounded-xl font-bold flex items-center justify-center w-full sm:w-1/2 hidden">
                            <i class="fas fa-play mr-2"></i> ASSISTIR
                        </button>
                    </div>
                </div>
                
                <p id="details-sinopse" class="text-sm text-white/80 mt-6 leading-relaxed">Sinopse detalhada do conteúdo...</p>
                
                <div class="mt-8 p-4 bg-white/5 rounded-xl">
                    <h3 class="font-bold text-lg mb-3">Sua Avaliação</h3>
                    <div id="rating-stars-input" class="flex justify-center space-x-1 text-2xl text-yellow-500 mb-3">
                        <i class="far fa-star rating-star transition duration-100" data-value="1" onclick="setStarRating(1)"></i>
                        <i class="far fa-star rating-star transition duration-100" data-value="2" onclick="setStarRating(2)"></i>
                        <i class="far fa-star rating-star transition duration-100" data-value="3" onclick="setStarRating(3)"></i>
                        <i class="far fa-star rating-star transition duration-100" data-value="4" onclick="setStarRating(4)"></i>
                        <i class="far fa-star rating-star transition duration-100" data-value="5" onclick="setStarRating(5)"></i>
                    </div>
                    <textarea id="rating-comment" class="w-full p-2 input-dark rounded-lg text-sm" placeholder="Adicione um comentário (Opcional)"></textarea>
                    
                    <div class="flex flex-col sm:flex-row justify-center sm:justify-between items-center mt-3">
                        <button id="details-btn-ver-avaliacoes" class="text-sm text-white/60 hover:text-white block mb-2 sm:mb-0">Ver todas avaliações</button> 
                        <div class="flex space-x-3 items-center">
                            <button id="details-btn-submit-rating" class="px-4 py-2 btn-gradient rounded-lg font-bold text-sm flex items-center">
                                ENVIAR
                            </button>
                            <button id="details-btn-my-rating" class="px-4 py-2 bg-yellow-600 text-white rounded-lg font-bold text-sm flex items-center hidden">
                                 MINHA AVALIAÇÃO
                            </button>
                        </div>
                    </div>
                </div>

                <div id="details-episodes-container" class="mt-8 hidden">
                    <h3 class="font-bold text-lg mb-4 border-b border-white/20 pb-2">Episódios</h3>
                </div>
                
                <h3 class="font-bold text-lg mb-3 mt-8 border-b border-white/20 pb-2">Elenco Principal</h3>
                <div id="details-actors-carousel" class="flex overflow-x-scroll space-x-3 pb-4">
                </div>
                
                <div class="mt-8 text-center pb-6">
                     <button id="details-btn-reportar" class="text-sm text-red-500 hover:text-red-400 font-medium">
                         <i class="fas fa-exclamation-circle mr-1"></i> Reportar um problema
                     </button>
                </div>
                
                <div id="similar-content-section" class="mt-4 border-t border-white/10 pt-4">
                    <h3 class="font-bold text-lg mb-4">Títulos Semelhantes</h3>
                    <div id="similar-content-carousel" class="flex overflow-x-scroll space-x-3 pb-4">
                        <p class="text-white/50">Carregando sugestões...</p>
                    </div>
                </div>
                
            </div>
        </div>
    </div>


    <div id="my-rating-modal" class="fixed inset-0 modal-backdrop z-[110] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-yellow-500 border-b border-white/20 pb-2">MINHA AVALIAÇÃO</h3>
            <div id="my-rating-content" class="space-y-4">
                <div id="my-rating-stars" class="flex justify-center space-x-1 text-3xl text-yellow-500 mb-3"></div>
                <textarea id="my-rating-comment" rows="4" class="w-full p-3 input-dark rounded-lg text-sm" placeholder="Seu comentário"></textarea>
            </div>
            
            <div class="flex justify-between pt-4">
                <button id="btn-delete-rating" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition duration-150 font-medium">
                    <i class="fas fa-trash mr-2"></i> EXCLUIR
                </button>
                <div class="flex space-x-3">
                    <button onclick="document.getElementById('my-rating-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button id="btn-update-rating" class="px-4 py-2 btn-gradient rounded-lg font-bold flex items-center justify-center">
                        <span id="update-rating-spinner" class="loading-spinner mr-2 hidden"></span>
                        SALVAR EDIÇÃO
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="ratings-modal" class="fixed inset-0 modal-backdrop z-[110] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-white border-b border-white/20 pb-2">AVALIAÇÕES</h3>
            <div id="ratings-list-container" class="space-y-4 max-h-96 overflow-y-auto pb-4">
                <p class="text-white/50 text-center">Carregando avaliações...</p>
            </div>
            <div class="flex justify-end pt-4">
                <button onclick="document.getElementById('ratings-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 modal-backdrop z-[110] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-4 text-red-500 border-b border-white/20 pb-2">REPORTAR PROBLEMA</h3>
            <p class="text-white/80 mb-4">Selecione o tipo de problema e descreva:</p>
            
            <div class="space-y-3 mb-4">
                <label class="flex items-center space-x-2">
                    <input type="radio" name="reportType" value="Link Quebrado" class="h-4 w-4 text-red-600 bg-black border-gray-300 rounded focus:ring-red-500"/>
                    <span class="text-white/80">Link Quebrado (Player offline)</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="reportType" value="Conteúdo Errado" class="h-4 w-4 text-red-600 bg-black border-gray-300 rounded focus:ring-red-500"/>
                    <span class="text-white/80">Conteúdo Errado (Sinopse/Filme Trocado)</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="reportType" value="Sugestão de Conteúdo" class="h-4 w-4 text-red-600 bg-black border-gray-300 rounded focus:ring-red-500"/>
                    <span class="text-white/80">Sugestão de Conteúdo/Melhoria</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="reportType" value="Outro" class="h-4 w-4 text-red-600 bg-black border-gray-300 rounded focus:ring-red-500"/>
                    <span class="text-white/80">Outro</span>
                </label>
            </div>

            <textarea id="report-reason" rows="4" class="w-full p-3 input-dark rounded-lg mb-6" placeholder="Descreva brevemente o problema (mínimo 10 caracteres)"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Cancelar
                </button>
                <button id="report-submit-btn" class="px-4 py-2 bg-red-700 text-white rounded-lg font-bold hover:bg-red-800 flex items-center justify-center">
                    <span id="report-spinner" class="loading-spinner mr-2 hidden"></span>
                    ENVIAR REPORTE
                </button>
            </div>
        </div>
    </div>
    
    <div id="my-list-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xl border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-white border-b border-white/20 pb-2">MINHA LISTA</h3>
            <div id="my-list-container" class="grid">
                <p class="text-white/50 text-center">Carregando sua lista...</p>
            </div>
            <div class="flex justify-end pt-4">
                <button onclick="document.getElementById('my-list-modal').classList.add('hidden'); document.body.style.overflow = '';" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <div id="reports-list-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-2xl border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-red-500 border-b border-white/20 pb-2">RELATÓRIOS RECEBIDOS</h3>
            <div id="reports-list-container" class="space-y-4 max-h-96 overflow-y-auto pb-4">
                <p class="text-white/50 text-center">Carregando relatórios...</p>
            </div>
            <div class="flex justify-end pt-4">
                <button onclick="document.getElementById('reports-list-modal').classList.add('hidden'); document.body.style.overflow = '';" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <div id="publish-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center overflow-y-auto p-4">
        <div id="publish-modal-container" class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-3xl border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-white border-b border-white/20 pb-2" id="publish-modal-title">PUBLICAR NOVO CONTEÚDO</h3>
            
            <form id="publish-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Tipo de Conteúdo:</label>
                    <select id="content-type" class="w-full p-3 input-dark rounded-lg" onchange="toggleContentForm()">
                        <option value="movie">Filme</option>
                        <option value="tv">Série</option>
                    </select>
                </div>
                
                <div class="relative">
                    <label class="block text-sm font-medium mb-2">Busca TMDb (Filme/Série):</label>
                    <input type="text" id="tmdb-search-input" class="w-full p-3 input-dark rounded-lg" placeholder="Digite o nome do conteúdo para buscar..."/>
                    <div id="tmdb-suggestions" class="absolute hidden bg-black border border-white/20 rounded-lg mt-1 shadow-lg"></div>
                </div>

                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="flex-shrink-0 w-full sm:w-40">
                        <img id="poster-preview" src="https://placehold.co/160x240/111/FFF?text=POSTER" class="w-full h-auto rounded-lg object-cover border border-white/30"/>
                        <p class="text-xs text-white/50 mt-1 text-center" id="tmdb-info-text">Nenhum TMDb selecionado</p>
                    </div>
                    <div class="flex-grow space-y-4">
                        <input type="text" id="title-input" class="w-full p-3 input-dark rounded-lg font-bold text-lg" placeholder="Título (Automático)"/>
                        <textarea id="sinopse-input" rows="4" class="w-full p-3 input-dark rounded-lg" placeholder="Sinopse (Automático)"></textarea>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="year-input" class="p-3 input-dark rounded-lg" placeholder="Ano de Lançamento (Automático)"/>
                            <input type="text" id="genres-input" class="p-3 input-dark rounded-lg" placeholder="Gêneros (Automático)"/>
                        </div>
                        <input type="text" id="actors-input" class="w-full p-3 input-dark rounded-lg" placeholder="Atores Principais (Automático)"/>
                        <input type="text" id="trailer-input" class="w-full p-3 input-dark rounded-lg" placeholder="Link do Trailer (YouTube iFrame)"/>
                        <input type="url" id="backdrop-input" class="w-full p-3 input-dark rounded-lg text-xs" placeholder="URL do Banner/Backdrop (Automático)"/>
                    </div>
                </div>

                <div class="p-4 bg-white/5 rounded-lg space-y-3">
                    <h4 class="text-lg font-bold text-white border-b border-white/20 pb-2">SELOS E QUALIDADE (Opcional)</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                         <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg">
                            <input type="checkbox" id="seal-drive" class="h-4 w-4 text-indigo-500 bg-black border-gray-300 rounded"/>
                            <span>Drive</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg">
                            <input type="checkbox" id="seal-telegram" class="h-4 w-4 text-blue-500 bg-black border-gray-300 rounded"/>
                            <span>Telegram</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg">
                            <input type="checkbox" id="seal-premium" class="h-4 w-4 text-yellow-500 bg-black border-gray-300 rounded"/>
                            <span>Premium</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg">
                            <input type="checkbox" id="seal-4k" class="h-4 w-4 text-green-500 bg-black border-gray-300 rounded"/>
                            <span>4K</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg">
                            <input type="checkbox" id="seal-cinema-quality" class="h-4 w-4 text-red-500 bg-black border-gray-300 rounded"/>
                            <span>Cinema</span>
                        </label>
                         <!-- NOVO SELO DE MANUTENÇÃO / RASCUNHO -->
                        <label class="flex items-center space-x-2 text-sm font-medium bg-black p-2 rounded-lg col-span-2">
                            <input type="checkbox" id="seal-maintenance" class="h-4 w-4 text-red-800 bg-black border-gray-300 rounded"/>
                            <span class="text-red-500 font-bold">MANUTENÇÃO (RASCUNHO)</span>
                        </label>
                    </div>
                </div>


                <div class="p-4 bg-white/5 rounded-lg space-y-3">
                    <h4 class="text-lg font-bold text-white border-b border-white/20 pb-2">AGENDAMENTO DO CONTEÚDO PRINCIPAL (Geral)</h4>
                    <label class="flex items-center space-x-3 text-sm font-medium">
                        <input type="checkbox" id="is-coming-soon-checkbox" class="h-4 w-4 text-white bg-black border-gray-300 rounded"/>
                        <span>Marcar o item principal como "Em Breve" (lançamento do filme ou 1ª temporada)</span>
                    </label>
                    <div id="release-schedule-fields" class="grid grid-cols-2 gap-4 hidden mt-3">
                        <input type="date" id="release-date-input" class="p-3 input-dark rounded-lg" title="Data de Lançamento"/>
                        <input type="time" id="release-time-input" class="p-3 input-dark rounded-lg" title="Hora de Lançamento"/>
                    </div>
                </div>
                
                <div id="movie-section" class="space-y-4 pt-4">
                    <h4 class="text-lg font-bold text-white border-b border-white/20 pb-2">LINKS DO FILME (Apenas URL)</h4>
                    <div id="movie-links-container" class="space-y-3">
                        <div class="flex items-center space-x-2">
                             <input type="url" class="movie-link-input w-full p-3 input-dark rounded-lg" placeholder="URL do Link do Filme"/>
                             <button type="button" onclick="removeLinkInput(this.parentNode)" class="text-red-500 hover:text-red-400 text-lg w-8 h-8 flex items-center justify-center">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addLinkInput('movie')" class="text-sm font-medium text-white/70 hover:text-white transition duration-150">
                        <i class="fas fa-plus mr-2"></i> Adicionar Novo Link
                    </button>
                </div>
                
                <div id="tv-section" class="space-y-4 pt-4 hidden">
                    <h4 class="text-lg font-bold text-white border-b border-white/20 pb-2">GERENCIAR TEMPORADAS E EPISÓDIOS</h4>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Número de Temporadas a Criar/Atualizar:</label>
                        <div class="flex space-x-2">
                            <input type="number" id="num-seasons-input" min="0" value="0" class="w-20 p-3 input-dark rounded-lg text-center"/>
                            <button type="button" onclick="generateSeasonForms()" class="p-3 rounded-lg font-bold btn-gradient flex-grow">
                                GERAR/ATUALIZAR TEMPORADAS
                            </button>
                        </div>
                        <small class="text-white/50 text-xs block mt-1">Se você alterar o número, as temporadas antigas serão substituídas.</small>
                    </div>

                    <div id="seasons-container" class="space-y-6">
                    </div>
                </div>

                <div class="flex justify-between pt-6">
                    <button type="button" onclick="hidePublishModal()" class="px-6 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition duration-150 font-medium">
                        CANCELAR
                    </button>
                    <button type="button" onclick="showPreviewModal()" class="px-6 py-3 btn-gradient rounded-xl font-bold flex items-center justify-center" id="btn-preview-publish">
                         PRÉ-VISUALIZAR E PUBLICAR
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="preview-modal" class="fixed inset-0 modal-backdrop z-[110] hidden items-center justify-center overflow-y-auto p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-white border-b border-white/20 pb-2">CONFIRMAR PUBLICAÇÃO</h3>
            <div id="preview-content" class="space-y-4 text-white/80 max-h-96 overflow-y-auto pb-4">
            </div>
            <div class="flex justify-between pt-6">
                <button type="button" onclick="document.getElementById('preview-modal').classList.add('hidden')" class="px-6 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition duration-150 font-medium">
                    VOLTAR E EDITAR
                </button>
                <button type="button" onclick="publishContent()" class="px-6 py-3 btn-gradient rounded-xl font-bold flex items-center justify-center" id="btn-confirm-publish">
                    <span id="publish-spinner" class="loading-spinner mr-2 hidden"></span>
                    CONFIRMAR E PUBLICAR
                </button>
            </div>
        </div>
    </div>


    <div id="link-modal" class="fixed inset-0 modal-backdrop z-[100] hidden">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">VINCULAR CONTA</h3>
            <p class="text-white/80 mb-6">Crie um perfil para vincular sua conta anônima atual.</p>
            <form id="link-form" class="space-y-4">
                <input type="text" id="link-name" class="w-full p-3 input-dark rounded-lg" placeholder="Seu Nome"/>
                <input type="email" id="link-email" class="w-full p-3 input-dark rounded-lg" placeholder="Email"/>
                
                <div class="relative">
                    <input type="password" id="link-password" class="w-full p-3 input-dark rounded-lg pr-10" placeholder="Senha"/>
                    <button type="button" class="absolute right-0 top-0 mt-3 mr-3 text-white/50 hover:text-white" onclick="togglePasswordVisibility('link-password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Foto de Perfil (ImgBB)</label>
                    <input type="file" id="link-photo-file" accept="image/*" class="w-full input-dark rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-white file:text-black hover:file:bg-gray-200" onchange="previewImage(this, 'link-photo-preview')"/>
                    <img id="link-photo-preview" class="w-20 h-20 rounded-full object-cover mt-3 border border-white/30" src="https://placehold.co/80x80/111/FFF?text=Foto" onerror="this.src='https://placehold.co/80x80/111/FFF?text=Foto'"/>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="document.getElementById('link-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 btn-gradient rounded-lg font-bold flex items-center justify-center" id="btn-link-submit">
                        <span id="link-spinner" class="loading-spinner mr-2 hidden"></span>
                        VINCULAR
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="signin-modal" class="fixed inset-0 modal-backdrop z-[100] hidden">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">ENTRAR</h3>
            <form id="signin-form" class="space-y-4">
                <input type="email" id="signin-email" class="w-full p-3 input-dark rounded-lg" placeholder="Email"/>
                
                <div class="relative">
                    <input type="password" id="signin-password" class="w-full p-3 input-dark rounded-lg pr-10" placeholder="Senha"/>
                    <button type="button" class="absolute right-0 top-0 mt-3 mr-3 text-white/50 hover:text-white" onclick="togglePasswordVisibility('signin-password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="document.getElementById('signin-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 btn-gradient rounded-lg font-bold flex items-center justify-center" id="btn-signin-submit">
                        <span id="signin-spinner" class="loading-spinner mr-2 hidden"></span>
                        ENTRAR
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="profile-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-6 text-white border-b border-white/20 pb-2">MEU PERFIL</h3>
            
            <div class="flex flex-col items-center space-y-4">
                <img id="profile-modal-photo" class="w-24 h-24 rounded-full object-cover border-2 border-white/50" src="https://placehold.co/96x96/111/FFF?text=Foto" onerror="this.src='https://placehold.co/96x96/111/FFF?text=Foto'"/>
                <p id="profile-modal-name" class="text-2xl font-bold">Nome do Usuário</p>
                <p class="text-xs text-white/50 break-all">UID: <span id="profile-modal-uid">...</span></p>
                <p id="profile-modal-email" class="text-sm text-white/70"></p>
                <p id="profile-modal-premium" class="text-sm font-bold text-red-500">GRÁTIS</p>
            </div>
            
            <div class="mt-8 space-y-3">
                <button onclick="showChangePasswordModal()" class="w-full p-3 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium flex items-center justify-center">
                    <i class="fas fa-key mr-2"></i> TROCAR SENHA
                </button>
                <button onclick="showEditPhotoModal()" class="w-full p-3 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> EDITAR FOTO
                </button>
            </div>

            <div class="flex justify-center pt-6">
                <button onclick="document.getElementById('profile-modal').classList.add('hidden'); document.body.style.overflow = '';" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <div id="store-modal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-6 text-yellow-500 border-b border-white/20 pb-2">LOJA PREMIUM</h3>
            
            <div class="space-y-6">
                <div class="bg-yellow-900/20 p-4 rounded-lg border border-yellow-500/50">
                    <h4 class="text-xl font-bold text-yellow-300">PREMIUM VITALÍCIO</h4>
                    <p class="text-3xl font-black text-white mt-1">R$ 30,00</p>
                    <p class="text-sm text-white/70 mt-3 italic">
                        Não devolvemos o dinheiro em casos de arrependimento.
                    </p>
                </div>

                <div class="space-y-3">
                    <h4 class="text-lg font-bold text-white border-b border-white/20 pb-1">Vantagens Premium:</h4>
                    <ul class="text-white/80 space-y-2 text-sm">
                        <li class="flex items-start"><i class="fas fa-star mr-3 mt-1 text-yellow-500"></i> Catálogo Exclusivo (Selos PREMIUM, Drive, Telegram)</li>
                        <li class="flex items-start"><i class="fas fa-ticket-alt mr-3 mt-1 text-yellow-500"></i> Filmes diretos do cinema em primeira mão</li>
                        <li class="flex items-start"><i class="fas fa-tv mr-3 mt-1 text-yellow-500"></i> Qualidade em 4K liberada</li>
                        <li class="flex items-start"><i class="fas fa-users mr-3 mt-1 text-yellow-500"></i> Acesso aos grupos de Drives e Telegram</li>
                        <li class="flex items-start"><i class="fas fa-bolt mr-3 mt-1 text-yellow-500"></i> Pedidos exclusivos: 5 pedidos por mês (prioritário disponível em até 24h)</li>
                    </ul>
                </div>
                
                <a href="https://chat.whatsapp.com/GZUcD7DW8xx1mA7FbuzHT0?mode=wwc" target="_blank" class="w-full p-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition flex items-center justify-center">
                    <i class="fab fa-whatsapp mr-2"></i> COMPRE JÁ
                </a>
                
                <div id="premium-activation-box" class="p-4 bg-white/10 rounded-lg space-y-4">
                    <h4 class="text-lg font-bold text-white">ATIVAÇÃO PREMIUM</h4>
                    <p class="text-sm text-white/80">Insira o código de ativação recebido após a compra:</p>
                    <input type="password" id="premium-code-input" class="w-full p-3 input-dark rounded-lg" placeholder="Código de Ativação"/>
                    <button onclick="activatePremium()" class="w-full p-3 btn-gradient rounded-xl font-bold" id="btn-activate-premium">
                         <span id="premium-activate-spinner" class="loading-spinner mr-2 hidden"></span>
                         ATIVAR
                    </button>
                </div>
            </div>

            <div class="flex justify-end pt-4">
                <button onclick="document.getElementById('store-modal').classList.add('hidden'); document.body.style.overflow = '';" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    
    <div id="change-password-modal" class="fixed inset-0 modal-backdrop z-[120] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">TROCAR SENHA</h3>
            <form id="change-password-form" class="space-y-4">
                <input type="password" id="new-password" class="w-full p-3 input-dark rounded-lg" placeholder="Nova Senha"/>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="document.getElementById('change-password-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 btn-gradient rounded-lg font-bold flex items-center justify-center" id="btn-change-password">
                         TROCAR
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-photo-modal" class="fixed inset-0 modal-backdrop z-[120] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">EDITAR FOTO</h3>
            <form id="edit-photo-form" class="space-y-4">
                <div>
                    <input type="file" id="edit-photo-file" accept="image/*" class="w-full input-dark rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-white file:text-black hover:file:bg-gray-200" onchange="previewImage(this, 'edit-photo-preview')"/>
                    <img id="edit-photo-preview" class="w-20 h-20 rounded-full object-cover mt-3 border border-white/30" src="https://placehold.co/80x80/111/FFF?text=Foto" onerror="this.src='https://placehold.co/80x80/111/FFF?text=Foto'"/>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="document.getElementById('edit-photo-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 btn-gradient rounded-lg font-bold flex items-center justify-center" id="btn-edit-photo">
                         SALVAR
                    </button>
                </div>
            </form>
        </div>
    </div>
    

    <div id="custom-modal" class="fixed inset-0 modal-backdrop z-[150] hidden">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs border border-white/20 modal-content-scroll">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3>
            <p id="modal-message" class="text-white/80 mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button onclick="hideCustomModal()" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <div id="bulk-add-modal" class="fixed inset-0 modal-backdrop z-[160] hidden items-center justify-center p-4">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 my-8 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">ADICIONAR EPISÓDIOS EM MASSA</h3>
            <p id="bulk-modal-target-info" class="text-white/80 mb-4 text-sm"></p>
            
            <textarea id="bulk-links-input" rows="8" class="w-full p-3 input-dark rounded-lg mb-4" placeholder="Cole a lista de links dos episódios abaixo (um link por linha):\nhttps://link1.com/ep1\nhttps://link2.com/ep2\n..." oninput="numberBulkLinks(this)" title="Cole os links, a numeração automática aparecerá."></textarea>
            
            <div class="p-4 bg-white/5 rounded-lg space-y-3">
                 <label class="flex items-center space-x-3 text-sm font-medium">
                    <input type="checkbox" id="bulk-is-scheduled-checkbox" class="h-4 w-4 text-white bg-black border-gray-300 rounded" onchange="document.getElementById('bulk-schedule-fields').classList.toggle('hidden', !this.checked)"/>
                    <span>Agendar todos os episódios inseridos</span>
                </label>
                <div id="bulk-schedule-fields" class="grid grid-cols-2 gap-4 hidden mt-3">
                    <input type="date" class="p-3 input-dark rounded-lg" title="Data de Lançamento em Massa" id="bulk-release-date-input"/>
                    <input type="time" class="p-3 input-dark rounded-lg" title="Hora de Lançamento em Massa" id="bulk-release-time-input"/>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <button onclick="document.getElementById('bulk-add-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Cancelar
                </button>
                <button id="btn-process-bulk" class="px-4 py-2 btn-gradient rounded-lg font-bold">
                    ADICIONAR
                </button>
            </div>
        </div>
    </div>


    <div id="admin-modal" class="fixed inset-0 modal-backdrop z-[150] hidden">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-xs border border-white/20 modal-content-scroll">
            <h3 class="text-xl font-bold mb-4 text-white">ACESSO ADMIN</h3>
            <p class="text-center text-red-500 font-bold text-xs mb-4">
                Contas que tentarem desbloquear sem permissão serão banidas permanentemente e registradas. Ação automática.
            </p>
            <p class="text-white/80 mb-4">Insira o código:</p>
            <input type="password" id="admin-password-input" class="w-full p-3 mb-6 input-dark rounded-lg" placeholder="Código de Acesso"/>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Cancelar
                </button>
                <button onclick="checkAdminPassword()" class="px-4 py-2 btn-gradient rounded-lg font-bold">
                    Entrar
                </button>
            </div>
        </div>
    </div>
    
    <div id="legal-modal" class="fixed inset-0 modal-backdrop z-[150] hidden items-center justify-center">
        <div class="bg-black p-6 rounded-xl shadow-2xl w-full max-w-md border border-white/20 modal-content-scroll">
            <h3 class="text-2xl font-bold mb-4 text-white border-b border-white/20 pb-2">AVISO LEGAL</h3>
            <p class="text-white/80 mb-6 leading-relaxed">
                Este site não hospeda nenhum arquivo de mídia em seus próprios servidores. Todo o conteúdo disponível é fornecido por terceiros ou incorporado de fontes públicas disponíveis na internet.
            </p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('legal-modal').classList.add('hidden')" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                    Entendi
                </button>
            </div>
        </div>
    </div>

    <div id="trailer-modal" class="fixed inset-0 modal-backdrop z-[120] hidden">
        <div class="bg-black p-2 rounded-xl shadow-2xl w-full max-w-lg border border-white/20 relative">
            <button onclick="closeTrailerModal()" class="absolute -top-2 -right-2 text-white bg-black rounded-full h-8 w-8 flex items-center justify-center z-10 border border-white/50">
                <i class="fas fa-times"></i>
            </button>
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem;">
                <iframe id="trailer-iframe" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc,
            updateDoc, orderBy, increment, setDoc, getDoc, runTransaction, where, documentId, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis de Configuração e Constantes
        const APP_VERSION = "V1.20";
        document.getElementById('app-version').textContent = APP_VERSION;
        
        const TMDB_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJkMGY3ZTJjNDE0YjFlZmZmN2IwMDBhZTliNjgxZWQxYiIsIm5iZiI6MTc0OTMzNDk4Mi42MTUsInN1YiI6IjY4NDRiYmM2MWQ2YzRhNDc0ZWJiMmI3ZiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.RsV2Jfs-ud1Pw3PLx6DG2EjCmX00lp284qyXPL8_aGg";
        const IMGBB_API_KEY = "9a792281a6220ed358215ad0c1e4162e"; 
        
        const APP_ID_FALLBACK = "cinerave-618e4";
        const firebaseConfig = {
            apiKey: "AIzaSyC2rv4N2-QfdZqkNDgGaiBQeceXwrdYTBg",
            authDomain: "cinerave-618e4.firebaseapp.com",
            projectId: "cinerave-618e4",
            storageBucket: "cinerave-618e4.firebasestorage.app",
            messagingSenderId: "1089968754885",
            appId: "1:1089968754885:web:7c992a66cf809e438960ac"
        };
        const appId = APP_ID_FALLBACK;

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug'); 

        // Variáveis de Estado
        let userId = null;
        let selectedTMDBItem = null;
        let isEditing = false;
        let editingDocId = null;
        let allContent = [];
        let bannerInterval;
        let userGenres = {};
        let contentLoaded = false;
        const MIN_RATINGS_FOR_VALIDITY = 5; 
        
        let isAdminAuthenticatedUntil = 0;
        const ADMIN_SESSION_DURATION = 60 * 60 * 1000;
        const PREMIUM_ACTIVATION_CODE = "PR3MIUMOK";
        
        let scrollPositions = {
            homePage: 0,
            explorePage: 0,
            comingSoonPage: 0,
            adminPage: 0,
            premiumPage: 0,
            surprisePage: 0
        };
        let currentPageId = 'homePage'; 
        
        let showWatchHistory = true; 
        const toggleHistoryButton = document.getElementById('toggle-history-btn');
        if (localStorage.getItem('showWatchHistory') === 'false') {
             showWatchHistory = false;
             toggleHistoryButton.textContent = 'ATIVAR HISTÓRICO';
        }
        
        window.isPremium = false; 
        let premiumCatalogFilter = 'drive'; 
        
        // OTIMIZAÇÃO: Limita itens por carrossel na home para melhorar a performance
        const MAX_CAROUSEL_ITEMS = 20;
        // Mapeamento global: Título do Carrossel -> Lista completa de IDs
        let carouselFilterMap = {};


        window.toggleWatchHistory = function() {
            showWatchHistory = !showWatchHistory;
            localStorage.setItem('showWatchHistory', showWatchHistory);
            toggleHistoryButton.textContent = showWatchHistory ? 'DESATIVAR HISTÓRICO' : 'ATIVAR HISTÓRICO';
            closeSidebar();
            renderHomePageContent(allContent); 
        }

        let exploreFilters = {
            search: '',
            type: 'all',
            genre: 'all',
            year: 'all',
            sort: 'recent'
        };

        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const menuButton = document.getElementById('menuButton');
        const userInfoDisplay = document.getElementById('user-info');
        const authButton = document.getElementById('auth-button');
        const profileButton = document.getElementById('profileButton');
        const customModal = document.getElementById('custom-modal');
        const comingSoonCheckbox = document.getElementById('is-coming-soon-checkbox');
        const releaseFields = document.getElementById('release-schedule-fields');
        const contentWrapper = document.getElementById('content-wrapper');
        const scrollToTopButton = document.getElementById('scroll-to-top');
        const navPremiumCatalogButton = document.getElementById('nav-premium-catalog');

        comingSoonCheckbox.addEventListener('change', () => {
            releaseFields.classList.toggle('hidden', !comingSoonCheckbox.checked);
        });


        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.closeSidebar = function() {
            sidebar.classList.remove('open');
            backdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }
        menuButton.addEventListener('click', openSidebar);
        
        let lastTapTime = 0;
        document.getElementById('nav-home').addEventListener('click', (e) => {
             const now = Date.now();
             const timeSinceLastTap = now - lastTapTime;

             if (timeSinceLastTap < 300 && currentPageId === 'homePage') {
                 e.preventDefault();
                 contentWrapper.scrollTo({ top: 0, behavior: 'smooth' });
             } else if (timeSinceLastTap >= 300) {
                 const targetPageId = e.currentTarget.getAttribute('data-page');
                 if (targetPageId) switchTab(targetPageId);
             }
             lastTapTime = now;
        });
        
        // NOVO: Lógica para ignorar acentos e case-sensitivity na busca
        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }


        // Novo: Lógica para exibir o botão de voltar ao topo
        contentWrapper.addEventListener('scroll', () => {
             const isScrollable = currentPageId === 'homePage' || currentPageId === 'explorePage' || currentPageId === 'surprisePage' || currentPageId === 'premiumPage';
             if (isScrollable && contentWrapper.scrollTop > 300) {
                 scrollToTopButton.classList.remove('hidden');
                 scrollToTopButton.classList.add('flex');
             } else {
                 scrollToTopButton.classList.add('hidden');
                 scrollToTopButton.classList.remove('flex');
             }
        });


        window.showCustomModal = function(title, message, autoClose = true) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            document.getElementById('modal-actions').innerHTML = `
                <button onclick="hideCustomModal()" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">Fechar</button>`;

            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
            document.body.style.overflow = 'hidden';

            if (autoClose) {
                setTimeout(() => {
                    hideCustomModal();
                }, 1000);
            }
        }

        window.hideCustomModal = function() {
            customModal.classList.add('hidden');
            customModal.classList.remove('flex');
            document.body.style.overflow = '';
        }
        
        window.showLegalModal = function() {
            closeSidebar();
            document.getElementById('legal-modal').classList.remove('hidden');
        }

        window.showStoreModal = function() {
            // CORREÇÃO: Esconde a caixa de ativação se o usuário já for premium
            if (window.isPremium) {
                document.getElementById('premium-activation-box').classList.add('hidden');
            } else {
                 document.getElementById('premium-activation-box').classList.remove('hidden');
            }

            closeSidebar();
            document.getElementById('premium-code-input').value = '';
            document.getElementById('store-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.showMyListModal = function() {
            closeSidebar();
            document.getElementById('my-list-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            renderMyList();
        }
        
        window.showReportsListModal = function() {
            document.getElementById('reports-list-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.switchTab = function(targetPageId, premiumInitialTab = null) {
            scrollPositions[currentPageId] = contentWrapper.scrollTop;

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('text-white');
                nav.classList.add('text-white/50');
            });

            document.getElementById(targetPageId).classList.remove('hidden');

            const activeNav = document.querySelector(`#bottom-nav [data-page="${targetPageId}"]`);
            if (activeNav) {
                activeNav.classList.add('text-white');
                activeNav.classList.remove('text-white/50');
            }
            
            contentWrapper.scrollTop = scrollPositions[targetPageId] || 0;
            currentPageId = targetPageId;
            
            // CORREÇÃO: Força scroll para o topo ao abrir a página Ver Mais (surprisePage)
            if (targetPageId === 'surprisePage' || targetPageId === 'explorePage') {
                contentWrapper.scrollTo({ top: 0, behavior: 'instant' });
            }

            // Garante que o botão de voltar ao topo esteja visível se necessário
            if (contentWrapper.scrollTop > 300) {
                 scrollToTopButton.classList.remove('hidden');
                 scrollToTopButton.classList.add('flex');
            } else {
                 scrollToTopButton.classList.add('hidden');
                 scrollToTopButton.classList.remove('flex');
            }


            if (targetPageId === 'homePage' || targetPageId === 'explorePage') {
                const currentBaseUrl = window.location.href.split('#')[0];
                history.replaceState(null, null, currentBaseUrl);
            }
            
            if (targetPageId === 'explorePage') {
                 renderExploreGrid();
                 renderPremiumExploreGrid(); // NOVO: Renderiza grid Premium no Explorar
            } else if (targetPageId === 'comingSoonPage') {
                 renderComingSoonGrid();
            } else if (targetPageId === 'premiumPage') {
                 if (!isPremium) {
                     document.getElementById('premium-access-warning').classList.remove('hidden');
                     document.getElementById('premium-grid-container').innerHTML = '';
                 } else {
                     document.getElementById('premium-access-warning').classList.add('hidden');
                     // Alterna a aba interna
                     premiumCatalogFilter = premiumInitialTab || premiumCatalogFilter;
                     switchPremiumTab(premiumCatalogFilter);
                 }
            }
        }
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.id !== 'nav-home') {
                 item.addEventListener('click', (e) => {
                     const targetPageId = e.currentTarget.getAttribute('data-page');
                     if (targetPageId) switchTab(targetPageId);
                 });
            }
        });
        
        document.querySelectorAll('.premium-tab-button').forEach(button => {
            button.onclick = (e) => {
                const seal = e.currentTarget.dataset.seal;
                switchPremiumTab(seal);
            };
        });

        window.switchPremiumTab = function(seal) {
            premiumCatalogFilter = seal;

            document.querySelectorAll('.premium-tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white/10', 'text-white');
                btn.classList.add('bg-white/10', 'text-white');
                if (btn.dataset.seal === seal) {
                    btn.classList.add('active', 'bg-white');
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-black');
                } else {
                    btn.classList.remove('text-black');
                    btn.classList.add('text-white');
                }
            });
            renderPremiumCatalog();
        }

        window.renderPremiumCatalog = function() {
            const gridContainer = document.getElementById('premium-grid-container');
            const noResults = document.getElementById('premium-no-results');
            const searchInput = document.getElementById('premium-search-input');
            const searchTerms = normalizeString(searchInput.value.trim());
            const sealToFilter = premiumCatalogFilter;

            if (!isPremium) {
                 gridContainer.innerHTML = '';
                 noResults.classList.add('hidden');
                 return;
            }
            
            let filteredContent = allContent.filter(item => {
                 if (!checkReleaseStatus(item)) return false; 
                 if (item.seals?.maintenance) return false; // Ignora Manutenção
                
                 const matchesSeal = item.seals?.[sealToFilter] === true;
                 
                 const normalizedTitle = normalizeString(item.title);
                 const normalizedSinopse = normalizeString(item.sinopse);
                 const normalizedActors = normalizeString(item.actors || '');
                 
                 const matchesSearch = !searchTerms || 
                                       normalizedTitle.includes(searchTerms) ||
                                       normalizedSinopse.includes(searchTerms) ||
                                       normalizedActors.includes(searchTerms);
                                       
                 return matchesSeal && matchesSearch;
            });

            filteredContent.sort((a, b) => b.timestamp - a.timestamp);

            if (filteredContent.length === 0) {
                gridContainer.innerHTML = '';
                noResults.classList.remove('hidden');
            } else {
                const html = filteredContent.map(item => createExploreCard(item, item.id)).join('');
                gridContainer.innerHTML = html;
                noResults.classList.add('hidden');
            }
        }
        document.getElementById('premium-search-input').oninput = renderPremiumCatalog;

        function handleDeepLink() {
            const hash = window.location.hash;
            if (hash.startsWith('#details=')) {
                const id = hash.substring(9);
                const contentExists = allContent.some(c => c.id === id);
                
                if (contentLoaded && contentExists) {
                    showDetailsModal(id);
                } else {
                     const currentBaseUrl = window.location.href.split('#')[0];
                     history.replaceState(null, null, currentBaseUrl);
                }
            } else {
                 switchTab('homePage');
            }
        }
        window.addEventListener('hashchange', handleDeepLink);
        
        window.togglePasswordVisibility = function(inputId, buttonElement) {
            const input = document.getElementById(inputId);
            const icon = buttonElement.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        window.setLoading = function(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const spinner = button.querySelector('.loading-spinner');
            if (isLoading) {
                button.disabled = true;
                if (spinner) spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
            }
        }

        async function authenticateUser() {
            return new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        unsubscribe(); 
                        resolve();
                        return;
                    }

                    let success = false;
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            success = true;
                        } catch (error) {
                            console.warn("Falha ao usar token customizado, tentando login anônimo. Detalhes:", error.code || error.message);
                        }
                    }
                    
                    if (!success) {
                        try {
                            await signInAnonymously(auth);
                            success = true;
                        } catch(e) {
                            console.error("Erro fatal: Falha ao tentar login anônimo.", e);
                            showCustomModal("Erro de Autenticação", "Não foi possível conectar ao Firebase.", false);
                        }
                    }
                    
                    if (success) {
                        console.log("Autenticação inicial concluída (via token ou anônima).");
                    }
                    unsubscribe(); 
                    resolve();
                });
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userInfoDisplay.textContent = `${userId}`;
                
                if (user.isAnonymous) {
                    authButton.innerHTML = `<i class="fas fa-sign-in-alt mr-3 w-5 text-center"></i> ENTRAR / SAIR`;
                    profileButton.classList.add('hidden');
                    window.isPremium = false;
                    navPremiumCatalogButton.classList.add('hidden');
                    document.getElementById('profile-modal-premium').textContent = 'GRÁTIS';
                    document.getElementById('profile-modal-premium').classList.replace('text-yellow-400', 'text-red-500');
                } else {
                    authButton.innerHTML = `<i class="fas fa-sign-out-alt mr-3 w-5 text-center"></i> SAIR`;
                    profileButton.classList.remove('hidden');
                    
                    const profilePhotoUrl = user.photoURL || 'https://placehold.co/32x32/111/FFF?text=?';
                    document.getElementById('profile-img-header').src = profilePhotoUrl;

                    loadUserGenres(userId);
                    loadPremiumStatus(userId);
                }
            } else {
                userId = crypto.randomUUID(); 
                userInfoDisplay.textContent = `${userId}`;
                authButton.innerHTML = `<i class="fas fa-sign-in-alt mr-3 w-5 text-center"></i> ENTRAR / SAIR`;
                profileButton.classList.add('hidden');
                document.getElementById('profile-img-header').src = 'https://placehold.co/32x32/111/FFF?text=?';
                userGenres = {};
            }
            renderHomePageContent(allContent);
        });
        
        window.handleAuthClick = async function() {
            closeSidebar();
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                try {
                    await signOut(auth);
                    showCustomModal("Sair", "Você desconectou com sucesso.");
                } catch (error) {
                    showCustomModal("Erro", "Falha ao desconectar.");
                }
            } else {
                showSignInModal();
            }
        }

        window.showLinkModal = function() {
            closeSidebar();
            document.getElementById('link-modal').classList.remove('hidden');
        }
        
        window.showSignInModal = function() {
            closeSidebar();
            document.getElementById('signin-modal').classList.remove('hidden');
        }

        window.showProfileModal = function() {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) return;
            
            document.getElementById('profile-modal-photo').src = user.photoURL || 'https://placehold.co/96x96/111/FFF?text=Foto';
            document.getElementById('profile-modal-name').textContent = user.displayName || 'Usuário Não Nomeado';
            document.getElementById('profile-modal-uid').textContent = user.uid;
            document.getElementById('profile-modal-email').textContent = user.email;
            
            if (window.isPremium) {
                document.getElementById('profile-modal-premium').textContent = 'PREMIUM ATIVO';
                document.getElementById('profile-modal-premium').classList.replace('text-red-500', 'text-yellow-400');
            } else {
                document.getElementById('profile-modal-premium').textContent = 'GRÁTIS';
                document.getElementById('profile-modal-premium').classList.replace('text-yellow-400', 'text-red-500');
            }

            document.getElementById('profile-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.showChangePasswordModal = function() {
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('change-password-modal').classList.remove('hidden');
            document.getElementById('new-password').value = '';
        }
        
        window.showEditPhotoModal = function() {
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('edit-photo-modal').classList.remove('hidden');
            document.getElementById('edit-photo-preview').src = auth.currentUser.photoURL || 'https://placehold.co/80x80/111/FFF?text=Foto';
        }
        
        document.getElementById('link-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('link-name').value;
            const email = document.getElementById('link-email').value;
            const password = document.getElementById('link-password').value;
            const file = document.getElementById('link-photo-file').files[0];

            if (!name || !email || !password) {
                return showCustomModal('Erro', 'Preencha Nome, Email e Senha.', true);
            }
            
            setLoading('btn-link-submit', true);
            
            try {
                let photoURL = '';
                if (file) {
                    photoURL = await uploadImageToImgBB(file);
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, {
                    displayName: name,
                    photoURL: photoURL
                });

                document.getElementById('link-modal').classList.add('hidden');
                showCustomModal('Sucesso!', `Conta vinculada. Olá, ${name}!`);

            } catch (error) {
                console.error("Erro ao vincular conta:", error);
                showCustomModal('Erro na Vinculação', 'Email pode já estar em uso.', true);
            } finally {
                setLoading('btn-link-submit', false);
            }
        });
        
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            setLoading('btn-signin-submit', true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('signin-modal').classList.add('hidden');
                showCustomModal('Sucesso!', 'Login realizado com sucesso.');
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                showCustomModal('Erro no Login', 'Email ou senha inválidos.', true);
            } finally {
                setLoading('btn-signin-submit', false);
            }
        });
        
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const user = auth.currentUser;

            if (!user || user.isAnonymous) return showCustomModal('Erro', 'Faça login para trocar a senha.', true);

            setLoading('btn-change-password', true);
            try {
                await updatePassword(user, newPassword);
                document.getElementById('change-password-modal').classList.add('hidden');
                showCustomModal('Sucesso!', 'Senha alterada com sucesso.');
            } catch (error) {
                console.error("Erro ao trocar senha:", error);
                showCustomModal('Erro', 'Falha ao trocar senha. Tente fazer o login novamente e re-tentar.', true);
            } finally {
                setLoading('btn-change-password', false);
            }
        });

        document.getElementById('edit-photo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('edit-photo-file').files[0];
            const user = auth.currentUser;

            if (!user || user.isAnonymous || !file) return showCustomModal('Erro', 'Selecione uma foto.', true);

            setLoading('btn-edit-photo', true);
            try {
                const photoURL = await uploadImageToImgBB(file);

                await updateProfile(user, { photoURL: photoURL });
                document.getElementById('profile-img-header').src = photoURL;
                
                document.getElementById('edit-photo-modal').classList.add('hidden');
                showCustomModal('Sucesso!', 'Foto de perfil atualizada.');
            } catch (error) {
                console.error("Erro ao editar foto:", error);
                showCustomModal('Erro', 'Falha ao fazer upload da foto.', true);
            } finally {
                setLoading('btn-edit-photo', false);
            }
        });


        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            const url = `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Falha no upload do ImgBB');
            
            const result = await response.json();
            return result.data.url;
        }
        
        window.previewImage = function(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.src = 'https://placehold.co/80x80/111/FFF?text=Foto';
            }
        }
        
        window.activatePremium = async function() {
             if (!auth.currentUser || auth.currentUser.isAnonymous) {
                return showCustomModal("Erro", "Faça login com uma conta de email para ativar Premium.", true);
             }

             const code = document.getElementById('premium-code-input').value.trim();
             if (code !== PREMIUM_ACTIVATION_CODE) {
                 return showCustomModal("Erro", "Código de ativação inválido.", true);
             }

             setLoading('btn-activate-premium', true);
             try {
                 const docRef = doc(db, `/artifacts/${appId}/users/${auth.currentUser.uid}/metadata/premium`);
                 await setDoc(docRef, { isPremium: true, activatedAt: Date.now() });
                 
                 document.getElementById('store-modal').classList.add('hidden');
                 showCustomModal("Sucesso!", "Premium Vitalício ativado com sucesso.", true);
             } catch (error) {
                 console.error("Erro ao ativar Premium:", error);
                 showCustomModal("Erro", "Falha ao salvar o status Premium.", true);
             } finally {
                 setLoading('btn-activate-premium', false);
             }
        }

        async function loadPremiumStatus(uid) {
            const docRef = doc(db, `/artifacts/${appId}/users/${uid}/metadata/premium`);
            onSnapshot(docRef, (docSnap) => {
                const isUserPremium = docSnap.exists() && docSnap.data().isPremium;
                
                window.isPremium = isUserPremium;
                navPremiumCatalogButton.classList.toggle('hidden', !isUserPremium);
                
                // CORREÇÃO: Esconde a caixa de ativação se for Premium
                document.getElementById('premium-activation-box').classList.toggle('hidden', isUserPremium);

            }, (error) => {
                 console.warn("Falha ao carregar status Premium:", error.message);
                 window.isPremium = false; 
            });
        }


        const ADMIN_PASSWORD = "leoleo";

        window.showAdminPasswordModal = function() {
            closeSidebar();

            if (Date.now() < isAdminAuthenticatedUntil) {
                showCustomModal("Sucesso", "Acesso de administrador concedido (sessão ativa).", true); 
                switchTab('adminPage');
                return;
            }
            
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-modal').classList.add('flex');
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-password-input').focus();
        }

        window.checkAdminPassword = function() {
            const input = document.getElementById('admin-password-input').value;
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-modal').classList.remove('flex');

            if (input === ADMIN_PASSWORD) {
                isAdminAuthenticatedUntil = Date.now() + ADMIN_SESSION_DURATION;
                showCustomModal("Sucesso", "Acesso de administrador concedido.", true); 
                switchTab('adminPage'); 
            } else {
                showCustomModal("Erro", "Código de acesso inválido.", true);
            }
        }

        window.showPublishModal = function(content = null) {
            isEditing = !!content;
            editingDocId = content ? content.id : null;
            selectedTMDBItem = null;
            
            document.getElementById('publish-modal-title').textContent = isEditing ? "EDITAR CONTEÚDO" : "PUBLICAR NOVO CONTEÚDO";
            document.getElementById('tmdb-info-text').textContent = "Nenhum TMDb selecionado";
            document.getElementById('publish-form').reset();
            document.getElementById('seasons-container').innerHTML = '';
            document.getElementById('movie-links-container').innerHTML = '';
            
            document.getElementById('poster-preview').src = 'https://placehold.co/160x240/111/FFF?text=POSTER';
            
            if (!isEditing) {
                addLinkInput('movie');
                comingSoonCheckbox.checked = false;
                releaseFields.classList.add('hidden');
                
                if (document.getElementById('content-type').value === 'tv') {
                     document.getElementById('num-seasons-input').value = 1;
                     generateSeasonForms(); 
                }
            }
            
            if (isEditing) {
                fillFormForEditing(content);
            } else {
                toggleContentForm('movie'); 
            }
            
            // CORREÇÃO: Volta ao topo do modal de publicação
            const publishModalContainer = document.getElementById('publish-modal-container');
            if (publishModalContainer) publishModalContainer.scrollTo({ top: 0, behavior: 'instant' });


            document.getElementById('publish-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.hidePublishModal = function() {
            document.getElementById('publish-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function fillFormForEditing(content) {
            document.getElementById('content-type').value = content.type;
            document.getElementById('title-input').value = content.title;
            document.getElementById('sinopse-input').value = content.sinopse;
            document.getElementById('year-input').value = content.year;
            
            document.getElementById('genres-input').value = Array.isArray(content.genres) ? content.genres.join(', ') : content.genres;
            document.getElementById('actors-input').value = content.actors;
            document.getElementById('trailer-input').value = content.trailer;
            document.getElementById('poster-preview').src = content.poster || 'https://placehold.co/160x240/111/FFF?text=POSTER';
            document.getElementById('backdrop-input').value = content.backdrop || '';
            document.getElementById('tmdb-info-text').textContent = content.tmdbId ? `TMDb ID: ${content.tmdbId}` : 'Conteúdo manual';
            
            comingSoonCheckbox.checked = !!content.is_coming_soon;
            releaseFields.classList.toggle('hidden', !content.is_coming_soon);
            
            document.getElementById('seal-drive').checked = !!content.seals?.drive;
            document.getElementById('seal-telegram').checked = !!content.seals?.telegram;
            document.getElementById('seal-premium').checked = !!content.seals?.premium;
            document.getElementById('seal-4k').checked = !!content.seals?.['4k'];
            document.getElementById('seal-cinema-quality').checked = !!content.seals?.cinema_quality;
            document.getElementById('seal-maintenance').checked = !!content.seals?.maintenance; // NOVO: Selo Manutenção

            if (content.release_timestamp) {
                const releaseDate = new Date(content.release_timestamp);
                document.getElementById('release-date-input').value = releaseDate.toISOString().split('T')[0];
                document.getElementById('release-time-input').value = releaseDate.toTimeString().split(' ')[0].substring(0, 5);
            } else {
                document.getElementById('release-date-input').value = '';
                document.getElementById('release-time-input').value = '';
            }

            toggleContentForm(content.type);
            
            if (content.type === 'movie' && content.links && content.links.length > 0) {
                document.getElementById('movie-links-container').innerHTML = content.links.map(link => 
                     `<div class="flex items-center space-x-2">
                        <input type="url" class="movie-link-input w-full p-3 input-dark rounded-lg" placeholder="URL do Link do Filme" value="${link}"/>
                        <button type="button" onclick="removeLinkInput(this.parentNode)" class="text-red-500 hover:text-red-400 text-lg w-8 h-8 flex items-center justify-center">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>`
                ).join('');
            } else if (content.type === 'movie' && (!content.links || content.links.length === 0)) {
                 addLinkInput('movie');
            }
            
            if (content.type === 'tv' && content.seasons) {
                fillSeasonForms(content.seasons);
            }
        }
        
        function fillSeasonForms(seasons) {
            const container = document.getElementById('seasons-container');
            container.innerHTML = '';
            document.getElementById('num-seasons-input').value = seasons.length;

            seasons.forEach((season, index) => {
                const seasonId = `season-${index + 1}`;
                const html = createSeasonForm(seasonId, index + 1, season.is_coming_soon, season.release_timestamp);
                container.insertAdjacentHTML('beforeend', html);
                
                const releaseDateInput = document.getElementById(`release-date-${seasonId}`);
                const releaseTimeInput = document.getElementById(`release-time-${seasonId}`);

                if (season.release_timestamp) {
                    const releaseDate = new Date(season.release_timestamp).toISOString().split('T')[0];
                    releaseTimeInput.value = new Date(season.release_timestamp).toTimeString().split(' ')[0].substring(0, 5);
                }
                
                const episodeLinksContainer = document.getElementById(`episode-links-${seasonId}`);
                episodeLinksContainer.innerHTML = '';
                
                if (season.episodes && season.episodes.length > 0) {
                     season.episodes.forEach((episode, epIndex) => {
                          const link = typeof episode === 'string' ? episode : (episode.link || '');
                          const timestamp = typeof episode === 'object' ? episode.release_timestamp : null;
                          
                          addEpisodeInput(seasonId, link, timestamp, true, epIndex + 1);
                     });
                } else {
                     addEpisodeInput(seasonId);
                }
            });
        }

        window.toggleContentForm = function(type = null) {
            const contentType = type || document.getElementById('content-type').value;
            document.getElementById('movie-section').classList.toggle('hidden', contentType !== 'movie');
            document.getElementById('tv-section').classList.toggle('hidden', contentType !== 'tv');
            
             if (contentType === 'tv' && document.getElementById('seasons-container').children.length === 0 && !isEditing) {
                 document.getElementById('num-seasons-input').value = 1;
                 generateSeasonForms(); 
             }
        }

        window.addLinkInput = function(type) {
            const linkTypeClass = type === 'movie' ? 'movie-link-input' : 'episode-link-input-dynamic';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center space-x-2 mt-3';
            wrapper.innerHTML = `
                <input type="url" class="${linkTypeClass} w-full p-3 input-dark rounded-lg" placeholder="URL do Novo Link do Filme"/>
                <button type="button" onclick="removeLinkInput(this.parentNode)" class="text-red-500 hover:text-red-400 text-lg w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            if (type === 'movie') {
                 document.getElementById('movie-links-container').appendChild(wrapper);
            }
        }
        
        window.removeLinkInput = function(element) {
            element.remove();
        }

        window.generateSeasonForms = function() {
            const numSeasons = parseInt(document.getElementById('num-seasons-input').value);
            const container = document.getElementById('seasons-container');
            
            const existingSeasons = collectFormData(true)?.seasons || [];
            
            container.innerHTML = '';
            
            for (let i = 1; i <= numSeasons; i++) {
                const existing = existingSeasons.find(s => s.number === i);
                
                const isComingSoon = existing?.is_coming_soon || false;
                const releaseTimestamp = existing?.release_timestamp || null;

                const html = createSeasonForm(`season-${i}`, i, isComingSoon, releaseTimestamp);
                container.insertAdjacentHTML('beforeend', html);
                
                const episodeLinksContainer = document.getElementById(`episode-links-season-${i}`);
                
                if (existing && existing.episodes && existing.episodes.length > 0) {
                     existing.episodes.forEach((episode, epIndex) => {
                          const link = typeof episode === 'string' ? episode : (episode.link || '');
                          const timestamp = typeof episode === 'object' ? episode.release_timestamp : null;
                          addEpisodeInput(`season-${i}`, link, timestamp, true, epIndex + 1);
                     });
                } else {
                    addEpisodeInput(`season-${i}`);
                }
            }
        }
        
        window.toggleSeasonSchedule = function(seasonId) {
            const checkbox = document.getElementById(`is-coming-soon-${seasonId}`);
            const fields = document.getElementById(`schedule-fields-${seasonId}`);
            fields.classList.toggle('hidden', !checkbox.checked);
        }
        
        window.toggleEpisodeSchedule = function(checkboxElement, epId) {
            const fields = document.getElementById(`schedule-fields-${epId}`);
            fields.classList.toggle('hidden', !checkboxElement.checked);
        }


        function createSeasonForm(id, number, isComingSoon = false, releaseTimestamp = null) {
            const checked = isComingSoon ? 'checked' : '';
            const hiddenClass = isComingSoon ? '' : 'hidden';
            
            const releaseDate = releaseTimestamp ? new Date(releaseTimestamp).toISOString().split('T')[0] : '';
            const releaseTime = releaseTimestamp ? new Date(releaseTimestamp).toTimeString().split(' ')[0].substring(0, 5) : '';

            return `
                <div id="${id}" class="bg-[#111] p-4 rounded-lg border border-white/20">
                    <h5 class="font-bold text-white mb-3">TEMPORADA ${number}</h5>

                    <div class="mt-2 p-3 bg-black/30 rounded-lg">
                        <label class="flex items-center space-x-3 text-sm font-medium">
                            <input type="checkbox" id="is-coming-soon-${id}" class="h-4 w-4 text-white bg-black border-gray-300 rounded" ${checked} onchange="toggleSeasonSchedule('${id}')"/>
                            <span>Agendar Lançamento da Temporada ${number}</span>
                        </label>
                        <div id="schedule-fields-${id}" class="grid grid-cols-2 gap-4 mt-3 ${hiddenClass}">
                            <input type="date" id="release-date-${id}" class="p-3 input-dark rounded-lg" title="Data de Lançamento da Temporada" value="${releaseDate}"/>
                            <input type="time" id="release-time-${id}" class="p-3 input-dark rounded-lg" title="Hora de Lançamento da Temporada" value="${releaseTime}"/>
                        </div>
                    </div>


                    <div id="episode-links-${id}" class="space-y-3 pt-4 border-t border-white/10 mt-4">
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button type="button" onclick="addEpisodeInput('${id}')" class="text-sm font-medium text-white/70 hover:text-white transition duration-150">
                            <i class="fas fa-plus mr-1"></i> Adicionar Episódio Manual
                        </button>
                        <button type="button" onclick="showBulkAddModal('${id}')" class="text-sm font-medium text-white/70 hover:text-white transition duration-150">
                            <i class="fas fa-paste mr-1"></i> Adicionar em Massa
                        </button>
                    </div>
                </div>
            `;
        }
        
        window.addEpisodeInput = function(seasonId, link = '', timestamp = null, fromLoad = false, forcedEpNumber = null) {
            const container = document.getElementById(`episode-links-${seasonId}`);
            if (!container) return;
            
            const existingInputs = container.querySelectorAll('.episode-link-group');
            const epNumber = forcedEpNumber || (existingInputs.length + 1);
            const epId = `${seasonId}-ep-${epNumber}-${Date.now()}`; 

            const isScheduled = !!timestamp;
            const hiddenClass = isScheduled ? '' : 'hidden';
            
            let releaseDate = '';
            let releaseTime = '';
            if (timestamp) {
                 const releaseDateObj = new Date(timestamp);
                 releaseDate = releaseDateObj.toISOString().split('T')[0];
                 releaseTime = releaseDateObj.toTimeString().split(' ')[0].substring(0, 5);
            }


            const wrapper = document.createElement('div');
            wrapper.className = 'episode-link-group p-3 bg-black/30 rounded-lg mb-3';
            wrapper.id = epId; 
            wrapper.innerHTML = `
                <label class="block text-sm font-semibold mb-2">Episódio ${epNumber}</label>
                <div class="flex items-center space-x-2">
                    <input type="url" class="episode-link-input w-full p-3 input-dark rounded-lg text-sm" 
                        placeholder="URL do Episódio ${epNumber}" value="${link}" data-ep-number="${epNumber}"/>
                    <button type="button" onclick="removeLinkInput(this.closest('.episode-link-group'))" class="text-red-500 hover:text-red-400 text-lg w-8 h-8 flex items-center justify-center">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                
                <div class="mt-3">
                     <label class="flex items-center space-x-3 text-xs font-medium text-white/70">
                        <input type="checkbox" class="episode-schedule-checkbox h-3 w-3 text-white bg-black border-gray-300 rounded" 
                                ${isScheduled ? 'checked' : ''} onchange="toggleEpisodeSchedule(this, '${epId}')"/>
                        <span>Agendar data/hora específica para este episódio (Opcional)</span>
                    </label>
                    <div id="schedule-fields-${epId}" class="grid grid-cols-2 gap-4 ${hiddenClass} mt-2">
                        <input type="date" class="episode-release-date p-2 input-dark rounded-lg text-xs" title="Data de Lançamento" value="${releaseDate}"/>
                        <input type="time" class="episode-release-time p-2 input-dark rounded-lg text-xs" title="Hora de Lançamento" value="${releaseTime}"/>
                    </div>
                </div>
            `;
            
            if (fromLoad) {
                container.appendChild(wrapper);
            } else {
                 container.appendChild(wrapper);
                 renumberEpisodes(seasonId);
            }

            if (!fromLoad && epNumber === 1 && existingInputs.length === 0) {
                 wrapper.querySelector('.fa-times-circle').closest('button').classList.remove('hidden');
            }
        }
        
        function renumberEpisodes(seasonId) {
            const container = document.getElementById(`episode-links-${seasonId}`);
            if (!container) return;
            
            const episodeGroups = container.querySelectorAll('.episode-link-group');
            episodeGroups.forEach((group, index) => {
                 const epNumber = index + 1;
                 group.querySelector('label').textContent = `Episódio ${epNumber}`;
                 const linkInput = group.querySelector('.episode-link-input');
                 linkInput.placeholder = `URL do Episódio ${epNumber}`;
                 linkInput.dataset.epNumber = epNumber;
            });
        }

        window.numberBulkLinks = function(textarea) {
            const originalSelectionStart = textarea.selectionStart;
            const originalSelectionEnd = textarea.selectionEnd;
            const originalValue = textarea.value;

            let lines = originalValue.split('\n');
            let newLines = [];
            let number = 1;

            lines.forEach(line => {
                const trimmed = line.trim();
                
                let content = trimmed.replace(/^\d+\.\s*/, '').trim();

                if (content === '') {
                    newLines.push('');
                } else {
                    newLines.push(`${number}. ${content}`);
                    number++;
                }
            });

            const newText = newLines.join('\n');

            if (newText !== originalValue) {
                textarea.value = newText;
                
                const lineCountDifference = originalValue.split('\n').length - newText.split('\n').length;
                let newStart = originalSelectionStart;

                if (lineCountDifference === 0) {
                    let charsAdded = 0;
                    for (let i = 0; i < lines.length; i++) {
                        const oldLine = lines[i];
                        
                        if (oldLine.length > 0) {
                             const numPrefixLength = `${i + 1}. `.length;
                             const oldPrefixMatch = oldLine.match(/^\d+\.\s*/);
                             const oldPrefixLength = oldPrefixMatch ? oldPrefixMatch[0].length : 0;

                             if (!oldPrefixMatch) {
                                 charsAdded += numPrefixLength; 
                             }
                        }
                        if (originalSelectionStart <= originalValue.indexOf(oldLine) + oldLine.length + 1) {
                            newStart += charsAdded;
                            break;
                        }
                    }
                }
                
                textarea.setSelectionRange(newStart, newStart);
            }
        };

        document.getElementById('bulk-links-input').addEventListener('input', function() {
            numberBulkLinks(this);
        });

        window.showBulkAddModal = function(seasonId) {
            const seasonNumber = seasonId.split('-')[1];
            
            document.getElementById('bulk-modal-target-info').textContent = `Adicionando links para a Temporada ${seasonNumber}.`;
            document.getElementById('bulk-links-input').value = '';
            document.getElementById('bulk-is-scheduled-checkbox').checked = false;
            document.getElementById('bulk-schedule-fields').classList.add('hidden');
            document.getElementById('bulk-release-date-input').value = '';
            document.getElementById('bulk-release-time-input').value = '';
            
            document.getElementById('btn-process-bulk').onclick = () => processBulkLinks(seasonId);
            
            document.getElementById('bulk-add-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        window.processBulkLinks = function(seasonId) {
            const bulkLinks = document.getElementById('bulk-links-input').value;
            const isScheduled = document.getElementById('bulk-is-scheduled-checkbox').checked;
            const releaseDate = document.getElementById('bulk-release-date-input').value;
            const releaseTime = document.getElementById('bulk-release-time-input').value;
            
            const linksArray = bulkLinks.split('\n')
                .map(line => line.trim().replace(/^\d+\.\s*/, ''))
                .filter(link => link.length > 0);
            
            if (linksArray.length === 0) {
                document.getElementById('bulk-add-modal').classList.add('hidden');
                return showCustomModal('Aviso', 'Nenhum link detectado.', true);
            }
            
            let releaseTimestamp = null;
            if (isScheduled) {
                if (!releaseDate || !releaseTime) {
                    return showCustomModal('Erro', 'Preencha Data e Hora para agendar em massa.', true);
                }
                releaseTimestamp = new Date(`${releaseDate}T${releaseTime}:00`).getTime();
            }
            
            const container = document.getElementById(`episode-links-${seasonId}`);
            
            if (container.children.length === 1 && container.querySelector('.episode-link-input')?.value === '') {
                 container.innerHTML = '';
            }

            linksArray.forEach(link => {
                addEpisodeInput(seasonId, link, releaseTimestamp, true);
            });
            
            renumberEpisodes(seasonId);
            
            document.getElementById('bulk-add-modal').classList.add('hidden');
            showCustomModal('Sucesso', `${linksArray.length} episódios adicionados.`, true);
        }


        window.showPreviewModal = function() {
            const content = collectFormData();
            if (!content) return; 

            const title = isEditing ? 'Editar Conteúdo' : 'Publicar Conteúdo';
            document.getElementById('btn-confirm-publish').innerHTML = `<span id="publish-spinner" class="loading-spinner mr-2 hidden"></span> ${isEditing ? 'CONFIRMAR EDIÇÃO' : 'CONFIRMAR E PUBLICAR'}`;

            let linksHtml = '';
            if (content.type === 'movie') {
                 linksHtml = content.links.map((link, i) => `<p class="block text-sm text-white/80 break-all">Link ${i + 1}: ${link.substring(0, 40)}...</p>`).join('');
            } else {
                 linksHtml = content.seasons.map(s => {
                    const seasonReleased = checkReleaseStatus(s, null, true);
                    const seasonStatus = s.is_coming_soon ? `<span class="text-red-400"> (Agendada: ${new Date(s.release_timestamp).toLocaleString('pt-BR')})</span>` : '';
                    
                    const episodesHtml = s.episodes.map((ep, i) => {
                         const epReleased = checkReleaseStatus(ep, s, true);
                         const statusText = !epReleased ? 
                            (ep.release_timestamp ? 
                                `<span class="text-xs text-red-500">(Agendado: ${new Date(ep.release_timestamp).toLocaleDateString()})</span>` : 
                                `<span class="text-xs text-yellow-500">(Agendamento da Temporada)</span>`)
                            : '';
                         
                         return `<p class="block text-sm text-white/80 break-all">Ep ${i + 1}: ${ep.link.substring(0, 40)}... ${statusText}</p>`;
                    }).join('');


                    return `
                        <p class="font-bold text-base mt-2">T${s.number} ${s.is_coming_soon ? seasonStatus : ''}</p>
                        <div class="space-y-1 pl-2">
                            ${episodesHtml}
                        </div>
                    `;
                }).join('');
            }

            let sealsInfo = Object.entries(content.seals)
                .filter(([, value]) => value === true)
                .map(([key]) => `<span class="bg-white/10 text-white text-xs px-2 py-0.5 rounded-full">${key.toUpperCase().replace(/_/g, ' ')}</span>`)
                .join(' ');
                
            if (content.seals.maintenance) {
                 sealsInfo += `<span class="bg-red-800 text-white text-xs px-2 py-0.5 rounded-full ml-1">RASCUNHO</span>`;
            }

            let releaseInfo = '';
            if (content.is_coming_soon) {
                const date = new Date(content.release_timestamp).toLocaleString('pt-BR');
                releaseInfo = `<p class="text-sm font-bold text-red-400 mt-2">LANÇAMENTO GERAL AGENDADO: ${date}</p>`;
            }

            let html = `
                <div class="flex items-start mb-4">
                    <img src="${content.poster}" class="w-24 h-36 object-cover rounded-lg mr-4 border border-white/30" onerror="this.src='https://placehold.co/100x150/111/FFF?text=POSTER'"/>
                    <div>
                        <h3 class="2xl font-bold">${content.title}</h3>
                        <p class="text-sm text-white/50">${content.type === 'movie' ? 'Filme' : 'Série'} - ${content.year}</p>
                        <p class="mt-2">${sealsInfo}</p>
                        ${releaseInfo}
                    </div>
                </div>
                <p class="text-sm mb-4">${content.sinopse.substring(0, 300)}...</p>
                <p class="text-xs text-white/70">Gêneros: ${Array.isArray(content.genres) ? content.genres.join(', ') : content.genres}</p>
                <p class="text-xs text-white/70 mb-4">Atores: ${content.actors}</p>
                <h4 class="font-bold border-b border-white/20 pb-1 mb-2">Acessar Conteúdo:</h4>
                <div class="space-y-2 max-h-48 overflow-y-auto p-2 border border-white/10 rounded-lg">
                    ${linksHtml}
                </div>
                ${content.trailer ? `<a href="${content.trailer}" target="_blank" class="mt-4 block text-center p-2 btn-gradient rounded-lg font-bold">ASSISTIR TRAILER <i class="fas fa-external-link-alt ml-1"></i></a>` : ''}
            `;
            
            document.getElementById('preview-content').innerHTML = html;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function collectFormData(isForRenumbering = false) {
            const type = document.getElementById('content-type').value;
            const title = document.getElementById('title-input').value;
            const sinopse = document.getElementById('sinopse-input').value;
            const year = document.getElementById('year-input').value;
            const rawGenres = document.getElementById('genres-input').value;
            const actors = document.getElementById('actors-input').value;
            const trailer = document.getElementById('trailer-input').value;
            const poster = document.getElementById('poster-preview').src;
            const backdrop = document.getElementById('backdrop-input').value;
            const isComingSoon = document.getElementById('is-coming-soon-checkbox').checked;
            const releaseDate = document.getElementById('release-date-input').value;
            const releaseTime = document.getElementById('release-time-input').value;
            
            if (!isForRenumbering && (!title || !sinopse || !year)) {
                showCustomModal('Erro de Dados', 'Preencha Título, Sinopse e Ano antes de publicar.', true);
                return null;
            }
            
            let releaseTimestamp = null;
            if (isComingSoon) {
                if (!releaseDate || !releaseTime) {
                    if (!isForRenumbering) showCustomModal('Erro de Agendamento', 'Preencha Data e Hora de Lançamento no campo principal.', true);
                    return null;
                }
                releaseTimestamp = new Date(`${releaseDate}T${releaseTime}:00`).getTime();
            }
            
            // CORREÇÃO: Substitui "Novelas" por "Soap" para salvar no DB se for o caso
            const genresArray = rawGenres.split(',').map(g => {
                const trimmed = g.trim();
                return trimmed === 'Novelas' ? 'Soap' : trimmed;
            }).filter(g => g.length > 0);

            const data = {
                type: type,
                title: title,
                sinopse: sinopse,
                year: year,
                genres: genresArray,
                actors: actors,
                trailer: trailer,
                poster: poster,
                backdrop: backdrop,
                tmdbId: selectedTMDBItem ? selectedTMDBItem.id : null,
                timestamp: Date.now(),
                is_coming_soon: isComingSoon,
                release_timestamp: releaseTimestamp,
                seals: {
                    drive: document.getElementById('seal-drive').checked,
                    telegram: document.getElementById('seal-telegram').checked,
                    premium: document.getElementById('seal-premium').checked,
                    '4k': document.getElementById('seal-4k').checked,
                    cinema_quality: document.getElementById('seal-cinema-quality').checked,
                    maintenance: document.getElementById('seal-maintenance').checked // NOVO SELO
                },
                numRatings: 0,
                ratingSum: 0,
                avgRating: 0 
            };
            
            if (isEditing) {
                const oldContent = allContent.find(c => c.id === editingDocId);
                data.numRatings = oldContent.numRatings || 0;
                data.ratingSum = oldContent.ratingSum || 0;
                data.avgRating = oldContent.avgRating || 0;
                data.view_count = oldContent.view_count || 0;
                data.play_count = oldContent.play_count || 0;
            }

            if (type === 'movie') {
                const links = Array.from(document.querySelectorAll('#movie-links-container .movie-link-input'))
                                .map(input => input.value.trim())
                                .filter(link => link.length > 0);
                
                data.links = links;
            } else {
                const seasonElements = document.getElementById('seasons-container').children;
                const seasons = Array.from(seasonElements).map((seasonEl, index) => {
                    const seasonId = seasonEl.id;
                    
                    const seasonIsComingSoon = document.getElementById(`is-coming-soon-${seasonId}`)?.checked || false;
                    const seasonReleaseDate = document.getElementById(`release-date-${seasonId}`)?.value;
                    const seasonReleaseTime = document.getElementById(`release-time-${seasonId}`)?.value;
                    
                    let seasonReleaseTimestamp = null;
                    if (seasonIsComingSoon && seasonReleaseDate && seasonReleaseTime) {
                         seasonReleaseTimestamp = new Date(`${seasonReleaseDate}T${seasonReleaseTime}:00`).getTime();
                    } else if (seasonIsComingSoon) {
                        if (!isForRenumbering) showCustomModal('Erro de Agendamento', `Preencha Data e Hora de Lançamento para a Temporada ${index + 1}.`, true);
                        if (!isForRenumbering) return null;
                    }
                    
                    const episodeGroups = seasonEl.querySelectorAll('.episode-link-group');
                    const episodes = Array.from(episodeGroups).map(group => {
                        const linkInput = group.querySelector('.episode-link-input');
                        const isScheduled = group.querySelector('.episode-schedule-checkbox')?.checked || false;
                        const dateInput = group.querySelector('.episode-release-date')?.value;
                        const timeInput = group.querySelector('.episode-release-time')?.value;
                        const link = linkInput?.value?.trim() || '';
                        
                        if (link.length === 0) return null;
                        
                        let epReleaseTimestamp = null;
                        if (isScheduled) {
                            if (!dateInput || !timeInput) {
                                if (!isForRenumbering) showCustomModal('Erro de Agendamento', `Preencha Data e Hora para o Episódio ${linkInput.dataset.epNumber} da Temporada ${index + 1}.`, true);
                                if (!isForRenumbering) return null;
                            }
                            epReleaseTimestamp = new Date(`${dateInput}T${timeInput}:00`).getTime();
                        }
                        
                        return {
                            link: link,
                            release_timestamp: epReleaseTimestamp
                        };

                    }).filter(ep => ep !== null);

                    if (!isForRenumbering && !isComingSoon && episodes.length === 0 && document.getElementById('num-seasons-input').value > 0) {
                        if (!isForRenumbering) showCustomModal('Erro', 'As temporadas criadas não têm episódios válidos.', true);
                        return null;
                    }
                    
                    return {
                        number: index + 1,
                        episodes: episodes,
                        is_coming_soon: seasonIsComingSoon,
                        release_timestamp: seasonReleaseTimestamp,
                    };
                }).filter(season => {
                    return season && (isForRenumbering || season.episodes.length > 0 || season.is_coming_soon);
                });

                if (!isForRenumbering && seasons.some(s => s === null)) return null;

                data.seasons = seasons;
            }

            return data;
        }

        window.publishContent = async function() {
            const contentData = collectFormData();
            if (!contentData) return;
            
            setLoading('btn-confirm-publish', true);

            try {
                const collectionPath = `/artifacts/${appId}/public/data/content`;

                if (isEditing) {
                    const docRef = doc(db, collectionPath, editingDocId);
                    
                    const oldContent = allContent.find(c => c.id === editingDocId);
                    const oldSeasons = oldContent?.seasons || [];
                    const newSeasons = contentData.seasons || [];

                    let newEpisodesCount = 0;
                    let isNewSeason = false;

                    if (contentData.type === 'tv') {
                        if (newSeasons.length > oldSeasons.length) {
                            isNewSeason = true;
                        } else if (newSeasons.length >= oldSeasons.length) {
                            newSeasons.forEach((newS, index) => {
                                if (oldSeasons[index] && newS.episodes.length > oldSeasons[index].episodes.length) {
                                    newEpisodesCount += (newS.episodes.length - oldSeasons[index].episodes.length);
                                }
                            });
                        }
                    }

                    if (isNewSeason || newEpisodesCount > 0) {
                        contentData.last_edit_timestamp = Date.now();
                        contentData.new_episodes_count = newEpisodesCount;
                        contentData.is_new_season = isNewSeason;
                    } else {
                        contentData.last_edit_timestamp = oldContent.last_edit_timestamp || 0;
                        contentData.new_episodes_count = 0;
                        contentData.is_new_season = false;
                    }
                    
                    await updateDoc(docRef, contentData);
                    showCustomModal('Sucesso', `Conteúdo "${contentData.title}" editado com sucesso.`);
                } else {
                    contentData.view_count = 0;
                    contentData.play_count = 0;
                    contentData.last_edit_timestamp = 0;
                    contentData.new_episodes_count = 0;
                    contentData.is_new_season = contentData.type === 'tv' && contentData.seasons.length > 0;
                    
                    await addDoc(collection(db, collectionPath), contentData);
                    showCustomModal('Sucesso', `Conteúdo "${contentData.title}" publicado com sucesso.`);
                }
                
                document.getElementById('preview-modal').classList.add('hidden');
                hidePublishModal();
                loadContentToFeed(); 
                loadContentToEdit();
            } catch (e) {
                console.error("Erro ao publicar/editar: ", e);
                showCustomModal('Erro', `Falha na operação: ${e.message}`, false);
            } finally {
                setLoading('btn-confirm-publish', false);
            }
        }
        
        window.loadContentToEdit = async function() {
            switchTab('adminPage');
            document.getElementById('edit-list-container').classList.remove('hidden');
            const listContainer = document.getElementById('published-content-list');
            listContainer.innerHTML = '<p class="text-white/50 text-center">Carregando conteúdo...</p>';
            document.getElementById('admin-search-input').value = '';

            try {
                const collectionPath = `/artifacts/${appId}/public/data/content`;
                const q = query(collection(db, collectionPath), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                const publishedContent = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const renderList = (searchQuery) => {
                    const normalizedQuery = normalizeString(searchQuery);
                    
                    const filtered = publishedContent.filter(data => 
                        normalizeString(data.title).includes(normalizedQuery)
                    );

                    if (filtered.length === 0) {
                        listContainer.innerHTML = '<p class="text-white/50 text-center">Nenhum conteúdo encontrado.</p>';
                        return;
                    }
                    
                    const itemsHtml = filtered.map(data => {
                        const id = data.id;
                        const type = data.type === 'movie' ? 'Filme' : 'Série';
                        const status = data.seals?.maintenance ? '<span class="text-red-500 font-bold ml-1">(RASCUNHO)</span>' : '';
                        const contentJson = JSON.stringify({ id: id, ...data }).replace(/"/g, '&quot;');
                        
                        return `
                            <div class="bg-[#111] p-3 rounded-lg flex justify-between items-center text-sm border border-white/20">
                                <div class="truncate pr-2">
                                    <p class="font-bold text-white truncate">${data.title} <span class="text-xs text-white/50">(${type})</span> ${status}</p>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <button onclick='editContent(${contentJson})' class="text-xs bg-white text-black p-2 rounded-lg font-bold hover:bg-gray-300">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick='confirmDelete("${id}", "${data.title}")' class="text-xs bg-red-700 text-white p-2 rounded-lg font-bold hover:bg-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    listContainer.innerHTML = itemsHtml;
                };

                document.getElementById('admin-search-input').oninput = (e) => renderList(e.target.value);
                renderList('');

            } catch (e) {
                console.error("Erro ao carregar conteúdo para edição:", e);
                listContainer.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar conteúdo.</p>';
            }
        }
        
        window.editContent = function(content) {
            showPublishModal(content);
        }

        window.confirmDelete = function(id, title) {
             const html = `
                <h3 class="text-xl font-bold mb-4 text-red-500">CONFIRMAR EXCLUSÃO</h3>
                <p class="text-white/80 mb-6">Você tem certeza que deseja apagar permanentemente o conteúdo "<span class="font-bold">${title}</span>"?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideCustomModal()" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button onclick="deleteContent('${id}')" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition duration-150 font-medium">
                        APAGAR
                    </button>
                </div>
            `;
            document.getElementById('modal-title').textContent = "CONFIRMAÇÃO";
            document.getElementById('modal-message').innerHTML = ''; 
            document.getElementById('modal-actions').innerHTML = html;
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        window.deleteContent = async function(id) {
            hideCustomModal();
            try {
                const collectionPath = `/artifacts/${appId}/public/data/content`;
                await deleteDoc(doc(db, collectionPath, id));
                showCustomModal('Sucesso', 'Conteúdo apagado com sucesso.', true);
                loadContentToEdit(); 
                loadContentToFeed();
            } catch (e) {
                console.error("Erro ao apagar conteúdo:", e);
                showCustomModal('Erro', 'Falha ao apagar o conteúdo.', true);
            }
        }
        
        const USER_GENRES_PATH = (uid) => `/artifacts/${appId}/users/${uid}/metadata/genres`;
        const WATCH_HISTORY_PATH = (uid) => `/artifacts/${appId}/users/${uid}/watch_history`;


        async function loadUserGenres(uid) {
             try {
                const docRef = doc(db, USER_GENRES_PATH(uid));
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userGenres = docSnap.data().plays || {};
                    } else {
                        userGenres = {};
                    }
                    renderHomePageContent(allContent);
                }, (error) => {
                    console.warn("Falha ao carregar gêneros do usuário:", error.message);
                });
             } catch (e) {
                 console.error("Erro ao configurar listener de gêneros:", e);
             }
        }

        window.incrementGenrePlay = async function(content) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) return;
            
            const docRef = doc(db, USER_GENRES_PATH(user.uid));
            const updates = {};
            
            if (Array.isArray(content.genres)) {
                content.genres.forEach(genre => {
                     updates[`plays.${genre}`] = increment(1);
                });
            }
            
            
            if (Object.keys(updates).length > 0) {
                 try {
                     await updateDoc(docRef, updates);
                 } catch (e) {
                     if (e.code === 'not-found') {
                         await setDoc(docRef, { plays: updates });
                     } else {
                         console.warn("Falha ao incrementar gênero:", e.message);
                     }
                 }
            }
        }
        
        window.updateWatchHistory = async function(content, seasonNumber = null, episodeIndex = null) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous || !showWatchHistory) return;
            
            const historyRef = doc(db, WATCH_HISTORY_PATH(user.uid), content.id);
            
            try {
                const historyData = {
                    contentId: content.id,
                    title: content.title,
                    poster: content.poster,
                    type: content.type,
                    timestamp: Date.now(),
                    season: seasonNumber,
                    episode: episodeIndex,
                };
                
                await setDoc(historyRef, historyData);
            } catch (e) {
                console.warn("Falha ao atualizar histórico:", e.message);
            }
        }

        function checkReleaseStatus(contentOrSeasonOrEpisode, parentSeason = null, isPreview = false) {
             const now = Date.now();
             
             // NOVO: Ignora se estiver em manutenção (rascunho)
             if (contentOrSeasonOrEpisode.seals?.maintenance) {
                 return false;
             }

             if (contentOrSeasonOrEpisode.link && typeof contentOrSeasonOrEpisode.release_timestamp !== 'undefined') {
                  if (contentOrSeasonOrEpisode.release_timestamp) {
                       return contentOrSeasonOrEpisode.release_timestamp < now;
                  }
                  
                  if (parentSeason && parentSeason.is_coming_soon && parentSeason.release_timestamp && !isPreview) {
                      return parentSeason.release_timestamp < now;
                  }
                  
                  if (parentSeason) {
                       const content = allContent.find(c => c.id === currentContentId);
                       if (content && content.is_coming_soon && content.release_timestamp) {
                            return content.release_timestamp < now;
                       }
                  }
                  
                  return true;
             }

             if (contentOrSeasonOrEpisode.number && typeof contentOrSeasonOrEpisode.is_coming_soon !== 'undefined') {
                 if (contentOrSeasonOrEpisode.is_coming_soon && contentOrSeasonOrEpisode.release_timestamp) {
                     return contentOrSeasonOrEpisode.release_timestamp < now;
                 }
                 
                 if (!contentOrSeasonOrEpisode.is_coming_soon) {
                     const content = allContent.find(c => c.id === currentContentId);
                     if (content && content.is_coming_soon && content.release_timestamp) {
                         return content.release_timestamp < now;
                     }
                 }
                 
                 return true;
             }
             
             if (contentOrSeasonOrEpisode.is_coming_soon && contentOrSeasonOrEpisode.release_timestamp) {
                 return contentOrSeasonOrEpisode.release_timestamp < now;
             }
             
             return true;
        }

        // NOVO: Adicionado isTopCarousel para remover selos
        function getSealTagsHtml(data, isTopCarousel = false) {
             const seals = data.seals || {};
             let tags = [];
             
             if (isTopCarousel) {
                 return { typeTag: '', statusTag: '' }; // Não mostra tags no TOP
             }

             if (seals.drive) {
                 tags.push({ text: `${data.type === 'movie' ? 'FILME' : 'SÉRIE'} DRIVE`, color: '#4F46E5', textColor: '#fff' }); 
             }
             if (seals.telegram) {
                 tags.push({ text: `${data.type === 'movie' ? 'FILME' : 'SÉRIE'} TELEGRAM`, color: '#0088CC', textColor: '#fff' }); 
             }
             if (seals.premium) {
                 tags.push({ text: `${data.type === 'movie' ? 'FILME' : 'SÉRIE'} PREMIUM`, color: '#FBBF24', textColor: '#000' }); 
             }

             if (seals['4k']) {
                 tags.push({ text: `4K`, color: '#10B981', textColor: '#fff' }); 
             }
             if (seals.cinema_quality) {
                 tags.push({ text: `CINEMA`, color: '#DC2626', textColor: '#fff' }); 
             }
             
             if (tags.length === 0) {
                 return { typeTag: `<div class="tag-base bg-white text-black" style="left:4px;">${data.type === 'movie' ? 'FILME' : 'SÉRIE'}</div>`, statusTag: '' };
             }

             const typeTag = `<div class="tag-base" style="left:4px; background-color: ${tags[0].color}; color: ${tags[0].textColor};">${tags[0].text}</div>`;
             
             let statusTag = '';
             if (tags.length > 1) {
                 statusTag = `<div class="tag-base" style="right:4px; background-color: ${tags[1].color}; color: ${tags[1].textColor};">${tags[1].text}</div>`;
             }

             return { typeTag, statusTag };
        }


        function createContentCard(data, id, isComingSoonList = false) {
            const classes = "w-1/3 sm:w-1/4 md:w-1/5 lg:w-1/6 xl:w-[12.5%] px-1 flex-shrink-0"; 
            const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            const isReleased = checkReleaseStatus(data);
            
            if (!isComingSoonList && !isReleased) { 
                return '';
            }

            const { typeTag, statusTag } = getSealTagsHtml(data);
            
            let finalStatusTag = statusTag;

            if (!isReleased) {
                finalStatusTag = `<div class="tag-base bg-red-800 text-white" style="right:4px;">EM BREVE</div>`;
            } else if (!finalStatusTag) {
                 let isNewContent = (now - (data.timestamp || 0)) < SEVEN_DAYS_MS; 
                 const isRecentlyEdited = (now - (data.last_edit_timestamp || 0)) < SEVEN_DAYS_MS;
                 
                 if (isNewContent) {
                      finalStatusTag = `<div class="tag-base bg-red-600 text-white" style="right:4px;">NOVO</div>`;
                 } else if (data.type === 'tv' && isRecentlyEdited && data.last_edit_timestamp > data.timestamp) {
                     if (data.is_new_season) {
                         finalStatusTag = `<div class="tag-base" style="background-color: #fca5a5; color: #7f1d1d; right:4px;">NOVA TEMP</div>`;
                     } else if (data.new_episodes_count > 0) {
                         const label = data.new_episodes_count === 1 ? 'NOVO EP' : 'NOVOS EPS';
                         finalStatusTag = `<div class="tag-base" style="background-color: #6ee7b7; color: #065f46; right:4px;">${label}</div>`;
                     }
                 }
            }


             return `
                <div class="${classes}">
                    <div class="bg-[#111] rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-200 relative" onclick="showDetailsModal('${id}')">
                        <div class="content-poster-wrapper">
                            <img src="${data.poster}" class="content-poster-only" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                        </div>
                        
                        ${typeTag}
                        ${finalStatusTag || ''}
                    </div>
                </div>
            `;
        }
        
        // NOVO: isTopCarousel para controle de selos
        function createNumberedContentCard(data, id, rank) {
            const classes = "w-1/3 sm:w-1/4 md:w-1/5 lg:w-1/6 xl:w-[12.5%] px-1 flex-shrink-0 relative"; 
            
            const isReleased = checkReleaseStatus(data);
            if (!isReleased) return '';

            const rankBadge = rank && rank <= 10 ? `
                <div class="absolute top-0 left-0 bg-red-600 text-white text-xl font-black p-1 leading-none rounded-br-lg z-20" 
                     style="box-shadow: 0 0 10px rgba(0,0,0,0.8);">${rank}</div>
            ` : '';
            
            // Note: getSealTagsHtml(data, true) retorna tags vazias para remover outros selos
            const { typeTag } = getSealTagsHtml(data, true); 

             return `
                <div class="${classes}">
                    <div class="bg-[#111] rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-200 relative" onclick="showDetailsModal('${id}')">
                        <div class="content-poster-wrapper">
                            <img src="${data.poster}" class="content-poster-only" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                        </div>
                        ${rankBadge}
                        ${typeTag}
                    </div>
                </div>
            `;
        }


        function createExploreCard(data, id) {
            const classes = "col-span-1";
            const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            const isReleased = checkReleaseStatus(data);

            const { typeTag, statusTag } = getSealTagsHtml(data);
            
            let finalStatusTag = statusTag;

            if (!isReleased) {
                 finalStatusTag = `<div class="tag-base bg-red-800 text-white" style="right:4px;">EM BREVE</div>`;
            } else if (!finalStatusTag) {
                 let isNewContent = (now - (data.timestamp || 0)) < SEVEN_DAYS_MS; 
                 const isRecentlyEdited = (now - (data.last_edit_timestamp || 0)) < SEVEN_DAYS_MS;
                 
                 if (isNewContent) {
                      finalStatusTag = `<div class="tag-base bg-red-600 text-white" style="right:4px;">NOVO</div>`;
                 } else if (data.type === 'tv' && isRecentlyEdited && data.last_edit_timestamp > data.timestamp) {
                     if (data.is_new_season) {
                         finalStatusTag = `<div class="tag-base" style="background-color: #fca5a5; color: #7f1d1d; right:4px;">NOVA TEMP</div>`;
                     } else if (data.new_episodes_count > 0) {
                         const label = data.new_episodes_count === 1 ? 'NOVO EP' : 'NOVOS EPS';
                         finalStatusTag = `<div class="tag-base" style="background-color: #6ee7b7; color: #065f46; right:4px;">${label}</div>`;
                     }
                 }
            }


            return `
                <div class="${classes}">
                    <div class="bg-[#111] rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-200 relative"
                         onclick="showDetailsModal('${id}')">
                        
                        <div class="content-poster-wrapper">
                            <img src="${data.poster}" class="content-poster-only" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                        </div>
                        
                        ${typeTag}
                        ${finalStatusTag || ''}
                    </div>
                </div>
            `;
        }

        let currentContentId = null;
        let isItemInList = false;

        window.showDetailsModal = async function(id) {
            currentContentId = id; 
            const content = allContent.find(c => c.id === id);
            if (!content) return showCustomModal("Erro", "Conteúdo não encontrado.", true);
            
            const currentBaseUrl = window.location.href.split('#')[0];
            history.replaceState(null, null, `${currentBaseUrl}#details=${id}`);
            
            const isReleased = checkReleaseStatus(content);
            const modal = document.getElementById('details-modal');
            const modalContent = document.getElementById('details-modal-content');
            const userIsAuthenticated = auth.currentUser && !auth.currentUser.isAnonymous;
            const userId = auth.currentUser?.uid;
            const myRatingDocRef = userIsAuthenticated ? doc(db, `artifacts/${appId}/public/data/content/${id}/ratings`, userId) : null;
            const isPremiumContent = content.seals?.premium || content.seals?.drive || content.seals?.telegram;
            const is4KContent = content.seals?.['4k'];
            const isMaintenance = content.seals?.maintenance;

            // NOVO: Lógica para bloquear e redirecionar se for Premium/4K e não Premium
            const isPlayLocked = (isPremiumContent || is4KContent) && !window.isPremium;
            const isUnavailable = isMaintenance || !isReleased;

            if (isReleased) {
                try {
                    const docPath = `/artifacts/${appId}/public/data/content/${id}`;
                    const docRef = doc(db, docPath);
                    await updateDoc(docRef, { view_count: increment(1) });
                } catch (e) {
                    console.warn("Falha ao registrar visualização:", e.message);
                }
            }
            
            const btnLista = modal.querySelector('#details-btn-lista');

            async function updateMyListStatus() {
                if (userIsAuthenticated) {
                    const listRef = doc(db, `artifacts/${appId}/users/${userId}/myList`, id);
                    const docSnap = await getDoc(listRef);
                    isItemInList = docSnap.exists();

                    if (isItemInList) {
                        btnLista.innerHTML = '<i class="fas fa-check"></i>';
                        btnLista.classList.add('bg-white', 'text-black');
                        btnLista.classList.remove('bg-white/10', 'text-white');
                        btnLista.title = "Remover da Minha Lista";
                    } else {
                        btnLista.innerHTML = '<i class="fas fa-list-ul"></i>';
                        btnLista.classList.remove('bg-white', 'text-black');
                        btnLista.classList.add('bg-white/10', 'text-white');
                        btnLista.title = "Adicionar à Minha Lista";
                    }
                } else {
                    isItemInList = false;
                    btnLista.innerHTML = '<i class="fas fa-list-ul"></i>';
                    btnLista.classList.remove('bg-white', 'text-black');
                    btnLista.classList.add('bg-white/10', 'text-white');
                    btnLista.title = "Faça login para adicionar";
                }
            }


            modal.querySelector('#details-banner-img').src = 'https://placehold.co/800x450/111/FFF?text=BANNER';
            modal.querySelector('#details-poster-img').src = 'https://placehold.co/150x225/111/FFF?text=POSTER';
            modal.querySelector('#details-title').textContent = 'Carregando...';
            modal.querySelector('#details-meta').textContent = '...';
            modal.querySelector('#details-sinopse').textContent = 'Carregando...';
            modal.querySelector('#details-avg-rating').textContent = '';
            modal.querySelector('#details-view-count').textContent = content.view_count || 0;
            modal.querySelector('#details-rating-count').textContent = content.numRatings || 0;
            modal.querySelector('#details-actors-carousel').innerHTML = '<p class="text-white/50">Carregando elenco...</p>';
            modal.querySelector('#similar-content-carousel').innerHTML = '<p class="text-white/50">Carregando sugestões...</p>';
            
            modal.querySelector('#details-episodes-container').innerHTML = '';
            modal.querySelector('#details-episodes-container').classList.add('hidden');
            modal.querySelector('#details-btn-assistir-movie').classList.add('hidden');
            modal.querySelector('#details-btn-submit-rating').classList.remove('hidden');
            modal.querySelector('#details-btn-my-rating').classList.add('hidden');
            setStarRating(0); 
            modal.querySelector('#rating-comment').value = '';

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            modalContent.scrollTop = 0;

            modal.querySelector('#details-poster-img').src = content.poster || 'https://placehold.co/150x225/111/FFF?text=POSTER';
            modal.querySelector('#details-title').textContent = content.title;
            
            const genresString = Array.isArray(content.genres) ? content.genres.map(g => g === 'Soap' ? 'Novelas' : g).join(', ') : (content.genres || '');
            modal.querySelector('#details-meta').textContent = `${content.type === 'movie' ? 'Filme' : 'Série'} • ${content.year} • ${genresString}`;
            modal.querySelector('#details-sinopse').textContent = content.sinopse;
            
            const btnAssistirMovie = modal.querySelector('#details-btn-assistir-movie');
            
            updateMyListStatus();

            if (isUnavailable) {
                let statusText = isMaintenance ? 'EM MANUTENÇÃO' : 'EM BREVE';
                
                if (!isReleased) {
                    const releaseDate = new Date(content.release_timestamp).toLocaleString('pt-BR');
                    modal.querySelector('#details-meta').textContent += ` | Lançamento: ${releaseDate}`;
                }

                btnAssistirMovie.textContent = statusText;
                btnAssistirMovie.disabled = true;
                btnAssistirMovie.classList.remove('hidden');
                btnAssistirMovie.classList.add('opacity-50', 'cursor-not-allowed', 'bg-red-900/50');
                btnAssistirMovie.classList.remove('btn-gradient');
                btnAssistirMovie.onclick = null;

            } else if (isPlayLocked) {
                btnAssistirMovie.textContent = is4KContent ? 'PREMIUM 4K' : 'PREMIUM';
                btnAssistirMovie.disabled = false; // Permite o clique para o CTA
                btnAssistirMovie.classList.remove('hidden');
                btnAssistirMovie.classList.add('bg-red-700', 'text-white', 'opacity-90', 'cursor-pointer');
                btnAssistirMovie.classList.remove('btn-gradient');
                btnAssistirMovie.onclick = () => showStoreModal(); // NOVO: CTA para a loja
            } else {
                 btnAssistirMovie.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-900/50');
                 btnAssistirMovie.textContent = 'ASSISTIR';
                 btnAssistirMovie.disabled = false; 
                 btnAssistirMovie.classList.remove('bg-red-700', 'text-white', 'opacity-90', 'cursor-pointer');
                 btnAssistirMovie.classList.add('btn-gradient');
            }


            if (content.avgRating) {
                 modal.querySelector('#details-avg-rating').textContent = `⭐ ${content.avgRating.toFixed(1)} (${content.numRatings || 0} avaliações)`;
            }

            const btnTrailer = modal.querySelector('#details-btn-trailer');
            if (content.trailer) {
                btnTrailer.onclick = () => showTrailerModal(content.trailer);
                btnTrailer.disabled = false;
                btnTrailer.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnTrailer.disabled = true;
                 btnTrailer.classList.add('opacity-50', 'cursor-not-allowed');
            }

            btnLista.onclick = async () => {
                await addToList(currentContentId);
                updateMyListStatus(); 
            };
            
            modal.querySelector('#details-btn-reportar').onclick = () => openReportModal(currentContentId);
            modal.querySelector('#details-btn-ver-avaliacoes').onclick = () => openRatingsModal(currentContentId);
            modal.querySelector('#details-btn-submit-rating').onclick = () => submitRating(currentContentId);
            
            document.getElementById('details-btn-my-rating').onclick = () => openMyRatingModal(currentContentId);
            document.getElementById('details-btn-reportar').onclick = () => openReportModal(currentContentId);


            if (userIsAuthenticated) {
                 const myRatingSnap = await getDoc(myRatingDocRef);
                 if (myRatingSnap.exists()) {
                     modal.querySelector('#details-btn-submit-rating').classList.add('hidden');
                     modal.querySelector('#details-btn-my-rating').classList.remove('hidden');
                 } else {
                     modal.querySelector('#details-btn-submit-rating').classList.remove('hidden');
                     modal.querySelector('#details-btn-my-rating').classList.add('hidden');
                 }
            } else {
                 modal.querySelector('#details-btn-submit-rating').classList.remove('hidden');
                 modal.querySelector('#details-btn-my-rating').classList.add('hidden');
            }
            
            // Lógica final para o botão Assistir (só se não for indisponível)
            if (content.type === 'movie' && !isUnavailable) {
                
                btnAssistirMovie.classList.remove('hidden');
                
                if (isReleased && content.links && content.links.length > 0 && !isPlayLocked) {
                    btnAssistirMovie.onclick = async () => {
                         window.open(content.links[0], '_blank'); 

                        try {
                            const docPath = `/artifacts/${appId}/public/data/content/${content.id}`;
                            await updateDoc(doc(db, docPath), { play_count: increment(1) });
                            incrementGenrePlay(content);
                            updateWatchHistory(content);
                        } catch (e) { 
                            console.warn("Falha ao registrar play:", e.message); 
                        }
                    };
                } else if (isReleased && !isPlayLocked) {
                    btnAssistirMovie.disabled = true;
                    btnAssistirMovie.textContent = 'SEM LINKS';
                    btnAssistirMovie.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else if (content.type === 'tv') {
                const episodesContainer = modal.querySelector('#details-episodes-container');
                episodesContainer.classList.remove('hidden');
                // Passa isUnavailable para inibir botões de play de episódios se em manutenção/premium
                renderSeriesEpisodes(episodesContainer, content.seasons, content.id, isReleased, isPlayLocked || isMaintenance); 
            }
            
            loadSimilarContent(content); 

            if (content.tmdbId && content.type) {
                Promise.all([
                    window.fetchTMDBDetails(content.type, content.tmdbId),
                ]).then(([details]) => {
                    if (details) {
                        const bannerUrl = content.backdrop || (details.backdrop_path ? `https://image.tmdb.org/t/p/w1280${details.backdrop_path}` : content.poster);
                        modal.querySelector('#details-banner-img').src = bannerUrl;
                        renderActorCarousel(details.credits?.cast);
                    } else {
                         modal.querySelector('#details-banner-img').src = content.poster;
                         renderActorCarousel(null);
                    }
                }).catch(error => {
                    console.error("Erro ao buscar dados adicionais do TMDb:", error);
                    modal.querySelector('#details-banner-img').src = content.poster;
                    renderActorCarousel(null);
                });
            } else {
                modal.querySelector('#details-banner-img').src = content.poster;
                renderActorCarousel(null);
            }
        }
        
        window.copyDeepLink = function() {
            const id = currentContentId;
            if (!id) return;
            const url = `${window.location.origin}${window.location.pathname}#details=${id}`;
            
            const input = document.createElement('textarea');
            input.value = url;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            
            showCustomModal("Sucesso", "Link do conteúdo copiado!", true);
        }

        window.hideDetailsModal = function() {
            document.getElementById('details-modal').classList.add('hidden');
            document.body.style.overflow = '';
            currentContentId = null; 
            const currentBaseUrl = window.location.href.split('#')[0];
            history.replaceState(null, null, currentBaseUrl); 
        }
        
        window.showTrailerModal = function(videoUrl) {
            if (!videoUrl || !videoUrl.includes('youtube.com/watch?v=')) {
                return showCustomModal("Erro", "Trailer inválido ou não encontrado.", true);
            }

            const videoId = videoUrl.split('v=')[1].split('&')[0];
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;

            document.getElementById('trailer-iframe').src = embedUrl;
            document.getElementById('trailer-modal').classList.remove('hidden');
            document.getElementById('trailer-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
        
        window.closeTrailerModal = function() {
            document.getElementById('trailer-iframe').src = '';
            document.getElementById('trailer-modal').classList.add('hidden');
            document.getElementById('trailer-modal').classList.remove('flex');
            document.body.style.overflow = '';
        }


        function renderSeriesEpisodes(container, seasons, contentId, isContentReleased, isPlayLocked) {
            container.innerHTML = '';
            if (!seasons || seasons.length === 0) {
                container.innerHTML = '<p class="text-white/50 text-center my-4">Nenhum episódio cadastrado.</p>';
                return;
            }
            
            const content = allContent.find(c => c.id === contentId);

            seasons.forEach((season, seasonIndex) => {
                const seasonIsReleased = checkReleaseStatus(season);
                
                const seasonDiv = document.createElement('div');
                seasonDiv.className = 'mb-3 border border-white/10 rounded-lg overflow-hidden';

                const seasonHeader = document.createElement('button');
                seasonHeader.className = 'w-full p-3 bg-white/5 text-left font-bold flex justify-between items-center hover:bg-white/10';
                
                let releaseNote = '';
                if (!seasonIsReleased) {
                    const releaseDate = new Date(season.release_timestamp || content.release_timestamp).toLocaleString('pt-BR');
                    releaseNote = `<span class="text-xs text-red-400 ml-2">(Lançamento: ${releaseDate})</span>`;
                }

                seasonHeader.innerHTML = `
                    <span>Temporada ${season.number}</span>
                    ${releaseNote}
                    <i class="fas fa-chevron-down transition-transform"></i>
                `;
                
                const seasonContent = document.createElement('div');
                seasonContent.className = 'p-3 border-t border-white/10 hidden';
                
                if (!season.episodes || season.episodes.length === 0) {
                     seasonContent.innerHTML = '<p class="text-xs text-white/50">Nenhum episódio nesta temporada.</p>';
                } else {
                    season.episodes.forEach((episode, episodeIndex) => {
                        const episodeReleased = checkReleaseStatus(episode, season);
                        
                        const episodeDiv = document.createElement('div');
                        episodeDiv.className = 'flex items-center justify-between py-2 border-b border-white/5 last:border-b-0';
                        
                        const linkText = `Episódio ${episodeIndex + 1}`;
                        const statusText = !episodeReleased ? (episode.release_timestamp ? 
                             ' (Agendado)' : ' (Em Breve)') : '';
                        
                        const episodeLink = document.createElement('a');
                        episodeLink.className = 'flex-grow text-sm hover:underline mr-4';
                        episodeLink.textContent = linkText + statusText;
                        
                        // Lógica de play: bloqueado se isPlayLocked for true (Premium ou Manutenção)
                        if (episodeReleased && !isPlayLocked) {
                            episodeLink.href = 'javascript:void(0)';
                            episodeLink.onclick = async (e) => {
                                e.preventDefault(); 
                                window.open(episode.link, '_blank');
                                try {
                                    const docPath = `/artifacts/${appId}/public/data/content/${contentId}`;
                                    await updateDoc(doc(db, docPath), { play_count: increment(1) });
                                    incrementGenrePlay(content);
                                    updateWatchHistory(content, season.number, episodeIndex + 1);
                                } catch (e) { console.warn("Falha ao registrar play do episódio:", e.message); }
                            };
                        } else {
                            episodeLink.href = 'javascript:void(0)';
                            episodeLink.classList.add('text-white/40', 'cursor-not-allowed', 'no-underline');
                            episodeLink.onclick = (e) => {
                                e.preventDefault();
                                // Se for bloqueado por Premium, mostra a loja. Se for manutenção, não faz nada.
                                if (isPlayLocked && (content.seals?.premium || content.seals?.['4k'])) showStoreModal();
                            };
                        }


                        const watchedButton = document.createElement('button');
                        watchedButton.className = 'ml-4 text-white/50 hover:text-white text-lg watched-button';
                        watchedButton.title = 'Marcar como visto';
                        watchedButton.dataset.contentId = contentId;
                        watchedButton.dataset.season = season.number;
                        watchedButton.dataset.episodeIndex = episodeIndex; 
                        watchedButton.innerHTML = '<i class="far fa-eye"></i>';
                        watchedButton.onclick = () => toggleEpisodeWatched(watchedButton);
                        watchedButton.disabled = !episodeReleased || isPlayLocked; // Desativa se não lançado ou bloqueado

                        episodeDiv.appendChild(episodeLink);
                        episodeDiv.appendChild(watchedButton);
                        seasonContent.appendChild(episodeDiv);

                        checkEpisodeWatchedState(watchedButton, contentId, season.number, episodeIndex); 
                    });
                }
                
                seasonHeader.onclick = () => {
                    seasonContent.classList.toggle('hidden');
                    seasonHeader.querySelector('i').classList.toggle('rotate-180');
                };

                seasonDiv.appendChild(seasonHeader);
                seasonDiv.appendChild(seasonContent);
                container.appendChild(seasonDiv);
            });
        }

        async function toggleEpisodeWatched(buttonElement) {
            const contentId = buttonElement.dataset.contentId;
            const seasonNumber = buttonElement.dataset.season;
            const episodeIndex = parseInt(buttonElement.dataset.episodeIndex);
            const icon = buttonElement.querySelector('i');
            
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                 return showCustomModal("Aviso", "Faça login para marcar episódios.", true);
            }
            const userId = auth.currentUser.uid;

            const watchedRef = doc(db, `artifacts/${appId}/users/${userId}/watched`, contentId);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(watchedRef);
                    let seasonsWatched = docSnap.exists() ? docSnap.data().seasonsWatched || {} : {};
                    let seasonEpisodes = seasonsWatched[seasonNumber] || [];
                    
                    const isWatched = seasonEpisodes.includes(episodeIndex);

                    if (isWatched) {
                        seasonEpisodes = seasonEpisodes.filter(index => index !== episodeIndex);
                        icon.classList.replace('fas', 'far');
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        buttonElement.title = 'Marcar como visto';
                    } else {
                        seasonEpisodes.push(episodeIndex);
                        icon.classList.replace('far', 'fas');
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        buttonElement.title = 'Marcar como não visto';
                    }
                    
                    seasonsWatched[seasonNumber] = seasonEpisodes.sort((a,b)=> a-b);

                    transaction.set(watchedRef, { seasonsWatched }, { merge: true });
                });

            } catch (error) {
                console.error("Erro ao marcar episódio:", error);
                showCustomModal("Erro", "Não foi possível salvar o estado.", true);
            }
        }

        async function checkEpisodeWatchedState(buttonElement, contentId, seasonNumber, episodeIndex) {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            const userId = auth.currentUser.uid;
            const icon = buttonElement.querySelector('i');

            const watchedRef = doc(db, `artifacts/${appId}/users/${userId}/watched`, contentId);

            try {
                const docSnap = await getDoc(watchedRef);
                if (docSnap.exists()) {
                    const seasonsWatched = docSnap.data().seasonsWatched || {};
                    const seasonEpisodes = seasonsWatched[seasonNumber] || [];
                    if (seasonEpisodes.includes(episodeIndex)) {
                         icon.classList.replace('far', 'fas');
                         icon.classList.remove('fa-eye');
                         icon.classList.add('fa-eye-slash');
                         buttonElement.title = 'Marcar como não visto';
                    } else {
                         icon.classList.replace('fas', 'far');
                         icon.classList.remove('fa-eye-slash');
                         icon.classList.add('fa-eye');
                         buttonElement.title = 'Marcar como visto';
                    }
                } else {
                     icon.classList.replace('fas', 'far');
                     icon.classList.remove('fa-eye-slash');
                     icon.classList.add('fa-eye');
                     buttonElement.title = 'Marcar como visto';
                }
            } catch (error) {
                console.warn("Erro ao verificar estado 'visto':", error);
            }
        }

        function renderActorCarousel(cast) {
            const container = document.getElementById('details-actors-carousel');
            if (!cast || cast.length === 0) {
                container.innerHTML = '<p class="text-white/50">Elenco não disponível.</p>';
                return;
            }
            
            let html = '';
            cast.slice(0, 10).forEach(actor => {
                const profileUrl = actor.profile_path ? `https://image.tmdb.org/t/p/w185${actor.profile_path}` : 'https://placehold.co/150x225/111/FFF?text=?';
                
                html += `
                    <div class="w-24 flex-shrink-0">
                        <div class="text-center">
                            <img src="${profileUrl}" class="actor-image border border-white/20" onerror="this.src='https://placehold.co/80x80/111/FFF?text=?'"/>
                            <h4 class="text-xs font-bold truncate mt-2">${actor.name}</h4>
                            <p class="text-[10px] text-white/50 truncate">${actor.character}</p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function loadSimilarContent(content) {
            const container = document.getElementById('similar-content-carousel');
            if (!container) return;

            const contentGenres = Array.isArray(content.genres) ? content.genres : [];
            container.innerHTML = '<p class="text-white/50">Carregando sugestões...</p>';

            if (contentGenres.length === 0) {
                container.innerHTML = '<p class="text-white/50">Sem sugestões.</p>';
                return;
            }

            const similarItems = allContent
                .map(item => {
                    if (item.id === content.id || !checkReleaseStatus(item)) return null;

                    let matchScore = 0;
                    if (Array.isArray(item.genres)) {
                        item.genres.forEach(g => {
                            if (contentGenres.includes(g)) {
                                matchScore += 1; 
                            }
                        });
                    }
                    
                    if (matchScore > 0) {
                        let relevanceScore = (item.view_count || 0) + (item.numRatings || 0) * 10;
                        return { item: item, score: matchScore * 100 + relevanceScore };
                    }
                    return null;
                })
                .filter(i => i !== null)
                .sort((a, b) => b.score - a.score)
                .slice(0, 10);

            if (similarItems.length === 0) {
                container.innerHTML = '<p class="text-white/50">Sem sugestões.</p>';
                return;
            }

            const html = similarItems.map(wrapper => `
                <div class="w-28 flex-shrink-0" onclick="showDetailsModal('${wrapper.item.id}')">
                    <div class="bg-[#111] rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-200 relative">
                        <div class="content-poster-wrapper h-40">
                             <img src="${wrapper.item.poster}" class="content-poster-only" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                        </div>
                        <p class="text-xs font-bold truncate p-1 text-center">${wrapper.item.title}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        
        let currentRating = 0;
        window.setStarRating = function(stars) {
            currentRating = stars;
            const starIcons = document.querySelectorAll('#rating-stars-input .rating-star');
            starIcons.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                if (starValue <= stars) {
                    star.classList.replace('far', 'fas');
                } else {
                    star.classList.replace('fas', 'far');
                }
            });
        }
        
        window.submitRating = async function(contentId) {
            if (!auth.currentUser || auth.currentUser.isAnonymous || !auth.currentUser.email) {
                return showCustomModal("Aviso", "Apenas usuários logados com e-mail e senha podem avaliar.", true);
            }
            if (currentRating === 0) {
                 return showCustomModal("Aviso", "Selecione pelo menos uma estrela.", true);
            }
            
            const userId = auth.currentUser.uid;
            const comment = document.getElementById('rating-comment').value.trim();
            const newRatingScore = currentRating;
            
            setLoading('details-btn-submit-rating', true);

            const contentRef = doc(db, `artifacts/${appId}/public/data/content`, contentId);
            const ratingRef = doc(db, `artifacts/${appId}/public/data/content/${contentId}/ratings`, userId);

            try {
                await runTransaction(db, async (transaction) => {
                    const contentDoc = await transaction.get(contentRef);
                    const oldRatingDoc = await transaction.get(ratingRef);

                    const oldRatingScore = oldRatingDoc.exists() ? oldRatingDoc.data().rating : 0;
                    const isNewRating = !oldRatingDoc.exists();

                    const currentNum = contentDoc.data().numRatings || 0;
                    const currentSum = contentDoc.data().ratingSum || 0;

                    let newNum = currentNum;
                    let newSum = currentSum;

                    if (isNewRating) {
                        newNum = currentNum + 1;
                        newSum = currentSum + newRatingScore;
                    } else {
                        newSum = currentSum - oldRatingScore + newRatingScore;
                    }

                    const newAvg = newNum > 0 ? (newSum / newNum) : 0;

                    transaction.update(contentRef, {
                        numRatings: newNum,
                        ratingSum: newSum,
                        avgRating: newAvg
                    });

                    transaction.set(ratingRef, {
                        userId: userId,
                        displayName: auth.currentUser.displayName || 'Usuário',
                        photoURL: auth.currentUser.photoURL || '',
                        rating: newRatingScore,
                        comment: comment,
                        timestamp: Date.now()
                    });
                });
                
                showCustomModal("Sucesso", "Sua avaliação foi enviada!", true);
                showDetailsModal(contentId); 
            } catch (error) {
                console.error("Erro ao enviar avaliação:", error);
                showCustomModal("Erro", "Não foi possível enviar sua avaliação. Detalhes: " + (error.message || error), true);
            } finally {
                 setLoading('details-btn-submit-rating', false);
            }
        }
        
        window.openMyRatingModal = async function(contentId) {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            const userId = auth.currentUser.uid;
            
            const ratingRef = doc(db, `artifacts/${appId}/public/data/content/${contentId}/ratings`, userId);
            const docSnap = await getDoc(ratingRef);

            if (!docSnap.exists()) return showCustomModal("Erro", "Sua avaliação não foi encontrada.", true);

            const data = docSnap.data();
            const modal = document.getElementById('my-rating-modal');
            const commentInput = modal.querySelector('#my-rating-comment');
            const starsContainer = modal.querySelector('#my-rating-stars');
            
            let currentEditRating = data.rating; 
            
            starsContainer.innerHTML = Array(5).fill(0).map((_, i) => {
                const isFilled = i < currentEditRating;
                return `<i class="${isFilled ? 'fas' : 'far'} fa-star rating-star text-4xl transition duration-100" data-value="${i + 1}" onclick="updateMyRatingStars(${i + 1})"></i>`;
            }).join('');
            
            window.updateMyRatingStars = function(stars) {
                currentEditRating = stars;
                starsContainer.querySelectorAll('.rating-star').forEach(star => {
                    const starValue = parseInt(star.getAttribute('data-value'));
                    if (starValue <= stars) {
                        star.classList.replace('far', 'fas');
                    } else {
                        star.classList.replace('fas', 'far');
                    }
                });
            };

            commentInput.value = data.comment || '';
            
            document.getElementById('btn-update-rating').onclick = () => updateMyRating(contentId, currentEditRating, commentInput.value.trim());
            document.getElementById('btn-delete-rating').onclick = () => confirmDeleteRating(contentId);

            modal.classList.remove('hidden');
        }

        window.updateMyRating = async function(contentId, newRating, newComment) {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            const userId = auth.currentUser.uid;
            if (newRating === 0) return showCustomModal("Aviso", "Selecione pelo menos uma estrela.", true);
            
            setLoading('btn-update-rating', true);
            
            const contentRef = doc(db, `artifacts/${appId}/public/data/content`, contentId);
            const ratingRef = doc(db, `artifacts/${appId}/public/data/content/${contentId}/ratings`, userId);

            try {
                await runTransaction(db, async (transaction) => {
                    const contentDoc = await transaction.get(contentRef);
                    const oldRatingDoc = await transaction.get(ratingRef);

                    const oldRatingScore = oldRatingDoc.exists() ? oldRatingDoc.data().rating : 0;
                    
                    const currentNum = contentDoc.data().numRatings || 0;
                    const currentSum = contentDoc.data().ratingSum || 0;

                    
                    const newSum = currentSum - oldRatingScore + newRating;
                    const newAvg = currentNum > 0 ? (newSum / currentNum) : 0;

                    transaction.update(contentRef, {
                        ratingSum: newSum,
                        avgRating: newAvg
                    });

                    transaction.update(ratingRef, {
                        rating: newRating,
                        comment: newComment,
                        timestamp: Date.now()
                    });
                });
                
                document.getElementById('my-rating-modal').classList.add('hidden');
                showCustomModal("Sucesso", "Sua avaliação foi atualizada!", true);
                showDetailsModal(contentId); 
            } catch (error) {
                 console.error("Erro ao atualizar avaliação:", error);
                 showCustomModal("Erro", "Não foi possível salvar a edição. Detalhes: " + (error.message || error), true);
            } finally {
                 setLoading('btn-update-rating', false);
            }
        }
        
        window.confirmDeleteRating = function(contentId) {
             const html = `
                <h3 class="text-xl font-bold mb-4 text-red-500">CONFIRMAR EXCLUSÃO</h3>
                <p class="text-white/80 mb-6">Tem certeza que deseja apagar permanentemente <span class="font-bold">sua avaliação</span>?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="document.getElementById('my-rating-modal').classList.remove('hidden'); hideCustomModal();" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button onclick="deleteMyRating('${contentId}')" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition duration-150 font-medium">
                        SIM, EXCLUIR
                    </button>
                </div>
            `;
            document.getElementById('my-rating-modal').classList.add('hidden');
            document.getElementById('modal-title').textContent = "CONFIRMAÇÃO";
            document.getElementById('modal-message').innerHTML = ''; 
            document.getElementById('modal-actions').innerHTML = html;
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        window.deleteMyRating = async function(contentId) {
             hideCustomModal();
             if (!auth.currentUser || auth.currentUser.isAnonymous) return;
             const userId = auth.currentUser.uid;
             
             const contentRef = doc(db, `artifacts/${appId}/public/data/content`, contentId);
             const ratingRef = doc(db, `artifacts/${appId}/public/data/content/${contentId}/ratings`, userId);

             try {
                 await runTransaction(db, async (transaction) => {
                    const contentDoc = await transaction.get(contentRef);
                    const oldRatingDoc = await transaction.get(ratingRef);
                    
                    if (!oldRatingDoc.exists()) throw new Error("Avaliação não existe para exclusão.");

                    const oldRatingScore = oldRatingDoc.data().rating;
                    
                    const currentNum = contentDoc.data().numRatings || 0;
                    const currentSum = contentDoc.data().ratingSum || 0;
                    
                    const newNum = currentNum - 1;
                    const newSum = currentSum - oldRatingScore;
                    const newAvg = newNum > 0 ? (newSum / newNum) : 0;

                    transaction.update(contentRef, {
                        numRatings: newNum,
                        ratingSum: newSum,
                        avgRating: newAvg
                    });
                    
                    transaction.delete(ratingRef); 
                });
                 
                 showCustomModal("Excluída", "Sua avaliação foi removida.", true);
                 showDetailsModal(contentId); 
             } catch (error) {
                  console.error("Erro ao excluir avaliação:", error);
                  showCustomModal("Erro", "Não foi possível excluir a avaliação. Detalhes: " + (error.message || error), true);
             }
        }
        
        window.openRatingsModal = async function(contentId) {
            const container = document.getElementById('ratings-list-container');
            container.innerHTML = '<p class="text-white/50 text-center">Carregando avaliações...</p>';
            document.getElementById('ratings-modal').classList.remove('hidden');

            try {
                const ratingsRef = collection(db, `artifacts/${appId}/public/data/content/${contentId}/ratings`);
                const q = query(ratingsRef, orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-white/50 text-center">Nenhuma avaliação ainda.</p>';
                    return;
                }

                const ratingsHtml = snapshot.docs.map(doc => {
                   const data = doc.data();
                   const starsHtml = Array(5).fill(0).map((_, i) => 
                       `<i class="${i < data.rating ? 'fas fa-star text-yellow-500' : 'far fa-star text-gray-500'}"></i>`
                   ).join('');
                   
                   return `<div class="bg-[#111] p-3 rounded-lg border border-white/20">
                               <div class="flex items-center mb-2">
                                  <img src="${data.photoURL || 'https://placehold.co/32x32/111/FFF?text=?'}" class="w-8 h-8 rounded-full mr-3 border border-white/20" 
                                       onerror="this.src='https://placehold.co/32x32/111/FFF?text=?'"/>
                                  <div class="flex-grow">
                                      <p class="text-sm font-bold">${data.displayName}</p>
                                      <p class="text-xs text-yellow-500">${starsHtml}</p>
                                  </div>
                                  <span class="text-xs text-white/40 flex-shrink-0">${new Date(data.timestamp).toLocaleDateString()}</span>
                               </div>
                               ${data.comment ? `<p class="text-sm text-white/80 italic mt-1 ml-11">"${data.comment}"</p>` : ''}
                           </div>`;
                }).join('');
                container.innerHTML = ratingsHtml;

            } catch (error) {
                 console.error("Erro ao carregar avaliações:", error);
                 container.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar avaliações.</p>';
            }
        }

        window.openReportModal = function(contentId) {
            document.getElementById('report-reason').value = '';
            document.querySelectorAll('input[name="reportType"]').forEach(radio => radio.checked = false);
            document.getElementById('report-modal').classList.remove('hidden');
            document.getElementById('report-submit-btn').onclick = () => submitReport(contentId);
        }

        window.submitReport = async function(contentId) {
            const reason = document.getElementById('report-reason').value.trim();
            const reportType = document.querySelector('input[name="reportType"]:checked')?.value;
            
            if (!reportType) {
                return showCustomModal("Erro", "Selecione o tipo de problema antes de enviar.", true);
            }
            if (reason.length < 10) {
                return showCustomModal("Erro", "Por favor, descreva o problema com mais detalhes (mínimo 10 caracteres).", true);
            }
            
            const content = allContent.find(c => c.id === contentId);

            const reportData = {
                contentId: contentId,
                contentTitle: content?.title || 'Título desconhecido',
                reportType: reportType,
                reason: reason,
                userId: auth.currentUser?.uid || 'anônimo',
                userName: auth.currentUser?.displayName || (auth.currentUser?.isAnonymous ? 'Anônimo' : 'Usuário Não Logado'),
                timestamp: Date.now(),
                status: 'pending'
            };

            setLoading('report-submit-btn', true);
            try {
                const reportRef = collection(db, `/artifacts/${appId}/public/data/reports`);
                await addDoc(reportRef, reportData);
                showCustomModal("Obrigado!", "Seu reporte foi enviado e será analisado.", true);
                document.getElementById('report-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao enviar reporte:", error);
                showCustomModal("Erro", "Não foi possível enviar o reporte.", true);
            } finally {
                 setLoading('report-submit-btn', false);
            }
        }
        
        window.loadReports = async function() {
            switchTab('adminPage');
            showReportsListModal();
            const container = document.getElementById('reports-list-container');
            container.innerHTML = '<p class="text-white/50 text-center">Carregando relatórios...</p>';
            
            try {
                const reportsRef = collection(db, `/artifacts/${appId}/public/data/reports`);
                const q = query(reportsRef, orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-white/50 text-center">Nenhum relatório pendente.</p>';
                    return;
                }
                
                const reportsHtml = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const reportId = doc.id;
                    const content = allContent.find(c => c.id === data.contentId);
                    const reportTitle = content ? content.title : data.contentTitle;
                    
                    return `
                        <div class="bg-[#111] p-3 rounded-lg border border-red-700/50 space-y-2">
                            <div class="flex justify-between items-start border-b border-white/20 pb-2">
                                <div>
                                    <p class="font-bold text-red-400">Tipo: ${data.reportType}</p>
                                    <p class="text-sm">Conteúdo: <span class="font-bold">${reportTitle}</span></p>
                                    <p class="text-xs text-white/50">Reportado por: ${data.userName} (UID: ${data.userId.substring(0, 8)}...)</p>
                                </div>
                                <span class="text-xs text-white/40 flex-shrink-0">${new Date(data.timestamp).toLocaleString()}</span>
                            </div>
                            <p class="text-sm text-white/80 italic leading-relaxed">"${data.reason}"</p>
                            <div class="flex justify-end space-x-2 pt-2">
                                <button onclick="showDetailsModal('${data.contentId}'); document.getElementById('reports-list-modal').classList.add('hidden');" class="text-xs bg-white text-black px-3 py-1 rounded-lg font-bold hover:bg-gray-300">
                                    VER CONTEÚDO
                                </button>
                                <button onclick="confirmDeleteReport('${reportId}')" class="text-xs bg-red-700 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-800">
                                    EXCLUIR RELATÓRIO
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = reportsHtml;

            } catch (error) {
                console.error("Erro ao carregar relatórios:", error);
                container.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar relatórios.</p>';
            }
        }
        
        window.confirmDeleteReport = function(reportId) {
             const html = `
                <h3 class="text-xl font-bold mb-4 text-red-500">CONFIRMAR EXCLUSÃO</h3>
                <p class="text-white/80 mb-6">Você tem certeza que deseja apagar permanentemente este relatório?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="document.getElementById('reports-list-modal').classList.remove('hidden'); hideCustomModal();" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition duration-150 font-medium">
                        Cancelar
                    </button>
                    <button onclick="deleteReport('${reportId}')" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition duration-150 font-medium">
                        APAGAR
                    </button>
                </div>
            `;
            document.getElementById('reports-list-modal').classList.add('hidden');
            document.getElementById('modal-title').textContent = "CONFIRMAÇÃO";
            document.getElementById('modal-message').innerHTML = ''; 
            document.getElementById('modal-actions').innerHTML = html;
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }
        
        window.deleteReport = async function(reportId) {
             hideCustomModal();
             try {
                 const reportRef = doc(db, `/artifacts/${appId}/public/data/reports`, reportId);
                 await deleteDoc(reportRef);
                 showCustomModal("Excluído", "Relatório removido.", true);
                 loadReports(); 
             } catch (error) {
                  console.error("Erro ao excluir relatório:", error);
                  showCustomModal("Erro", "Não foi possível excluir o relatório.", true);
             }
        }


        window.addToList = async function(contentId) {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                return showCustomModal("Aviso", "Você precisa fazer login para adicionar à sua lista.", true);
            }
            const userId = auth.currentUser.uid;
            const listRef = doc(db, `artifacts/${appId}/users/${userId}/myList`, contentId);

            try {
                const docSnap = await getDoc(listRef);
                if (docSnap.exists()) {
                     await deleteDoc(listRef);
                     isItemInList = false;
                     showCustomModal("Removido", "Item removido da sua lista.", true);
                } else {
                     const contentData = allContent.find(c => c.id === contentId);
                     await setDoc(listRef, { 
                         addedAt: Date.now(),
                         title: contentData?.title || 'Desconhecido',
                         poster: contentData?.poster || ''
                     });
                     isItemInList = true;
                     showCustomModal("Adicionado", "Item adicionado à sua lista!", true);
                }

            } catch (error) {
                console.error("Erro ao adicionar/remover da lista:", error);
                showCustomModal("Erro", "Não foi possível atualizar sua lista.", true);
            }
        }
        
        window.renderMyList = function() {
            const container = document.getElementById('my-list-container');
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                container.innerHTML = '<p class="text-white/50 text-center col-span-full">Faça login para gerenciar sua lista.</p>';
                container.classList.remove('grid');
                return;
            }
            
            container.innerHTML = '<p class="text-white/50 text-center col-span-full">Carregando sua lista...</p>';
            
            const listRef = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/myList`);
            const q = query(listRef, orderBy("addedAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-white/50 text-center col-span-full">Sua lista está vazia.</p>';
                    container.classList.remove('grid');
                    return;
                }
                
                container.classList.add('grid');
                let html = snapshot.docs.map(doc => {
                    const id = doc.id;
                    const content = allContent.find(c => c.id === id);
                    if (!content) return ''; 

                    return `
                        <div class="relative group" onclick="showDetailsModal('${id}')">
                             <div class="content-poster-wrapper">
                                <img src="${content.poster}" class="content-poster-only rounded-lg cursor-pointer" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                            </div>
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center">
                                <i class="fas fa-eye text-white text-3xl"></i>
                            </div>
                            <button onclick="event.stopPropagation(); addToList('${id}')" 
                                    class="absolute top-2 right-2 bg-red-700 p-2 rounded-full text-white hover:bg-red-800"
                                    title="Remover da lista">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            }, (error) => {
                 console.error("Erro ao carregar lista:", error);
                 container.innerHTML = '<p class="text-red-500 text-center col-span-full">Erro ao carregar sua lista.</p>';
                 container.classList.remove('grid');
            });
        }


        function renderBanner(contentList) {
            clearInterval(bannerInterval);
            const container = document.getElementById('main-banner-container');
            container.innerHTML = '';
            
            const releasedContent = contentList.filter(item => checkReleaseStatus(item));
            
            const bannerItems = [...releasedContent].sort((a, b) => b.timestamp - a.timestamp)
                               .filter(item => item.backdrop)
                               .slice(0, 5);
            
            if (bannerItems.length === 0) return;

            let currentBannerIndex = 0;

            const updateBanner = () => {
                const item = bannerItems[currentBannerIndex % bannerItems.length];
                const imageUrl = item.backdrop || item.poster;
                
                container.innerHTML = `
                    <div class="relative w-full h-80 overflow-hidden banner-container bg-cover bg-center rounded-xl" 
                         style="background-image: url('${imageUrl}');" onclick="showDetailsModal('${item.id}')">
                        <div class="absolute inset-0 bg-black/40 flex flex-col items-start justify-end p-6">
                            <h3 class="text-3xl font-bold mb-2">${item.title}</h3>
                            <p class="text-sm text-white/70 mb-4 truncate w-full">${item.sinopse}</p>
                            <button class="px-6 py-2 btn-gradient rounded-full font-bold shadow-xl text-sm">
                                SAIBA MAIS
                            </button>
                        </div>
                    </div>
                `;
                currentBannerIndex++;
                if (currentBannerIndex >= bannerItems.length) {
                    currentBannerIndex = 0; 
                }
            };
            
            updateBanner(); 
            bannerInterval = setInterval(updateBanner, 4000);
        }
        
        function createEpisodeCard(content, seasonNumber, episodeNumber, releaseTimestamp) {
            const classes = "w-1/3 sm:w-1/4 md:w-1/5 lg:w-1/6 xl:w-[12.5%] px-1 flex-shrink-0";
            const isReleased = releaseTimestamp < Date.now();
            
            let statusTag = '';
            let dateText = '';
            
            if (!isReleased) {
                const releaseDate = new Date(releaseTimestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const releaseTime = new Date(releaseTimestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                statusTag = `<div class="tag-base bg-red-600 text-white text-[10px] py-1 px-2" style="right:4px;">E${episodeNumber} EM BREVE</div>`;
                dateText = `<p class="text-xs text-red-400 font-bold mt-1">${releaseDate} às ${releaseTime}</p>`;
            } else {
                 return '';
            }

            return `
                <div class="${classes}">
                    <div class="bg-[#111] rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-200 relative" onclick="showDetailsModal('${content.id}')">
                        <div class="content-poster-wrapper">
                            <img src="${content.poster}" class="content-poster-only" onerror="this.src='https://placehold.co/150x225/111/FFF?text=POSTER'"/>
                        </div>
                        
                        <div class="tag-base bg-white text-black text-[10px] py-1 px-2" style="left:4px;">T${seasonNumber}</div>
                        ${statusTag}

                        <div class="p-2 text-center">
                            <h4 class="text-sm font-bold truncate">${content.title}</h4>
                            ${dateText}
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderCarousel(dataList, title, containerId, isNumbered = false) {
            const container = document.getElementById(containerId);
            
            if (dataList.length === 0) {
                container.innerHTML = '';
                return;
            }

            let displayTitle = title;
            let html = `<h3 class="text-xl font-bold text-white mb-3 mt-6">${displayTitle}</h3>`; 
            html += `<div class="carousel-container space-x-2">`;
            
            // OTIMIZAÇÃO: Limita a renderização ao máximo de itens do carrossel
            const contentToRender = dataList.slice(0, MAX_CAROUSEL_ITEMS);
            
            let itemsRendered = 0;
            contentToRender.forEach((item, index) => {
                let cardHtml = '';
                if (isNumbered) {
                     cardHtml = createNumberedContentCard(item, item.id, index + 1);
                } else {
                    cardHtml = createContentCard(item, item.id);
                }

                if (cardHtml !== '') {
                    html += cardHtml;
                    itemsRendered++;
                }
            });
            
            if (itemsRendered === 0) {
                 container.innerHTML = '';
                 return;
            }

            html += `</div>`;
            
            // Adiciona o botão "Ver Mais" se houver mais conteúdo do que o limite
            if (dataList.length > MAX_CAROUSEL_ITEMS) {
                html += `
                    <div class="mt-4 text-center">
                        <button onclick="showGridPage('${title}')" 
                                class="px-6 py-2 bg-white/10 text-white rounded-full font-bold hover:bg-white/20 transition duration-150 text-sm">
                            VER MAIS (${dataList.length}) <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                `;
            }


            container.innerHTML = html;
        }
        
        async function renderWatchHistory() {
             const user = auth.currentUser;
             const containerId = 'watch-history-carousel';
             const container = document.getElementById('carousels-container');
             
             const existing = document.getElementById(containerId);
             if (!user || user.isAnonymous || !showWatchHistory) {
                 if (existing) existing.remove();
                 return;
             }
             
             try {
                 const historyRef = collection(db, WATCH_HISTORY_PATH(user.uid));
                 const q = query(historyRef, orderBy("timestamp", "desc")); 
                 const snapshot = await getDocs(q);
                 
                 const historyItems = snapshot.docs.map(doc => {
                     const data = doc.data();
                     const fullContent = allContent.find(c => c.id === data.contentId);
                     return fullContent ? { ...fullContent, history: data } : null;
                 }).filter(item => item && checkReleaseStatus(item));
                 
                 let existingContainer = document.getElementById(containerId);
                 if (!existingContainer) {
                     container.insertAdjacentHTML('afterbegin', `<div id="${containerId}"></div>`);
                     existingContainer = document.getElementById(containerId);
                 }
                 
                 if (historyItems.length > 0) {
                     carouselFilterMap["Continuar Assistindo"] = historyItems.map(c => c.id);
                     renderCarousel(historyItems, "Continuar Assistindo", containerId);
                 } else {
                     existingContainer.innerHTML = '';
                 }
             } catch (e) {
                 console.warn("Falha ao carregar histórico de visualização:", e.message);
             }
        }

        function sortByRating(contentList, ascending = false) {
            return [...contentList]
                .filter(item => item.numRatings >= MIN_RATINGS_FOR_VALIDITY)
                .sort((a, b) => {
                    const ratingA = a.avgRating || 0;
                    const ratingB = b.avgRating || 0;
                    return ascending ? ratingA - ratingB : ratingB - ratingA;
                });
        }

        function sortByPlayCount(contentList) {
            return [...contentList]
                .sort((a, b) => {
                    const countA = a.play_count || 0;
                    const countB = b.play_count || 0;
                    return countB - countA;
                });
        }
        
        function isSeasonal(month, day) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentDay = now.getDate();
            
            const targetMonth = month - 1; 

            if (targetMonth === 9 && day === 31) {
                 return (currentMonth === 9 && currentDay >= 20) ||
                        (currentMonth === 10 && currentDay <= 5);
            }
            
            if (targetMonth === 11 && day === 25) {
                 return (currentMonth === 11 && currentDay >= 15) ||
                        (currentMonth === 0 && currentDay <= 5);
            }
            
            return false;
        }

        async function fetchNowPlayingMovies() {
            const url = `https://api.themoviedb.org/3/movie/now_playing?language=pt-BR&page=1`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${TMDB_ACCESS_TOKEN}`, 'accept': 'application/json' }
                });
                if (!response.ok) return [];
                const data = await response.json();
                
                const tmdbMovieTitles = data.results.map(movie => movie.title.toLowerCase());

                return allContent.filter(content => 
                    content.type === 'movie' && 
                    checkReleaseStatus(content) &&
                    tmdbMovieTitles.includes(content.title.toLowerCase())
                );

            } catch (e) {
                console.error("Erro ao buscar filmes 'Now Playing' no TMDb:", e);
                return [];
            }
        }


        function renderHomePageContent(contentList) {
            const carouselsContainer = document.getElementById('carousels-container');
            carouselsContainer.innerHTML = '';
            carouselFilterMap = {}; // OTIMIZAÇÃO: Reset do mapa

            const loadingMessage = document.getElementById('feed-loading-message');
            
            // Filtra conteúdo não em manutenção e lançado
            const releasedContent = contentList.filter(item => checkReleaseStatus(item));
            const movies = releasedContent.filter(c => c.type === 'movie');
            const tv = releasedContent.filter(c => c.type === 'tv');

            // Conteúdo que ainda não foi lançado, mas não está em manutenção
            const comingSoonContent = contentList.filter(item => !item.seals?.maintenance && !checkReleaseStatus(item));
            
            const comingSoonMoviesAndSeries = comingSoonContent
                .filter(c => c.type === 'movie' || (c.type === 'tv' && (!c.seasons || c.seasons.length === 0)))
                .sort((a, b) => a.release_timestamp - b.release_timestamp); 

            let upcomingEpisodes = [];
            contentList.filter(c => c.type === 'tv' && !c.seals?.maintenance).forEach(series => {
                series.seasons?.forEach(season => {
                    season.episodes.forEach((episode, epIndex) => {
                        const epReleaseTimestamp = episode.release_timestamp || season.release_timestamp || series.release_timestamp;
                        
                        if (epReleaseTimestamp && epReleaseTimestamp > Date.now()) {
                            upcomingEpisodes.push({
                                id: `${series.id}-${season.number}-${epIndex + 1}`,
                                contentId: series.id,
                                title: series.title,
                                poster: series.poster,
                                season: season.number,
                                episode: epIndex + 1,
                                release_timestamp: epReleaseTimestamp
                            });
                        }
                    });
                });
            });
            
            upcomingEpisodes.sort((a, b) => a.release_timestamp - b.release_timestamp);
            
            if (contentList.length === 0) {
                 loadingMessage.textContent = "Nenhum conteúdo publicado ainda.";
                 loadingMessage.classList.remove('hidden');
                 return;
            }
            
            loadingMessage.classList.add('hidden');
            
            renderBanner(releasedContent);
            
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                renderWatchHistory();
            }
            
            // Lançamentos do Ano Atual
            const currentYear = new Date().getFullYear().toString();
            const currentYearReleases = releasedContent.filter(c => c.year === currentYear);
            
            if (currentYearReleases.length > 0) {
                carouselsContainer.insertAdjacentHTML('beforeend', '<div id="current-year-releases-carousel"></div>');
                carouselFilterMap[`Lançamentos de ${currentYear}`] = currentYearReleases.map(c => c.id);
                renderCarousel(currentYearReleases.sort((a, b) => b.timestamp - a.timestamp), `Lançamentos de ${currentYear}`, 'current-year-releases-carousel');
            }


            // Em Cartaz
            fetchNowPlayingMovies().then(inCinemaContent => {
                 if (inCinemaContent.length > 0) {
                     carouselsContainer.insertAdjacentHTML('beforeend', '<div id="in-cinema-carousel"></div>');
                     carouselFilterMap["Em Cartaz no Cinema"] = inCinemaContent.map(c => c.id);
                     renderCarousel(inCinemaContent, "Em Cartaz no Cinema", 'in-cinema-carousel');
                 }
            });


            const recentContent = [...releasedContent].sort((a, b) => b.timestamp - a.timestamp);
            if (recentContent.length > 0) {
                carouselsContainer.insertAdjacentHTML('beforeend', '<div id="recent-all-carousel"></div>');
                carouselFilterMap["Adicionados Recentemente"] = recentContent.map(c => c.id);
                renderCarousel(recentContent, "Adicionados Recentemente", 'recent-all-carousel');
            }
            
            
            if (upcomingEpisodes.length > 0) {
                 const upcomingEpisodesHtml = upcomingEpisodes.slice(0, MAX_CAROUSEL_ITEMS).map(item => {
                     const fullContent = allContent.find(c => c.id === item.contentId);
                     if (!fullContent) return '';
                     return createEpisodeCard(fullContent, item.season, item.episode, item.release_timestamp);
                 }).join('');
                 
                 if (upcomingEpisodesHtml) {
                    carouselsContainer.insertAdjacentHTML('beforeend', `
                        <div id="upcoming-episodes-carousel">
                            <h3 class="text-xl font-bold text-white mb-3 mt-6">Próximos Episódios</h3>
                            <div class="carousel-container space-x-2">${upcomingEpisodesHtml}</div>
                        </div>
                    `);
                 }
            }

            if (comingSoonMoviesAndSeries.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="coming-soon-movies-series-carousel"></div>');
                 carouselFilterMap["Em Breve"] = comingSoonMoviesAndSeries.map(c => c.id);
                 renderCarousel(comingSoonMoviesAndSeries, "Em Breve", 'coming-soon-movies-series-carousel');
            }
            
            const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
            const recentUpdates = tv.filter(c => 
                c.last_edit_timestamp &&
                (Date.now() - c.last_edit_timestamp) < SEVEN_DAYS_MS &&
                c.last_edit_timestamp > c.timestamp
            ).sort((a, b) => b.last_edit_timestamp - a.last_edit_timestamp);

            if (recentUpdates.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="new-episodes-carousel"></div>');
                 carouselFilterMap["Novos Episódios/Temporadas"] = recentUpdates.map(c => c.id);
                 renderCarousel(recentUpdates, "Novos Episódios/Temporadas", 'new-episodes-carousel');
            }

            // TOP Filmes e Séries (Numerado)
            const topMovies = sortByPlayCount(movies);
            if (topMovies.length > 0) {
                const containerId = 'top-movies-carousel';
                carouselsContainer.insertAdjacentHTML('beforeend', `<div id="${containerId}"></div>`);
                carouselFilterMap["Top Filmes (Mais Vistos)"] = topMovies.map(c => c.id);
                renderCarousel(topMovies, "Top Filmes (Mais Vistos)", containerId, true);
            }

            const topTV = sortByPlayCount(tv);
            if (topTV.length > 0) {
                const containerId = 'top-tv-carousel';
                carouselsContainer.insertAdjacentHTML('beforeend', `<div id="${containerId}"></div>`);
                carouselFilterMap["Top Séries (Mais Vistas)"] = topTV.map(c => c.id);
                renderCarousel(topTV, "Top Séries (Mais Vistas)", containerId, true);
            }

            const premiumContent = releasedContent.filter(c => c.seals?.premium);
            if (premiumContent.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="premium-carousel"></div>');
                 carouselFilterMap["Catálogo Premium"] = premiumContent.map(c => c.id);
                 renderCarousel(premiumContent, "Catálogo Premium", 'premium-carousel');
            }
            
            const driveContent = releasedContent.filter(c => c.seals?.drive);
            if (driveContent.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="drive-carousel"></div>');
                 carouselFilterMap["Drives Exclusivos"] = driveContent.map(c => c.id);
                 renderCarousel(driveContent, "Drives Exclusivos", 'drive-carousel');
            }
            
            const telegramContent = releasedContent.filter(c => c.seals?.telegram);
            if (telegramContent.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="telegram-carousel"></div>');
                 carouselFilterMap["Canais Telegram"] = telegramContent.map(c => c.id);
                 renderCarousel(telegramContent, "Canais Telegram", 'telegram-carousel');
            }

            const fourKContent = movies.filter(c => c.seals?.['4k']);
            if (fourKContent.length > 0) {
                 carouselsContainer.insertAdjacentHTML('beforeend', '<div id="4k-carousel"></div>');
                 carouselFilterMap[`Filmes em 4K${window.isPremium ? '' : ' (Premium)'}`] = fourKContent.map(c => c.id);
                 renderCarousel(fourKContent, ` Filmes em 4K${window.isPremium ? '' : ' (Premium)'}`, '4k-carousel');
            }


            const topRated = sortByRating(releasedContent);
            if (topRated.length > 0) {
                carouselsContainer.insertAdjacentHTML('beforeend', '<div id="top-rated-carousel"></div>');
                carouselFilterMap[`⭐ Mais Bem Avaliados (mín. ${MIN_RATINGS_FOR_VALIDITY} avaliações)`] = topRated.map(c => c.id);
                renderCarousel(topRated, `⭐ Mais Bem Avaliados (mín. ${MIN_RATINGS_FOR_VALIDITY} avaliações)`, 'top-rated-carousel');
            }

            const worstRated = sortByRating(releasedContent, true);
            if (worstRated.length > 0) {
                carouselsContainer.insertAdjacentHTML('beforeend', '<div id="worst-rated-carousel"></div>');
                carouselFilterMap[`💀 Piores Avaliados (mín. ${MIN_RATINGS_FOR_VALIDITY} avaliações)`] = worstRated.map(c => c.id);
                renderCarousel(worstRated, `💀 Piores Avaliados (mín. ${MIN_RATINGS_FOR_VALIDITY} avaliações)`, 'worst-rated-carousel');
            }

            if (isSeasonal(10, 31)) {
                 const halloweenContent = releasedContent.filter(c => 
                     Array.isArray(c.genres) && (c.genres.includes('Terror') || c.genres.includes('Horror') || c.genres.includes('Suspense'))
                 );
                 if (halloweenContent.length > 0) {
                     carouselsContainer.insertAdjacentHTML('beforeend', '<div id="halloween-carousel"></div>');
                     carouselFilterMap["🎃 Especial de Halloween 👻"] = halloweenContent.map(c => c.id);
                     renderCarousel(halloweenContent.sort(() => 0.5 - Math.random()), "🎃 Especial de Halloween 👻", 'halloween-carousel');
                 }
            }

            if (isSeasonal(12, 25)) {
                 const christmasContent = releasedContent.filter(c => 
                     Array.isArray(c.genres) && (c.genres.includes('Natal') || c.genres.includes('Familiar'))
                 );
                 if (christmasContent.length > 0) {
                     carouselsContainer.insertAdjacentHTML('beforeend', '<div id="christmas-carousel"></div>');
                     carouselFilterMap["🎄 Clássicos de Natal 🎅"] = christmasContent.map(c => c.id);
                     renderCarousel(christmasContent.sort(() => 0.5 - Math.random()), "🎄 Clássicos de Natal 🎅", 'christmas-carousel');
                 }
            }


            const existingGenres = new Set();
            
            releasedContent.forEach(item => {
                if (Array.isArray(item.genres)) {
                    item.genres.forEach(g => {
                        // CORREÇÃO: Mapeia Soap para Novelas para exibição
                        existingGenres.add(g === 'Soap' ? 'Novelas' : g);
                    });
                }
            });
            
            Array.from(existingGenres).filter(g => {
                const cleanGenre = g.replace(/\s/g, '').replace(/[^a-zA-Z]/g, '');
                return cleanGenre.length > 0;
            }).sort().forEach(genre => {
                const genreTitle = `Seção de ${genre}`;
                const genreId = genre.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, '');
                
                const filteredContent = releasedContent.filter(c => {
                    const actualGenres = (Array.isArray(c.genres) ? c.genres : []).map(g => g === 'Soap' ? 'Novelas' : g);
                    return actualGenres.includes(genre);
                });

                if (filteredContent.length > 0) {
                    carouselsContainer.insertAdjacentHTML('beforeend', `<div id="carousel-${genreId}"></div>`);
                    carouselFilterMap[genreTitle] = filteredContent.map(c => c.id);
                    renderCarousel(filteredContent, genreTitle, `carousel-${genreId}`);
                }
            });
            
            if (currentPageId === 'explorePage') {
                 renderExploreGrid();
                 renderPremiumExploreGrid();
            }
            if (currentPageId === 'premiumPage' && window.isPremium) {
                 renderPremiumCatalog();
            }
        }
        
        // NOVO: Renderiza o catálogo premium no explore
        window.renderPremiumExploreGrid = function() {
            const gridContainer = document.getElementById('premium-explore-grid');
            
            const premiumContent = allContent.filter(item => {
                 return checkReleaseStatus(item) && !item.seals?.maintenance && (item.seals?.drive || item.seals?.telegram || item.seals?.premium);
            }).sort((a, b) => b.timestamp - a.timestamp);

            if (premiumContent.length === 0) {
                gridContainer.innerHTML = '<p class="text-white/50 text-center col-span-full">Nenhum conteúdo Premium disponível no momento.</p>';
            } else {
                const html = premiumContent.map(item => createExploreCard(item, item.id)).join('');
                gridContainer.innerHTML = html;
            }
        }
        
        window.renderComingSoonGrid = function() {
             const gridContainer = document.getElementById('coming-soon-grid-container');
             const noResults = document.getElementById('coming-soon-no-results');
             
             const comingSoon = allContent.filter(item => !item.seals?.maintenance && !checkReleaseStatus(item)).sort((a, b) => a.release_timestamp - b.release_timestamp);
            
             if (comingSoon.length === 0) {
                 gridContainer.innerHTML = '';
                 noResults.classList.remove('hidden');
                 return;
             }
             
             noResults.classList.add('hidden');

             const soonHtml = comingSoon.map(item => {
                  const classes = "col-span-1"; 
                  return `
                     <div class="${classes}">
                         ${createExploreCard(item, item.id)}
                     </div>
                 `;
             }).join('');

             gridContainer.innerHTML = soonHtml;
        }

        window.loadContentToFeed = function() {
            const collectionPath = `/artifacts/${appId}/public/data/content`;
            const q = query(collection(db, collectionPath), orderBy("timestamp", "desc"));
            
            document.getElementById('feed-loading-message').classList.remove('hidden');
            document.getElementById('feed-loading-message').textContent = "Carregando conteúdo...";


            onSnapshot(q, (snapshot) => {
                allContent = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const releasedCount = allContent.filter(item => checkReleaseStatus(item)).length;
                document.getElementById('explore-total-count').textContent = releasedCount.toString();
                
                renderHomePageContent(allContent);
                
                populateExploreFilters(allContent.filter(item => checkReleaseStatus(item)));
                
                if (currentPageId === 'explorePage') {
                     renderExploreGrid();
                     renderPremiumExploreGrid();
                }

                if (!contentLoaded) {
                    contentLoaded = true;
                    handleDeepLink();
                }

            }, (error) => {
                console.error("Erro ao carregar feed em tempo real:", error);
                document.getElementById('feed-loading-message').textContent = 'Erro ao carregar o feed.';
                document.getElementById('feed-loading-message').classList.remove('hidden');
            });
        }
        
        
        function populateExploreFilters(content) {
            const genreSelect = document.getElementById('explore-genre-filter');
            const yearSelect = document.getElementById('explore-year-filter');
            
            const currentGenre = exploreFilters.genre;
            const currentYear = exploreFilters.year;

            const genres = new Set();
            content.forEach(item => {
                if (Array.isArray(item.genres)) {
                    item.genres.forEach(g => {
                         // CORREÇÃO: Mapeia Soap para Novelas para exibição
                        genres.add(g === 'Soap' ? 'Novelas' : g);
                    });
                }
            });
            
            genreSelect.innerHTML = '<option value="all">Todos os Gêneros</option>';
            Array.from(genres).filter(g => g.length > 0).sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });
            genreSelect.value = currentGenre;

            const years = new Set();
            content.forEach(item => {
                if (item.year && item.year.length === 4) {
                    years.add(item.year);
                }
            });

            yearSelect.innerHTML = '<option value="all">Todos os Anos</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => { 
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            yearSelect.value = currentYear;
        }

        function initializeExplorePage() {
            const searchInput = document.getElementById('explore-search-input');
            const typeFilters = document.querySelectorAll('.explore-type-filter');
            const genreFilter = document.getElementById('explore-genre-filter');
            const yearFilter = document.getElementById('explore-year-filter');
            const sortFilter = document.getElementById('explore-sort-filter');
            const clearFiltersButton = document.getElementById('explore-clear-filters');

            const handler = () => {
                exploreFilters.search = normalizeString(searchInput.value.trim());
                exploreFilters.type = document.querySelector('.explore-type-filter.bg-white')?.dataset.type || 'all';
                exploreFilters.genre = genreFilter.value;
                exploreFilters.year = yearFilter.value;
                exploreFilters.sort = sortFilter.value;
                
                renderExploreGrid();
                renderPremiumExploreGrid();
            };
            
            searchInput.oninput = handler;
            genreFilter.onchange = handler;
            yearFilter.onchange = handler;
            sortFilter.onchange = handler;

            typeFilters.forEach(button => {
                button.onclick = (e) => {
                    exploreFilters.type = e.target.dataset.type;
                    
                    typeFilters.forEach(btn => {
                        if (btn.dataset.type === exploreFilters.type) {
                            btn.classList.replace('bg-white/10', 'bg-white');
                            btn.classList.replace('text-white', 'text-black');
                        } else {
                            btn.classList.replace('bg-white', 'bg-white/10');
                            btn.classList.replace('text-black', 'text-white');
                        }
                    });
                    handler(); 
                };
            });
            
            clearFiltersButton.onclick = () => {
                exploreFilters = {
                    search: '',
                    type: 'all', 
                    genre: 'all',
                    year: 'all',
                    sort: 'recent'
                };
                searchInput.value = '';
                genreFilter.value = 'all';
                yearFilter.value = 'all';
                sortFilter.value = 'recent';
                
                document.querySelector('.explore-type-filter[data-type="all"]').click();
            };

            document.querySelector('.explore-type-filter[data-type="all"]').classList.remove('bg-white/10', 'text-white');
            document.querySelector('.explore-type-filter[data-type="all"]').classList.add('bg-white', 'text-black');
        }

        function renderExploreGrid() {
            const gridContainer = document.getElementById('explore-grid-container');
            const noResults = document.getElementById('explore-no-results');
            const clearFiltersButton = document.getElementById('explore-clear-filters');
            
            const searchTerms = exploreFilters.search;
            
            let filteredContent = allContent.filter(item => {
                if (!checkReleaseStatus(item)) return false; 
                if (item.seals?.maintenance) return false; // Ignora Manutenção
                
                const normalizedTitle = normalizeString(item.title);
                const normalizedSinopse = normalizeString(item.sinopse);
                const normalizedActors = normalizeString(item.actors || '');

                const matchesSearch = !searchTerms || 
                                      normalizedTitle.includes(searchTerms) ||
                                      normalizedSinopse.includes(searchTerms) ||
                                      normalizedActors.includes(searchTerms);
                                      
                const matchesType = exploreFilters.type === 'all' || item.type === exploreFilters.type;
                
                // Mapeia para "Novelas" antes de verificar
                let actualGenres = (Array.isArray(item.genres) ? item.genres : []).map(g => g === 'Soap' ? 'Novelas' : g);

                const matchesGenre = exploreFilters.genre === 'all' || actualGenres.includes(exploreFilters.genre);
                
                const matchesYear = exploreFilters.year === 'all' || item.year === exploreFilters.year;
                
                return matchesSearch && matchesType && matchesGenre && matchesYear;
            });
            
            filteredContent.sort((a, b) => {
                if (exploreFilters.sort === 'az') {
                    return a.title.localeCompare(b.title);
                } 
                if (exploreFilters.sort === 'recent') {
                    return b.timestamp - a.timestamp; 
                }
                if (exploreFilters.sort === 'rating') {
                    const ratingA = a.avgRating || 0;
                    const ratingB = b.avgRating || 0;
                    return ratingB - ratingA;
                }
                if (exploreFilters.sort === 'views') {
                    const viewsA = a.view_count || 0;
                    const viewsB = b.view_count || 0;
                    return viewsB - viewsA;
                }
                return 0;
            });

            if (filteredContent.length === 0) {
                gridContainer.innerHTML = '';
                noResults.classList.remove('hidden');
            } else {
                const html = filteredContent.map(item => createExploreCard(item, item.id)).join('');
                gridContainer.innerHTML = html;
                noResults.classList.add('hidden');
            }
            
            const isFiltered = exploreFilters.search !== '' || exploreFilters.type !== 'all' || 
                               exploreFilters.genre !== 'all' || exploreFilters.year !== 'all' ||
                               exploreFilters.sort !== 'recent';
            
            clearFiltersButton.classList.toggle('hidden', !isFiltered);
        }
        
        let tmdbTimeout = null;
        const searchInputTMDB = document.getElementById('tmdb-search-input');
        const suggestionsContainer = document.getElementById('tmdb-suggestions');

        searchInputTMDB.addEventListener('input', () => {
            clearTimeout(tmdbTimeout);
            const query = searchInputTMDB.value.trim();
            suggestionsContainer.classList.add('hidden');
            
            if (query.length < 3) return;

            tmdbTimeout = setTimeout(() => {
                fetchTMDB(query);
            }, 500);
        });

        async function fetchTMDB(query) {
            const url = `https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(query)}&include_adult=false&language=pt-BR&page=1`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${TMDB_ACCESS_TOKEN}`,
                        'accept': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Falha na API do TMDb');

                const data = await response.json();
                displayTMDBSuggestions(data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv'));
            } catch (error) {
                console.error("Erro na busca TMDb:", error);
            }
        }

        function displayTMDBSuggestions(results) {
            suggestionsContainer.innerHTML = '';
            
            if (results.length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            results.slice(0, 5).forEach(item => {
                const title = item.media_type === 'movie' ? item.title : item.name;
                const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                const type = item.media_type === 'movie' ? 'Filme' : 'Série';
                const posterUrl = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : 'https://placehold.co/32x48/111/FFF?text=?';

                const element = document.createElement('div');
                element.className = 'suggestion-item p-3 cursor-pointer text-sm flex items-center border-b border-white/10 last:border-b-0';
                element.innerHTML = `
                    <img src="${posterUrl}" class="tmdb-suggestion-poster rounded mr-3" onerror="this.src='https://placehold.co/32x48/111/FFF?text=?'"/>
                    <div class="flex-grow">
                        <span class="font-semibold">${title}</span>
                        <span class="text-xs text-white/50 block">${type} (${year})</span>
                    </div>
                `;
                element.onclick = () => window.selectTMDBItem(item); 
                suggestionsContainer.appendChild(element);
            });
            
            suggestionsContainer.classList.remove('hidden');
        }

        let genreCache = { movie: {}, tv: {} };

        window.fetchGenreNames = async function(ids, type) {
            if (ids.length === 0) return '';
            
            const genreType = type === 'movie' ? 'movie' : 'tv';
            
            if (Object.keys(genreCache[genreType]).length === 0) {
                const url = `https://api.themoviedb.org/3/genre/${genreType}/list?language=pt-BR`;
                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${TMDB_ACCESS_TOKEN}`, 'accept': 'application/json' }
                    });
                    const data = await response.json();
                    data.genres.forEach(genre => {
                        genreCache[genreType][genre.id] = genre.name;
                    });
                } catch (e) {
                    console.error("Falha ao buscar lista de gêneros:", e);
                    return ids.join(', '); 
                }
            }

            // CORREÇÃO: Substitui "Soap" por "Novelas" na saída, se necessário
            return ids.map(id => {
                const name = genreCache[genreType][id] || 'Desconhecido';
                return name === 'Soap' ? 'Novelas' : name; 
            }).join(', ');
        }


        window.fetchTMDBDetails = async function(type, id) {
            const url = `https://api.themoviedb.org/3/${type}/${id}?append_to_response=credits,videos&language=pt-BR`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${TMDB_ACCESS_TOKEN}`,
                        'accept': 'application/json'
                    }
                });
                return response.ok ? await response.json() : null;
            } catch (error) {
                console.error("Erro ao buscar detalhes TMDb:", error);
                return null;
            }
        }
        
        window.selectTMDBItem = async function(item) {
            selectedTMDBItem = item;
            suggestionsContainer.classList.add('hidden');
            document.getElementById('tmdb-search-input').value = item.media_type === 'movie' ? item.title : item.name;
            
            document.getElementById('content-type').value = item.media_type;
            document.getElementById('title-input').value = item.media_type === 'movie' ? item.title : item.name;
            document.getElementById('sinopse-input').value = item.overview || 'Sem sinopse disponível.';
            document.getElementById('year-input').value = (item.release_date || item.first_air_date || '').substring(0, 4);
            
            const genres = item.genre_ids ? await window.fetchGenreNames(item.genre_ids, item.media_type) : '';
            document.getElementById('genres-input').value = genres;

            document.getElementById('poster-preview').src = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://placehold.co/160x240/111/FFF?text=POSTER';
            
            document.getElementById('backdrop-input').value = item.backdrop_path ? `https://image.tmdb.org/t/p/w1280${item.backdrop_path}` : '';
            
            document.getElementById('tmdb-info-text').textContent = `TMDb ID: ${item.id}`;
            
            toggleContentForm(item.media_type);

            const details = await window.fetchTMDBDetails(item.media_type, item.id);
            
            if (details) {
                const actors = details.credits?.cast.slice(0, 5).map(c => c.name).join(', ') || 'Não listado';
                document.getElementById('actors-input').value = actors;

                const trailer = details.videos?.results.find(v => v.site === 'YouTube' && v.type === 'Trailer') || details.videos?.results[0];
                document.getElementById('trailer-input').value = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : '';
            }
            
            document.getElementById('seasons-container').innerHTML = '';
            document.getElementById('movie-links-container').innerHTML = '';
            
            if (item.media_type === 'movie') {
                addLinkInput('movie');
            } else if (item.media_type === 'tv') {
                 document.getElementById('num-seasons-input').value = 1;
                 generateSeasonForms(); 
            }
        }

        initializeExplorePage();
        authenticateUser();
        loadContentToFeed();
    </script>
</body>
</html>
