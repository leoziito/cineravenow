<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cinerave - Premium Experience</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Syncopate:wght@700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CORE COLORS --- */
        :root {
            --bg-body: #050505;
            --nav-height: 70px; 
            --header-height: 80px;
        }

        body {
            background-color: var(--bg-body);
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden; 
            height: 100vh;
            height: 100dvh;
        }

        /* --- METALLIC ANIMATION --- */
        .text-metallic-live {
            background: linear-gradient(
                110deg, 
                #8c8c8c 10%,   
                #ffffff 25%,   
                #a1a1aa 40%,   
                #ffffff 55%,   
                #71717a 70%,   
                #8c8c8c 90%    
            );
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine-flow 4s linear infinite;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));
            cursor: pointer;
            user-select: none;
        }

        @keyframes shine-flow {
            to { background-position: 200% center; }
        }

        /* --- IMMERSIVE NAV --- */
        .nav-immersive {
            background: linear-gradient(to top, #000000 30%, rgba(0,0,0,0.9) 70%, rgba(0,0,0,0) 100%);
            backdrop-filter: blur(5px);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- UTILS --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .nav-btn.active svg { stroke: #ffffff; filter: drop-shadow(0 0 8px rgba(255,255,255,0.6)); }
        .nav-btn.active span { color: white; font-weight: 600; }
        .nav-btn svg { transition: all 0.3s ease; }

        .nav-btn.admin-active svg { stroke: #ef4444; filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6)); }
        .nav-btn.admin-active span { color: #ef4444; font-weight: 600; }

        /* --- FORM ELEMENTS --- */
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.08);
        }

        /* --- MODAL --- */
        .glass-modal {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        .toast {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { border-color: rgba(239, 68, 68, 0.3); color: #fca5a5; }

        /* Loader Spinner */
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CINEMA STYLES --- */
        .cinema-screen {
            background: #000;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.08); 
        }
        
        .chat-bubble {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(4px);
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 85%;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .chat-container {
            position: relative;
            display: flex;
            flex-direction: column;
            flex: 1;
            background: linear-gradient(to bottom, #0a0a0a, #000000);
            overflow: hidden;
        }

        .chat-messages-scroll {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        .chat-input-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 20;
        }

        .center-vertical {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 100px;
        }

        /* --- BATCH STYLES --- */
        .batch-slot {
            transition: all 0.3s ease;
        }
        .batch-slot:hover {
            background: rgba(255,255,255,0.02);
        }
    </style>
</head>
<body class="flex flex-col h-screen relative selection:bg-white selection:text-black">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- MODAL DELETION PREVIEW -->
    <div id="delete-preview-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-md p-6 fade-in">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-6 text-center">
            <h3 class="text-white font-bold mb-4 uppercase tracking-widest text-sm">Confirmar Exclusão</h3>
            <div class="bg-zinc-900 rounded-lg p-3 mb-6 border border-zinc-800 flex gap-4 items-center text-left">
                <img id="del-preview-img" src="" class="w-12 h-16 object-cover rounded bg-zinc-800">
                <div>
                    <p id="del-preview-title" class="text-white font-bold text-sm line-clamp-2"></p>
                    <p class="text-[10px] text-zinc-500">Esta ação não pode ser desfeita.</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('delete-preview-modal').classList.add('hidden')" class="flex-1 py-3 rounded-lg text-sm text-zinc-500 hover:text-white transition-colors bg-zinc-900">Cancelar</button>
                <button id="btn-confirm-delete" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">Excluir</button>
            </div>
        </div>
    </div>

    <!-- INFO MOVIE MODAL -->
    <div id="movie-info-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md p-6 fade-in" onclick="closeMovieInfo()">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-0 overflow-hidden" onclick="event.stopPropagation()">
            <div class="relative h-64">
                <img id="modal-movie-poster" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                <button onclick="closeMovieInfo()" class="absolute top-4 right-4 bg-black/50 p-2 rounded-full text-white hover:bg-white/20 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 relative -top-6">
                <h3 id="modal-movie-title" class="text-2xl font-['Syncopate'] font-bold text-white mb-2 leading-tight">Título do Filme</h3>
                <p id="modal-movie-overview" class="text-sm text-zinc-400 leading-relaxed max-h-40 overflow-y-auto pr-2 no-scrollbar">Sinopse do filme...</p>
            </div>
        </div>
    </div>

    <!-- ADMIN MODAL (Login) -->
    <div id="admin-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6 fade-in">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-6 text-center">
            <div class="mb-4">
                <i data-lucide="shield-alert" class="w-12 h-12 text-zinc-500 mx-auto mb-2"></i>
                <h3 class="text-lg font-light text-white tracking-widest uppercase">Acesso Restrito</h3>
            </div>
            <input type="password" id="admin-password" placeholder="Senha de Admin" class="glass-input w-full p-3 rounded-lg text-center text-lg mb-4 tracking-widest">
            <div class="flex gap-2">
                <button onclick="closeAdminModal()" class="flex-1 py-3 rounded-lg text-sm text-zinc-500 hover:text-white transition-colors">Cancelar</button>
                <button onclick="checkAdminAccess()" class="flex-1 bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition-colors">Acessar</button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 left-0 w-full z-40 flex items-center justify-center pt-8 pb-4 bg-gradient-to-b from-black via-black/80 to-transparent pointer-events-none">
        <h1 id="app-logo" onclick="handleLogoClick()" class="font-['Syncopate'] text-3xl font-bold text-metallic-live pointer-events-auto select-none active:scale-95 transition-transform">
            CINERAVE
        </h1>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 w-full max-w-md mx-auto h-full overflow-hidden relative z-10 flex flex-col">
        
        <!-- SECTION: INÍCIO -->
        <section id="tab-inicio" class="tab-content fade-in block h-full overflow-y-auto no-scrollbar pt-24 pb-32 px-6">
            <div class="flex flex-col items-center justify-center h-[60vh] text-center space-y-4 opacity-50">
                <i data-lucide="clapperboard" class="w-16 h-16 text-zinc-800"></i>
                <h2 class="text-xl text-zinc-600 font-light tracking-widest uppercase">Início</h2>
                <p class="text-xs text-zinc-700">Bem-vindo ao Cinerave.</p>
            </div>
        </section>

        <!-- SECTION: BUSCA -->
        <section id="tab-busca" class="tab-content hidden h-full overflow-y-auto no-scrollbar pt-24 pb-32 px-6">
            <div class="w-full h-12 bg-zinc-900/80 rounded-full border border-zinc-800 flex items-center px-4 mb-8">
                <i data-lucide="search" class="w-4 h-4 text-zinc-500 mr-3"></i>
                <input type="text" placeholder="Buscar filmes, séries..." class="bg-transparent w-full text-sm text-zinc-300 placeholder-zinc-600 focus:outline-none">
            </div>
            <div class="flex flex-col items-center justify-center h-[40vh] text-center space-y-4 opacity-50">
                <i data-lucide="search" class="w-16 h-16 text-zinc-800"></i>
                <p class="text-xs text-zinc-700">Em implementação.</p>
            </div>
        </section>

        <!-- SECTION: CINEMA -->
        <section id="tab-cinema" class="tab-content hidden flex flex-col w-full h-[100dvh] pt-[80px] pb-[70px]">
            
            <!-- BAN SCREEN -->
            <div id="ban-screen" class="hidden absolute inset-0 z-50 bg-black flex flex-col items-center justify-center text-center p-6">
                <i data-lucide="ban" class="w-16 h-16 text-red-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Acesso Suspenso</h2>
                <p class="text-zinc-400 text-sm mb-4">Violação das diretrizes.</p>
                <div class="bg-zinc-900 px-4 py-2 rounded border border-zinc-800">
                    <p class="text-xs text-zinc-500 uppercase">Liberado em:</p>
                    <p id="ban-timer" class="text-lg font-mono text-white">00:00:00</p>
                </div>
            </div>

            <!-- PLAYER -->
            <div class="w-full bg-black/50 shrink-0 relative z-20 pb-2 backdrop-blur-sm border-b border-zinc-900/50">
                <div class="mx-4 mt-2 rounded-xl overflow-hidden cinema-screen aspect-video border border-zinc-800/50 relative group">
                    <video id="cinema-player" class="w-full h-full object-contain pointer-events-none bg-black" playsinline></video>
                    
                    <div id="cinema-poster-overlay" class="absolute inset-0 bg-black flex flex-col items-center justify-center z-10">
                        <img id="cinema-poster-img" src="" class="absolute inset-0 w-full h-full object-cover opacity-30 hidden">
                        <div class="relative z-20 flex flex-col items-center">
                            <i data-lucide="film" class="w-8 h-8 text-zinc-700 mb-2"></i>
                            <span class="text-[9px] text-zinc-600 uppercase tracking-widest">Aguardando</span>
                        </div>
                    </div>

                    <div id="sound-overlay" onclick="toggleMute()" class="absolute inset-0 flex items-center justify-center bg-black/40 z-30 cursor-pointer hidden backdrop-blur-[2px]">
                        <div class="bg-white/10 p-2 rounded-full border border-white/20 animate-pulse">
                            <i data-lucide="volume-x" class="w-5 h-5 text-white"></i>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3 px-4">
                    <h2 id="now-playing-title" onclick="openMovieInfo()" class="text-sm font-['Syncopate'] font-bold text-white tracking-widest truncate cursor-pointer hover:text-zinc-300 transition-colors">
                        Aguardando Sessão...
                    </h2>
                    
                    <div class="flex justify-center items-center gap-4 mt-2">
                        <div class="flex items-center gap-1.5 bg-zinc-900/80 px-2 py-1 rounded-full border border-zinc-800" title="Pessoas na sala agora">
                            <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                            <i data-lucide="users" class="w-3 h-3 text-zinc-400"></i>
                            <span id="viewer-count" class="text-[10px] font-mono text-zinc-300">0</span>
                        </div>

                        <button id="btn-next-up" onclick="toggleNextUp()" class="hidden items-center gap-1.5 bg-zinc-900/80 px-2 py-1 rounded-full border border-zinc-800 hover:bg-zinc-800 transition-colors">
                            <span class="text-[10px] text-zinc-400 uppercase font-bold">A Seguir</span>
                            <i data-lucide="chevron-down" id="icon-next-up" class="w-3 h-3 text-zinc-400 transition-transform"></i>
                        </button>
                    </div>

                    <div id="next-up-list" class="hidden mt-3 bg-zinc-900/90 rounded-lg border border-zinc-800 p-2 text-left max-h-32 overflow-y-auto no-scrollbar shadow-lg relative z-50"></div>
                </div>
            </div>

            <!-- CHAT -->
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages-scroll no-scrollbar"></div>
                <div class="chat-input-wrapper">
                    <div class="flex-1 flex items-center gap-2 bg-zinc-800/50 border border-zinc-700/50 rounded-full p-1 pl-4">
                        <input type="text" id="chat-input" class="flex-1 bg-transparent text-sm text-white focus:outline-none placeholder-zinc-500 h-9" placeholder="Digite sua mensagem...">
                        <button onclick="sendMessage()" class="w-9 h-9 bg-white text-black rounded-full flex items-center justify-center hover:bg-gray-200 active:scale-95 transition-all shadow-md" id="btn-send-chat">
                            <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: PERFIL -->
        <section id="tab-perfil" class="tab-content hidden h-full overflow-y-auto no-scrollbar px-6 pb-32 pt-24">
            <div class="center-vertical h-full">
                <div id="auth-loading" class="flex flex-col items-center justify-center">
                    <div class="loader w-8 h-8 border-4"></div>
                </div>

                <div id="auth-forms" class="hidden flex-col gap-6 w-full max-w-xs mx-auto">
                    <!-- Login -->
                    <div id="form-login" class="fade-in w-full">
                        <h2 class="text-2xl font-light text-white mb-8 text-center tracking-wide">Bem-vindo</h2>
                        <div class="space-y-4">
                            <input type="email" id="login-email" class="glass-input w-full p-4 rounded-xl text-sm" placeholder="Email">
                            <div class="relative">
                                <input type="password" id="login-password" class="glass-input w-full p-4 rounded-xl text-sm pr-12" placeholder="Senha">
                                <button onclick="togglePassword('login-password')" class="absolute right-4 top-4 text-zinc-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button>
                            </div>
                            <button id="btn-login" class="w-full bg-white text-black font-semibold p-4 rounded-xl hover:bg-gray-200 transition-colors mt-2 shadow-lg">Entrar</button>
                        </div>
                        <div class="mt-8 text-center text-xs text-zinc-500">
                            Não tem conta? <button onclick="toggleAuthMode('register')" class="text-white underline ml-1 font-medium">Criar agora</button>
                        </div>
                    </div>

                    <!-- Cadastro -->
                    <div id="form-register" class="hidden fade-in w-full">
                        <h2 class="text-2xl font-light text-white mb-8 text-center tracking-wide">Criar Conta</h2>
                        <div class="flex flex-col items-center mb-6">
                            <div class="relative group cursor-pointer" onclick="document.getElementById('reg-avatar').click()">
                                <div class="w-24 h-24 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center overflow-hidden shadow-2xl">
                                    <img id="avatar-preview" src="" class="w-full h-full object-cover hidden">
                                    <i id="avatar-icon" data-lucide="camera" class="w-8 h-8 text-zinc-600"></i>
                                </div>
                                <div class="absolute bottom-0 right-0 bg-white rounded-full p-1.5 shadow-md"><i data-lucide="plus" class="w-3 h-3 text-black"></i></div>
                            </div>
                            <input type="file" id="reg-avatar" accept="image/*" class="hidden" onchange="previewAvatar(event)">
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="reg-name" class="glass-input w-full p-4 rounded-xl text-sm" placeholder="Nome">
                            <input type="email" id="reg-email" class="glass-input w-full p-4 rounded-xl text-sm" placeholder="Email">
                            <input type="password" id="reg-password" class="glass-input w-full p-4 rounded-xl text-sm" placeholder="Senha">
                            <button id="btn-register" class="w-full bg-white text-black font-semibold p-4 rounded-xl hover:bg-gray-200 transition-colors mt-2 shadow-lg">Criar Conta</button>
                        </div>
                        <div class="mt-8 text-center text-xs text-zinc-500">
                            Já tem conta? <button onclick="toggleAuthMode('login')" class="text-white underline ml-1 font-medium">Entrar</button>
                        </div>
                    </div>
                </div>

                <div id="user-profile" class="hidden flex-col items-center fade-in w-full">
                    <div class="relative mb-6">
                        <div class="w-32 h-32 rounded-full border-2 border-zinc-800 p-1 shadow-2xl">
                            <img id="profile-img" src="" class="w-full h-full rounded-full object-cover bg-zinc-900" alt="Profile">
                        </div>
                        <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-zinc-800 px-3 py-1 rounded-full shadow-lg flex items-center gap-1 border border-zinc-700">
                            <i data-lucide="star" class="w-3 h-3 text-yellow-400 fill-yellow-400"></i>
                            <span class="text-[10px] font-bold text-white uppercase">Grátis</span>
                        </div>
                    </div>
                    <h2 id="profile-name" class="text-2xl font-medium text-white text-center mb-8">Usuário</h2>
                    <div class="w-full max-w-xs bg-zinc-900/50 rounded-xl p-4 border border-zinc-800 mb-8 cursor-pointer hover:bg-zinc-800 transition-colors" onclick="copyUid()">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-zinc-500 uppercase tracking-widest">User ID</span>
                            <i data-lucide="copy" class="w-3 h-3 text-zinc-500"></i>
                        </div>
                        <code id="profile-uid" class="text-xs text-zinc-400 font-mono break-all block">...</code>
                    </div>
                    <button id="btn-logout" class="w-full max-w-xs bg-red-500/10 text-red-500 p-4 rounded-xl border border-red-500/20 hover:bg-red-500/20 flex items-center justify-center gap-2 mt-4 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Sair da conta
                    </button>
                </div>
            </div>
        </section>

        <!-- SECTION: ADMIN PANEL -->
        <section id="tab-adm" class="tab-content hidden h-full overflow-y-auto no-scrollbar pt-24 pb-32 px-6">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl text-white font-['Syncopate'] uppercase tracking-widest">Painel Admin</h2>
                <span class="text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/20">ROOT</span>
            </div>

            <div id="adm-menu" class="grid grid-cols-1 gap-4">
                <button onclick="openAdmCinema()" class="bg-zinc-900/80 p-6 rounded-2xl border border-zinc-800 flex items-center gap-4 hover:bg-zinc-800 transition-colors group">
                    <div class="w-12 h-12 rounded-full bg-black flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="clapperboard" class="text-white w-6 h-6"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="text-white font-semibold">Programar Cinema</h3>
                        <p class="text-xs text-zinc-500">Gerenciar sessões e fila</p>
                    </div>
                </button>
            </div>

            <div id="adm-cinema-manager" class="hidden fade-in pb-20">
                <button onclick="closeAdmCinema()" class="mb-6 flex items-center text-xs text-zinc-500 hover:text-white">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Voltar
                </button>

                <!-- TABS: UNITÁRIO / EM MASSA -->
                <div class="flex gap-2 mb-6 bg-zinc-900 p-1 rounded-lg">
                    <button onclick="switchAdmTab('single')" id="tab-btn-single" class="flex-1 py-2 text-xs font-bold rounded-md bg-white text-black shadow transition-all">Unitário</button>
                    <button onclick="switchAdmTab('batch')" id="tab-btn-batch" class="flex-1 py-2 text-xs font-bold rounded-md text-zinc-500 hover:text-white transition-all">Em Massa</button>
                </div>

                <!-- ADD SINGLE -->
                <div id="adm-content-single" class="block">
                    <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 mb-8">
                        <h3 class="text-white font-medium mb-4 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> <span id="form-mode-text">Novo Agendamento</span>
                        </h3>
                        
                        <div class="relative mb-4">
                            <input type="text" id="tmdb-search" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Buscar no TMDB (ex: Matrix)..." onkeyup="debounceSearch(this.value)">
                            <div id="tmdb-results" class="absolute top-full left-0 w-full bg-black border border-zinc-800 rounded-lg mt-1 max-h-48 overflow-y-auto z-50 hidden"></div>
                        </div>

                        <div id="film-form" class="hidden space-y-3 border-t border-zinc-800 pt-4">
                            <input type="hidden" id="form-doc-id" value=""> <!-- ID oculto para edição -->
                            <div class="flex gap-3">
                                <img id="form-poster" src="" class="w-16 h-24 object-cover rounded bg-zinc-800">
                                <div class="flex-1">
                                    <input type="text" id="form-title" class="bg-transparent text-white font-bold w-full focus:outline-none mb-1" readonly>
                                    <textarea id="form-overview" class="bg-transparent text-zinc-500 text-xs w-full h-16 resize-none focus:outline-none" readonly></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 uppercase">Link MP4 (Direct URL)</label>
                                <input type="url" id="form-mp4" class="glass-input w-full p-2 rounded text-xs" placeholder="https://site.com/video.mp4">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-zinc-500 uppercase">Data</label>
                                    <input type="date" id="form-date" class="glass-input w-full p-2 rounded text-xs">
                                </div>
                                <div>
                                    <label class="text-[10px] text-zinc-500 uppercase">Hora</label>
                                    <input type="time" id="form-time" class="glass-input w-full p-2 rounded text-xs">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden flex-1 bg-zinc-800 text-white font-bold py-3 rounded-lg hover:bg-zinc-700">Cancelar</button>
                                <button onclick="scheduleFilm()" id="btn-save-film" class="flex-1 bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200">Agendar Sessão</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADD BATCH (MASS) -->
                <div id="adm-content-batch" class="hidden">
                    <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-medium flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4"></i> Maratona
                            </h3>
                            <div class="flex items-center gap-2">
                                <input type="number" id="batch-count" value="10" min="1" max="50" class="w-16 glass-input text-center p-1 rounded text-sm">
                                <button onclick="generateBatchSlots()" class="text-[10px] bg-white text-black px-2 py-1 rounded font-bold">Gerar</button>
                            </div>
                        </div>

                        <!-- Global Start Time for Batch -->
                        <div class="grid grid-cols-2 gap-2 mb-4 bg-zinc-800/50 p-2 rounded-lg">
                            <div>
                                <label class="text-[10px] text-zinc-500 uppercase">Data Início</label>
                                <input type="date" id="batch-start-date" class="glass-input w-full p-1 rounded text-xs">
                            </div>
                            <div>
                                <label class="text-[10px] text-zinc-500 uppercase">Hora Início</label>
                                <input type="time" id="batch-start-time" class="glass-input w-full p-1 rounded text-xs">
                            </div>
                        </div>

                        <div id="batch-slots-container" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                            <!-- JS generates slots here -->
                            <p class="text-center text-xs text-zinc-500 py-4">Clique em "Gerar" para criar slots.</p>
                        </div>

                        <button onclick="saveBatchSchedule()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 mt-4 shadow-lg">
                            Salvar Maratona
                        </button>
                    </div>
                </div>

                <h3 class="text-white font-medium mb-4 pl-1">Fila de Exibição</h3>
                <div id="schedule-list" class="space-y-3"></div>
            </div>
        </section>

    </main>

    <!-- NAVIGATION -->
    <nav class="fixed bottom-0 left-0 w-full z-50 nav-immersive" style="height: var(--nav-height);">
        <div class="max-w-md mx-auto flex justify-between items-center px-6 h-full pb-2">
            <button onclick="window.app.switchTab('inicio')" class="nav-btn active flex flex-col items-center gap-1 group w-10" id="nav-inicio">
                <i data-lucide="home" class="w-6 h-6 text-zinc-500 group-hover:text-zinc-300 transition-colors"></i>
                <span class="text-[9px] text-zinc-600 group-hover:text-zinc-400 uppercase">Início</span>
            </button>
            <button onclick="window.app.switchTab('busca')" class="nav-btn flex flex-col items-center gap-1 group w-10" id="nav-busca">
                <i data-lucide="search" class="w-6 h-6 text-zinc-500 group-hover:text-zinc-300 transition-colors"></i>
                <span class="text-[9px] text-zinc-600 group-hover:text-zinc-400 uppercase">Busca</span>
            </button>
            <button onclick="window.app.switchTab('cinema')" class="nav-btn flex flex-col items-center gap-1 group w-10" id="nav-cinema">
                <i data-lucide="film" class="w-6 h-6 text-zinc-500 group-hover:text-zinc-300 transition-colors"></i>
                <span class="text-[9px] text-zinc-600 group-hover:text-zinc-400 uppercase">Cinema</span>
            </button>
            <button onclick="window.app.switchTab('perfil')" class="nav-btn flex flex-col items-center gap-1 group w-10" id="nav-perfil">
                <i data-lucide="user" class="w-6 h-6 text-zinc-500 group-hover:text-zinc-300 transition-colors"></i>
                <span class="text-[9px] text-zinc-600 group-hover:text-zinc-400 uppercase">Perfil</span>
            </button>
            <button onclick="window.app.switchTab('adm')" class="nav-btn hidden flex-col items-center gap-1 group w-10 scale-in" id="nav-adm">
                <i data-lucide="shield-check" class="w-6 h-6 text-red-500/70 group-hover:text-red-500 transition-colors"></i>
                <span class="text-[9px] text-red-500/70 group-hover:text-red-500 uppercase">ADM</span>
            </button>
        </div>
    </nav>

    <!-- LOGIC MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp, where, limit, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        // --- CONFIG ---
        const TMDB_API_KEY = "d0f7e2c414b1efff7b000ae9b681ed1b"; 
        const APP_ID_PATH = "babygirl-ece17";

        const firebaseConfig = {
            apiKey: "AIzaSyBDaJleodtZHNAfRMh5ocznP85WO2qMB2A",
            authDomain: "babygirl-ece17.firebaseapp.com",
            projectId: "babygirl-ece17",
            storageBucket: "babygirl-ece17.firebasestorage.app",
            messagingSenderId: "437360012265",
            appId: "1:437360012265:web:2244a4684048ff1b18f978"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const TOXIC_WORDS = [
            "merda", "bosta", "caralho", "porra", "puta", "viado", "corno", "buceta", "arrombado", "fodase", "foda-se",
            "pau", "penis", "cu", "otario", "idiota", "imbecil", "lixo", "verme", "macaco", "preto", "viadinho"
        ];

        // --- STATE & UI REFS ---
        let currentUser = null;
        let userData = null;
        let searchTimeout = null;
        let currentFilmData = null;
        let activeFilmId = null;
        let syncInterval = null;
        let nextUpSchedule = [];
        let presenceInterval = null;
        let currentTab = 'inicio';
        let deleteIdTarget = null; // ID to be deleted

        const ui = {
            auth: {
                loading: document.getElementById('auth-loading'),
                formsContainer: document.getElementById('auth-forms'),
                profileContainer: document.getElementById('user-profile'),
                loginForm: document.getElementById('form-login'),
                registerForm: document.getElementById('form-register'),
            },
            profile: {
                img: document.getElementById('profile-img'),
                name: document.getElementById('profile-name'),
                uid: document.getElementById('profile-uid'),
            },
            inputs: {
                loginEmail: document.getElementById('login-email'),
                loginPass: document.getElementById('login-password'),
                regName: document.getElementById('reg-name'),
                regEmail: document.getElementById('reg-email'),
                regPass: document.getElementById('reg-password'),
                regFile: document.getElementById('reg-avatar')
            },
            admin: {
                modal: document.getElementById('admin-modal'),
                input: document.getElementById('admin-password'),
                navBtn: document.getElementById('nav-adm'),
                cinemaManager: document.getElementById('adm-cinema-manager'),
                menu: document.getElementById('adm-menu'),
                tmdbSearch: document.getElementById('tmdb-search'),
                tmdbResults: document.getElementById('tmdb-results'),
                form: document.getElementById('film-form'),
                formDocId: document.getElementById('form-doc-id'),
                formTitle: document.getElementById('form-title'),
                formOverview: document.getElementById('form-overview'),
                formPoster: document.getElementById('form-poster'),
                formMp4: document.getElementById('form-mp4'),
                formDate: document.getElementById('form-date'),
                formTime: document.getElementById('form-time'),
                scheduleList: document.getElementById('schedule-list'),
                modeText: document.getElementById('form-mode-text'),
                btnSave: document.getElementById('btn-save-film'),
                btnCancel: document.getElementById('btn-cancel-edit'),
                // Batch
                batchContainer: document.getElementById('batch-slots-container'),
                batchCount: document.getElementById('batch-count'),
                batchStartDate: document.getElementById('batch-start-date'),
                batchStartTime: document.getElementById('batch-start-time'),
            },
            cinema: {
                section: document.getElementById('tab-cinema'),
                player: document.getElementById('cinema-player'),
                posterOverlay: document.getElementById('cinema-poster-overlay'),
                posterImg: document.getElementById('cinema-poster-img'),
                title: document.getElementById('now-playing-title'),
                soundOverlay: document.getElementById('sound-overlay'),
                chatContainer: document.getElementById('chat-messages'),
                chatInput: document.getElementById('chat-input'),
                modal: document.getElementById('movie-info-modal'),
                modalTitle: document.getElementById('modal-movie-title'),
                modalPoster: document.getElementById('modal-movie-poster'),
                modalOverview: document.getElementById('modal-movie-overview'),
                viewerCount: document.getElementById('viewer-count'),
                nextUpBtn: document.getElementById('btn-next-up'),
                nextUpList: document.getElementById('next-up-list'),
                nextUpIcon: document.getElementById('icon-next-up'),
                banScreen: document.getElementById('ban-screen'),
                banTimer: document.getElementById('ban-timer')
            },
            deleteModal: {
                el: document.getElementById('delete-preview-modal'),
                img: document.getElementById('del-preview-img'),
                title: document.getElementById('del-preview-title'),
                btnConfirm: document.getElementById('btn-confirm-delete')
            }
        };

        window.app = {};

        window.app.switchTab = async (tabName) => {
            currentTab = tabName;
            if (tabName === 'cinema') {
                if (currentUser) await checkBanStatus();
                updatePresence(true);
            } else {
                updatePresence(false);
            }

            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('fade-in');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('admin-active');
            });

            const target = document.getElementById(`tab-${tabName}`);
            if(target) {
                target.classList.remove('hidden');
                if(tabName !== 'cinema') setTimeout(() => target.classList.add('fade-in'), 10);
                else target.classList.add('fade-in'); 
            }

            const navBtn = document.getElementById(`nav-${tabName}`);
            if(navBtn) {
                if (tabName === 'adm') navBtn.classList.add('admin-active');
                else navBtn.classList.add('active');
            }
            if(tabName === 'cinema') scrollToBottom();
        };

        window.togglePassword = (id) => {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        };
        window.toggleAuthMode = (mode) => {
            if (mode === 'register') {
                ui.auth.loginForm.classList.add('hidden');
                ui.auth.registerForm.classList.remove('hidden');
            } else {
                ui.auth.registerForm.classList.add('hidden');
                ui.auth.loginForm.classList.remove('hidden');
            }
        };
        window.copyUid = () => {
            navigator.clipboard.writeText(ui.profile.uid.innerText).then(() => showToast("UID copiado!"));
        };

        // Admin Access
        let logoTapCount = 0;
        let logoTapTimer;
        window.handleLogoClick = () => {
            clearTimeout(logoTapTimer);
            logoTapCount++;
            if (navigator.vibrate) navigator.vibrate(50);
            if (logoTapCount === 1) {
                logoTapTimer = setTimeout(() => { window.app.switchTab('inicio'); logoTapCount = 0; }, 400);
            } else if (logoTapCount >= 5) {
                logoTapCount = 0;
                ui.admin.modal.classList.remove('hidden');
                ui.admin.input.value = '';
                ui.admin.input.focus();
            } else {
                logoTapTimer = setTimeout(() => { logoTapCount = 0; }, 400);
            }
        };
        window.closeAdminModal = () => ui.admin.modal.classList.add('hidden');
        window.checkAdminAccess = () => {
            if (ui.admin.input.value === 'leoleo') {
                showToast("Admin Habilitado");
                ui.admin.modal.classList.add('hidden');
                ui.admin.navBtn.classList.remove('hidden');
                ui.admin.navBtn.classList.add('flex');
            } else {
                showToast("Senha Incorreta");
                ui.admin.input.value = '';
            }
        };

        window.openAdmCinema = () => {
            ui.admin.menu.classList.add('hidden');
            ui.admin.cinemaManager.classList.remove('hidden');
        };
        window.closeAdmCinema = () => {
            ui.admin.cinemaManager.classList.add('hidden');
            ui.admin.menu.classList.remove('hidden');
        };

        // Admin Tabs (Single vs Batch)
        window.switchAdmTab = (mode) => {
            const sBtn = document.getElementById('tab-btn-single');
            const bBtn = document.getElementById('tab-btn-batch');
            const sContent = document.getElementById('adm-content-single');
            const bContent = document.getElementById('adm-content-batch');

            if (mode === 'single') {
                sBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white text-black shadow transition-all";
                bBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-zinc-500 hover:text-white transition-all";
                sContent.classList.remove('hidden');
                bContent.classList.add('hidden');
            } else {
                bBtn.className = "flex-1 py-2 text-xs font-bold rounded-md bg-white text-black shadow transition-all";
                sBtn.className = "flex-1 py-2 text-xs font-bold rounded-md text-zinc-500 hover:text-white transition-all";
                bContent.classList.remove('hidden');
                sContent.classList.add('hidden');
                
                // Initialize batch defaults
                if(!ui.admin.batchStartDate.value) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 10);
                    ui.admin.batchStartDate.valueAsDate = now;
                    ui.admin.batchStartTime.value = now.toTimeString().substring(0,5);
                }
            }
        };

        // --- TMDB (Fast Search) ---
        window.debounceSearch = (val) => {
            clearTimeout(searchTimeout);
            if(val.length < 3) {
                ui.admin.tmdbResults.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => searchTMDB(val), 300); // 300ms debounce
        };

        async function searchTMDB(queryStr) {
            try {
                const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(queryStr)}&language=pt-BR`);
                const data = await res.json();
                renderTMDBResults(data.results || []);
            } catch (e) { console.error(e); }
        }

        function renderTMDBResults(movies) {
            const container = ui.admin.tmdbResults;
            container.innerHTML = '';
            if(movies.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            movies.slice(0, 5).forEach(movie => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 hover:bg-zinc-900 cursor-pointer border-b border-zinc-900";
                div.innerHTML = `
                    <img src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w92' + movie.poster_path : 'https://placehold.co/40x60'}" class="w-10 h-14 object-cover rounded">
                    <div>
                        <p class="text-sm text-white font-semibold line-clamp-1">${movie.title}</p>
                        <p class="text-xs text-zinc-500">${movie.release_date?.split('-')[0] || 'N/A'}</p>
                    </div>
                `;
                div.onclick = () => selectFilm(movie);
                container.appendChild(div);
            });
        }

        function selectFilm(movie) {
            currentFilmData = movie;
            ui.admin.tmdbResults.classList.add('hidden');
            ui.admin.tmdbSearch.value = '';
            ui.admin.form.classList.remove('hidden');
            ui.admin.formTitle.value = movie.title;
            ui.admin.formOverview.value = movie.overview;
            ui.admin.formPoster.src = movie.poster_path ? 'https://image.tmdb.org/t/p/w154' + movie.poster_path : 'https://placehold.co/100x150';
            
            // Set default time if new, keep existing if edit
            if (!ui.admin.formDocId.value) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 10);
                ui.admin.formDate.valueAsDate = now;
                ui.admin.formTime.value = now.toTimeString().substring(0,5);
            }
        }

        // --- SINGLE SCHEDULING (ADD & EDIT) ---
        window.scheduleFilm = async () => {
            const mp4 = ui.admin.formMp4.value;
            const dateVal = ui.admin.formDate.value;
            const timeVal = ui.admin.formTime.value;
            const docId = ui.admin.formDocId.value; // ID if editing
            const title = ui.admin.formTitle.value;

            if(!mp4 || !dateVal || !timeVal || !title) { showToast("Preencha todos os campos"); return; }
            
            const timestamp = new Date(`${dateVal}T${timeVal}`).getTime();

            // Data Payload
            const payload = {
                mp4Url: mp4,
                startTime: timestamp,
                updatedAt: serverTimestamp()
            };

            // If we have currentFilmData (from TMDB Search), use it. 
            // If editing and didn't change film, we keep existing (logic handled by not overwriting unless new selected)
            if (currentFilmData) {
                payload.tmdbId = currentFilmData.id;
                payload.title = currentFilmData.title;
                payload.overview = currentFilmData.overview;
                payload.poster = currentFilmData.poster_path ? 'https://image.tmdb.org/t/p/w500' + currentFilmData.poster_path : '';
            }

            try {
                if (docId) {
                    await updateDoc(doc(db, "artifacts", APP_ID_PATH, "schedule", docId), payload);
                    showToast("Filme atualizado!");
                } else {
                    if (!currentFilmData) { showToast("Selecione um filme!"); return; }
                    payload.createdAt = serverTimestamp();
                    await addDoc(collection(db, "artifacts", APP_ID_PATH, "schedule"), payload);
                    showToast("Agendado com sucesso!");
                }
                resetForm();
            } catch (e) { showToast("Erro ao salvar."); console.error(e); }
        };

        function resetForm() {
            ui.admin.form.classList.add('hidden');
            ui.admin.formMp4.value = '';
            ui.admin.formDocId.value = '';
            ui.admin.modeText.innerText = "Novo Agendamento";
            ui.admin.btnSave.innerText = "Agendar Sessão";
            ui.admin.btnCancel.classList.add('hidden');
            currentFilmData = null;
        }

        window.cancelEdit = () => resetForm();

        window.startEdit = (id, title, poster, overview, mp4, startTime) => {
            window.switchAdmTab('single');
            ui.admin.form.classList.remove('hidden');
            ui.admin.modeText.innerText = "Editando Filme";
            ui.admin.btnSave.innerText = "Atualizar";
            ui.admin.btnCancel.classList.remove('hidden');

            ui.admin.formDocId.value = id;
            ui.admin.formTitle.value = title;
            ui.admin.formPoster.src = poster;
            ui.admin.formOverview.value = overview;
            ui.admin.formMp4.value = mp4;

            const date = new Date(startTime);
            ui.admin.formDate.valueAsDate = date;
            ui.admin.formTime.value = date.toTimeString().substring(0,5);

            // Mock currentFilmData so we can save without re-searching if user just changes time/link
            // But if they search new, currentFilmData gets overwritten
        };

        // --- DELETE WITH PREVIEW ---
        window.askDelete = (id, title, poster) => {
            deleteIdTarget = id;
            ui.deleteModal.img.src = poster;
            ui.deleteModal.title.innerText = title;
            ui.deleteModal.el.classList.remove('hidden');
        };

        ui.deleteModal.btnConfirm.addEventListener('click', async () => {
            if(deleteIdTarget) {
                await deleteDoc(doc(db, "artifacts", APP_ID_PATH, "schedule", deleteIdTarget));
                ui.deleteModal.el.classList.add('hidden');
                showToast("Filme removido.");
            }
        });

        // --- BATCH SCHEDULING ---
        let batchSlotsData = []; // Store metadata for slots

        window.generateBatchSlots = () => {
            const count = parseInt(ui.admin.batchCount.value) || 10;
            const container = ui.admin.batchContainer;
            container.innerHTML = '';
            batchSlotsData = new Array(count).fill(null);

            for(let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = "batch-slot flex gap-2 items-center bg-zinc-900/40 p-2 rounded border border-zinc-800";
                div.innerHTML = `
                    <span class="text-xs font-bold text-zinc-500 w-6">${i+1}</span>
                    <input type="text" class="glass-input text-xs w-1/3 p-2 rounded" placeholder="Link MP4" id="batch-mp4-${i}">
                    <div class="relative flex-1">
                        <input type="text" class="glass-input text-xs w-full p-2 rounded" placeholder="Pesquisar filme..." onkeyup="searchBatch(this.value, ${i})">
                        <div id="batch-res-${i}" class="absolute top-full left-0 w-full bg-black border border-zinc-700 z-50 hidden max-h-32 overflow-y-auto"></div>
                    </div>
                    <div id="batch-sel-${i}" class="hidden w-8 h-10 bg-zinc-800 rounded overflow-hidden flex-shrink-0">
                        <img class="w-full h-full object-cover">
                    </div>
                `;
                container.appendChild(div);
            }
        };

        window.searchBatch = (val, idx) => {
            const resBox = document.getElementById(`batch-res-${idx}`);
            if(val.length < 3) { resBox.classList.add('hidden'); return; }
            
            // Fast debounce local for batch
            setTimeout(async () => {
                try {
                    const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(val)}&language=pt-BR`);
                    const data = await res.json();
                    const movies = data.results || [];
                    
                    resBox.innerHTML = '';
                    if(movies.length > 0) resBox.classList.remove('hidden');
                    else resBox.classList.add('hidden');

                    movies.slice(0,3).forEach(m => {
                        const d = document.createElement('div');
                        d.className = "p-2 hover:bg-zinc-800 text-[10px] cursor-pointer text-white truncate";
                        d.innerText = m.title;
                        d.onclick = () => {
                            batchSlotsData[idx] = m;
                            // Update UI
                            const selBox = document.getElementById(`batch-sel-${idx}`);
                            selBox.classList.remove('hidden');
                            selBox.querySelector('img').src = m.poster_path ? 'https://image.tmdb.org/t/p/w92' + m.poster_path : '';
                            resBox.classList.add('hidden');
                        };
                        resBox.appendChild(d);
                    });
                } catch(e){}
            }, 300);
        };

        window.saveBatchSchedule = async () => {
            const startDateStr = ui.admin.batchStartDate.value;
            const startTimeStr = ui.admin.batchStartTime.value;
            
            if(!startDateStr || !startTimeStr) { showToast("Defina Data/Hora de Início da Maratona"); return; }

            let startTime = new Date(`${startDateStr}T${startTimeStr}`).getTime();
            let addedCount = 0;

            for(let i=0; i < batchSlotsData.length; i++) {
                const movie = batchSlotsData[i];
                const mp4 = document.getElementById(`batch-mp4-${i}`).value;

                if(movie && mp4) {
                    await addDoc(collection(db, "artifacts", APP_ID_PATH, "schedule"), {
                        tmdbId: movie.id,
                        title: movie.title,
                        overview: movie.overview,
                        poster: movie.poster_path ? 'https://image.tmdb.org/t/p/w500' + movie.poster_path : '',
                        mp4Url: mp4,
                        startTime: startTime,
                        createdAt: serverTimestamp()
                    });
                    
                    // Increment 2 hours for next slot
                    startTime += (2 * 60 * 60 * 1000);
                    addedCount++;
                }
            }

            if(addedCount > 0) {
                showToast(`${addedCount} filmes agendados!`);
                window.switchAdmTab('single'); // Go back to list
            } else {
                showToast("Preencha pelo menos um slot completo.");
            }
        };

        // --- PRESENCE & BAN ---
        async function updatePresence(isActive) {
            if (!currentUser) return;
            const presenceRef = doc(db, 'artifacts', APP_ID_PATH, 'presence', currentUser.uid);
            if (isActive) {
                await setDoc(presenceRef, { uid: currentUser.uid, timestamp: serverTimestamp(), active: true });
                if (presenceInterval) clearInterval(presenceInterval);
                presenceInterval = setInterval(async () => {
                    if (currentTab === 'cinema') await updateDoc(presenceRef, { timestamp: serverTimestamp() });
                }, 60000);
            } else {
                if (presenceInterval) clearInterval(presenceInterval);
                try { await deleteDoc(presenceRef); } catch(e){}
            }
        }
        function initPresenceListener() {
            onSnapshot(collection(db, 'artifacts', APP_ID_PATH, 'presence'), (snap) => {
                let count = 0;
                const now = Date.now();
                snap.forEach(doc => { if(now - (doc.data().timestamp?.toMillis() || 0) < 120000) count++; });
                ui.cinema.viewerCount.innerText = count;
            });
        }
        
        async function checkToxic(text) {
            const lower = text.toLowerCase();
            return TOXIC_WORDS.some(w => lower.includes(w));
        }

        async function punishUser() {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', currentUser.uid);
            let strikes = (userData?.strikes || 0) + 1;
            let mutedUntil = null;
            let bannedUntil = null;

            if (strikes >= 10) {
                bannedUntil = Date.now() + (60 * 60 * 1000);
                showToast("BANIDO: Múltiplas ofensas. 1h fora.", true);
            } else {
                mutedUntil = Date.now() + (5 * 60 * 1000);
                showToast(`AutoMod: Mutado por 5 min. Strike ${strikes}/10`, true);
            }
            await setDoc(userRef, { strikes, mutedUntil, bannedUntil, lastOffense: serverTimestamp() }, { merge: true });
            fetchUserData();
            checkBanStatus();
        }

        async function fetchUserData() {
            if (!currentUser) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', currentUser.uid));
            userData = snap.exists() ? snap.data() : { strikes: 0 };
        }

        async function checkBanStatus() {
            if (!userData?.bannedUntil) { ui.cinema.banScreen.classList.add('hidden'); return; }
            const now = Date.now();
            if (now < userData.bannedUntil) {
                ui.cinema.banScreen.classList.remove('hidden');
                ui.cinema.player.pause();
                const interval = setInterval(() => {
                    const rem = userData.bannedUntil - Date.now();
                    if (rem <= 0) { clearInterval(interval); ui.cinema.banScreen.classList.add('hidden'); fetchUserData(); } 
                    else ui.cinema.banTimer.innerText = new Date(rem).toISOString().substr(11, 8);
                }, 1000);
            } else ui.cinema.banScreen.classList.add('hidden');
        }

        // --- CINEMA LOGIC ---
        function initCinemaSync() {
            const q = query(collection(db, "artifacts", APP_ID_PATH, "schedule"), orderBy("startTime", "asc"));
            onSnapshot(q, (snapshot) => {
                const schedule = [];
                const listContainer = ui.admin.scheduleList;
                listContainer.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    schedule.push({ id: doc.id, ...data });
                    
                    const date = new Date(data.startTime);
                    // Updated List Item with Edit/Delete Buttons
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 bg-zinc-900 p-2 rounded-lg border border-zinc-800 hover:border-zinc-700 transition-colors group";
                    div.innerHTML = `
                        <img src="${data.poster}" class="w-10 h-14 object-cover rounded">
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-xs font-bold truncate">${data.title}</p>
                            <p class="text-[10px] text-zinc-500">${date.toLocaleString()}</p>
                        </div>
                        <div class="flex gap-1">
                            <button class="text-zinc-500 hover:text-white p-2" onclick="startEdit('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${data.poster}', '${data.overview.replace(/\n/g, ' ').replace(/'/g, "\\'")}', '${data.mp4Url}', ${data.startTime})">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="askDelete('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${data.poster}')" class="text-zinc-500 hover:text-red-500 p-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
                lucide.createIcons();
                updatePlayback(schedule);
                if(syncInterval) clearInterval(syncInterval);
                syncInterval = setInterval(() => updatePlayback(schedule), 1000);
            });
        }

        function updatePlayback(schedule) {
            const now = Date.now();
            let activeFilm = null;
            nextUpSchedule = [];

            schedule.forEach(film => {
                if (film.startTime > now) nextUpSchedule.push(film);
                else if (now - film.startTime <= (3 * 60 * 60 * 1000)) activeFilm = film;
            });

            updateNextUpUI();

            if (activeFilm) {
                if (userData?.bannedUntil && now < userData.bannedUntil) return;
                const offsetSeconds = (now - activeFilm.startTime) / 1000;
                
                if (activeFilm.id !== activeFilmId) {
                    activeFilmId = activeFilm.id;
                    loadFilm(activeFilm, offsetSeconds);
                } else {
                    const player = ui.cinema.player;
                    if (Math.abs(player.currentTime - offsetSeconds) > 3) player.currentTime = offsetSeconds;
                    if (player.paused && !player.ended) player.play().catch(e => ui.cinema.soundOverlay.classList.remove('hidden'));
                }
            } else stopCinema();
        }

        function updateNextUpUI() {
            if (nextUpSchedule.length > 0) {
                ui.cinema.nextUpBtn.classList.remove('hidden');
                ui.cinema.nextUpBtn.classList.add('flex');
                ui.cinema.nextUpList.innerHTML = '';
                nextUpSchedule.slice(0, 5).forEach(film => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-2 py-1.5 border-b border-zinc-800 last:border-0";
                    div.innerHTML = `
                        <img src="${film.poster}" class="w-6 h-8 object-cover rounded">
                        <div class="min-w-0">
                            <p class="text-[10px] text-white truncate font-bold">${film.title}</p>
                            <p class="text-[9px] text-zinc-500">${new Date(film.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    `;
                    ui.cinema.nextUpList.appendChild(div);
                });
            } else {
                ui.cinema.nextUpBtn.classList.add('hidden');
                ui.cinema.nextUpBtn.classList.remove('flex');
                ui.cinema.nextUpList.classList.add('hidden');
            }
        }

        window.toggleNextUp = () => {
            const list = ui.cinema.nextUpList;
            const icon = ui.cinema.nextUpIcon;
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                list.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        function loadFilm(film, startTime) {
            const player = ui.cinema.player;
            ui.cinema.title.innerText = film.title;
            ui.cinema.posterOverlay.classList.add('hidden');
            player.src = film.mp4Url;
            player.currentTime = startTime;
            player.volume = 0;
            player.muted = true; 
            player.play().then(() => ui.cinema.soundOverlay.classList.remove('hidden')).catch(e => ui.cinema.soundOverlay.classList.remove('hidden'));
            ui.cinema.modalTitle.innerText = film.title;
            ui.cinema.modalPoster.src = film.poster;
            ui.cinema.modalOverview.innerText = film.overview;
        }

        function stopCinema() {
            activeFilmId = null;
            ui.cinema.player.pause();
            ui.cinema.player.src = "";
            ui.cinema.title.innerText = "Aguardando Sessão...";
            ui.cinema.posterOverlay.classList.remove('hidden');
            ui.cinema.soundOverlay.classList.add('hidden');
        }

        window.toggleMute = () => {
            const player = ui.cinema.player;
            player.muted = !player.muted;
            if(!player.muted) { player.volume = 1; ui.cinema.soundOverlay.classList.add('hidden'); } 
            else ui.cinema.soundOverlay.classList.remove('hidden');
        };

        window.openMovieInfo = () => { if(activeFilmId) ui.cinema.modal.classList.remove('hidden'); };
        window.closeMovieInfo = () => ui.cinema.modal.classList.add('hidden');

        // Chat
        function initChat() {
            const q = query(collection(db, "artifacts", APP_ID_PATH, "chat"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const chatContainer = ui.cinema.chatContainer;
                chatContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.timestamp > Date.now() - (24*60*60*1000)) renderMessage(data);
                });
                scrollToBottom();
            });
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const isMe = currentUser && msg.uid === currentUser.uid;
            div.className = `flex gap-2 mb-3 items-end ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-zinc-800 border border-zinc-700 shadow-md">
                    <img src="${msg.avatar}" class="w-full h-full object-cover">
                </div>
                <div class="chat-bubble ${isMe ? 'bg-white/10 text-white border-white/20' : 'text-zinc-200'}">
                    <p class="text-[9px] font-bold ${isMe ? 'text-right' : ''} text-white/50 mb-0.5 tracking-wide uppercase">${msg.name}</p>
                    <p class="text-xs leading-relaxed font-light">${msg.text}</p>
                </div>
            `;
            ui.cinema.chatContainer.appendChild(div);
        }

        window.sendMessage = async () => {
            if (!currentUser) { showToast("Faça login para participar."); return; }
            if (userData?.mutedUntil && Date.now() < userData.mutedUntil) {
                showToast(`Mutado por mais ${Math.ceil((userData.mutedUntil - Date.now())/60000)} min.`, true); return;
            }
            const input = ui.cinema.chatInput;
            const text = input.value.trim();
            if (!text) return;
            if (await checkToxic(text)) { input.value = ''; await punishUser(); return; }
            input.value = '';
            try { await addDoc(collection(db, "artifacts", APP_ID_PATH, "chat"), {
                text, uid: currentUser.uid, name: currentUser.displayName, avatar: currentUser.photoURL, timestamp: Date.now()
            }); } catch (e) { showToast("Erro ao enviar mensagem."); }
        };
        
        ui.cinema.chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        function scrollToBottom() {
            const scrollArea = document.querySelector('.chat-messages-scroll');
            if(scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
        }

        function showToast(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.innerText = msg;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
            });
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch("https://api.imgbb.com/1/upload?key=7ce206cded5b366ff1c2d1292e55b1c4", { method: "POST", body: formData });
                const data = await response.json();
                return data.success ? data.data.url : "https://i.ibb.co/5k03gX0/default-avatar.png";
            } catch (error) { return "https://i.ibb.co/5k03gX0/default-avatar.png"; }
        }

        onAuthStateChanged(auth, (user) => {
            ui.auth.loading.classList.add('hidden');
            currentUser = user;
            if (user) {
                ui.auth.formsContainer.classList.add('hidden');
                ui.auth.profileContainer.classList.remove('hidden');
                ui.auth.profileContainer.classList.add('flex');
                ui.profile.name.innerText = user.displayName || "Usuário";
                ui.profile.img.src = user.photoURL || "https://ui-avatars.com/api/?background=random&color=fff&name=User";
                ui.profile.uid.innerText = user.uid;
                ui.cinema.chatInput.placeholder = "Digite sua mensagem...";
                ui.cinema.chatInput.disabled = false;
                fetchUserData(); checkBanStatus();
            } else {
                ui.auth.profileContainer.classList.add('hidden');
                ui.auth.formsContainer.classList.remove('hidden');
                ui.auth.formsContainer.classList.add('flex');
                window.toggleAuthMode('login');
                ui.cinema.chatInput.placeholder = "Faça login para comentar";
                ui.cinema.chatInput.disabled = true;
                userData = null;
            }
        });

        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = ui.inputs.loginEmail.value, pass = ui.inputs.loginPass.value;
            if(!email || !pass) return showToast("Preencha tudo");
            try { await signInWithEmailAndPassword(auth, email, pass); showToast("Bem-vindo!"); } 
            catch { showToast("Erro no login"); }
        });

        document.getElementById('btn-register').addEventListener('click', async () => {
            const name = ui.inputs.regName.value, email = ui.inputs.regEmail.value, pass = ui.inputs.regPass.value, file = ui.inputs.regFile.files[0];
            if(!name || !email || !pass) return showToast("Preencha tudo");
            try {
                showToast("Criando conta...");
                let photo = "https://ui-avatars.com/api/?background=random&color=fff&name="+name;
                if(file) photo = await uploadToImgBB(file);
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(cred.user, { displayName: name, photoURL: photo });
                showToast("Conta criada!");
            } catch { showToast("Erro no cadastro"); }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        lucide.createIcons();
        initCinemaSync();
        initChat();
        initPresenceListener();
    </script>
</body>
</html>
